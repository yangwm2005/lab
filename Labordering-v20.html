<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Budget Management System - Updated</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--primary);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .btn-primary {
            background-color: var(--secondary);
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .status-ordered {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .status-received {
            background-color: #d1f7c4;
            color: #27ae60;
        }
        
        .status-pending {
            background-color: #ffcfd2;
            color: #c0392b;
        }
        
        .status-paid {
            background-color: #c7ecee;
            color: #16a085;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .table th {
            background-color: var(--primary);
            color: white;
        }
        
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .sync-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        .sync-online {
            background-color: #d1f7c4;
            color: #27ae60;
        }
        
        .sync-offline {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary);
            color: white;
            border: none;
        }
        
        .nav-tabs .nav-link {
            color: var(--dark);
        }
        
        .company-report {
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .pagination {
            justify-content: center;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .advanced-filters {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sortable-header {
            cursor: pointer;
        }
        
        .sortable-header:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* New styles for selective import */
        .import-preview-table {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .import-item-row {
            transition: background-color 0.2s;
        }
        
        .import-item-row:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .import-checkbox {
            margin-right: 10px;
        }
        
        .import-summary {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .balance-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .balance-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .status-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        .status-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .status-option:hover {
            background-color: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .stats-number {
                font-size: 1.8rem;
            }
        }

        .debug-panel {
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

.stats-subtitle {
    font-size: 0.9rem;
    margin-top: 5px;
    color: #6c757d;
}

.stats-subtitle .balance-positive {
    color: #28a745;
    font-weight: bold;
}

.stats-subtitle .balance-negative {
    color: #dc3545;
    font-weight: bold;
}

/* Clean view styles */
#cleanViewTable {
    font-size: 0.9rem;
}

#cleanViewTable th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 600;
}

#cleanViewTable td, #cleanViewTable th {
    padding: 0.5rem;
}

@media print {
    .modal-header, .modal-footer {
        display: none !important;
    }
    
    .modal-body {
        padding: 0;
    }
    
    #cleanViewTable {
        font-size: 12px;
        width: 100%;
    }
}

/* Login modal styles */
#loginModal .modal-content {
    border-radius: 15px;
    overflow: hidden;
}

#loginModal .modal-header {
    background-color: var(--primary);
    color: white;
}

.login-logo {
    font-size: 3rem;
    color: var(--secondary);
    margin-bottom: 1rem;
}

.password-toggle {
    cursor: pointer;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lab Budget System Login</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="login-logo">
                        <i class="fas fa-flask"></i>
                    </div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="passwordInput" class="form-label">Password</label>
                            <div class="position-relative">
                                <input type="password" class="form-control" id="passwordInput" placeholder="Enter password" required>
                                <span class="password-toggle" id="passwordToggle">
                                    <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Login</button>
                        </div>
                    </form>
                    <div class="mt-3 text-center">
                        <small class="text-muted">Please contact Dr. Yang for the starting <code>password</code>!</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Change Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="container mt-4 debug-panel" id="debugPanel">
        <h5>Debug Information</h5>
        <div id="debugInfo"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-flask"></i> Dr. Yang Lab Budget Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                            <i class="fas fa-plus-circle"></i> New Order
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="reports"><i class="fas fa-chart-bar"></i> Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#importExportModal">
                            <i class="fas fa-file-import"></i> Import/Export
                        </a>
                    </li>
                </ul>
                <div class="sync-status ms-2" id="syncStatus">
                    <i class="fas fa-cloud"></i> <span id="syncStatusText">Online</span>
                </div>
                <div class="dropdown ms-2">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> Admin
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-outline-warning ms-2" id="debugToggle">
                    <i class="fas fa-bug"></i> Debug
                </button>
            </div>
        </div>
    </nav>

    <!-- Rest of your HTML content remains the same -->
    <div class="container mt-4">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <h5>Total Orders</h5>
                        <div class="stats-number" id="totalOrders">0</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <h5>Pending Orders</h5>
                        <div class="stats-number" id="pendingOrders">0</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <h5>Total Spent</h5>
                        <div class="stats-number" id="totalSpent">$0</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stats-card">
                        <h5>Budget Balance</h5>
                        <div class="stats-number" id="budgetBalance">$0</div>
                    </div>
                </div>
                <!-- Add this after the existing stats cards -->
<div class="col-md-3 mb-3">
    <div class="card stats-card">
        <h5>Filtered Spending</h5>
        <div class="stats-number" id="filteredSpending">$0</div>
        <div class="stats-subtitle">Balance: <span id="filteredBalance">$0</span></div>
    </div>
</div>
            </div>

            <!-- Filter and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8 mb-2">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search orders...">
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-secondary w-100" id="advancedFilterToggle">
                                <i class="fas fa-filter"></i> Advanced Filters
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="advanced-filters" id="advancedFilters" style="display: none;">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="ordered">Ordered</option>
                                    <option value="received">Received</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Grant</label>
                                <select class="form-select" id="grantFilter">
                                    <option value="">All Grants</option>
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Company</label>
                                <select class="form-select" id="companyFilter">
                                    <option value="">All Companies</option>
                                    <!-- Will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Date Range</label>
                                <select class="form-select" id="dateFilter">
                                    <option value="">All Time</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">Last Year</option>
                                </select>
                            </div>
                        </div>
                        <!-- NEW: Add the exclude filter -->
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Exclude (comma-separated words)</label>
                                <input type="text" class="form-control" id="excludeFilter" 
                                       placeholder="word1, word2, ...">
                                <div class="form-text">Orders containing these words will be excluded</div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12 text-end">
                                <button class="btn btn-sm btn-outline-danger" id="clearFilters">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compactViewToggle">
                            <label class="form-check-label" for="compactViewToggle">Compact View</label>
                        </div>
                        <div>
                            <span class="text-muted" id="filterStats">Showing all records</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">Order Records</h5>
                        <div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-secondary" id="syncBtn">
                                    <i class="fas fa-sync-alt"></i> Sync Now
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="exportTableBtn">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-sm btn-outline-info" id="addSampleData">
                                    <i class="fas fa-plus"></i> Add Sample Data
                                </button>
                                <!-- Add this button to your action buttons section -->
								<button class="btn btn-sm btn-outline-success" id="cleanViewBtn">
 								    <i class="fas fa-window"></i> Clean View
								</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover" id="ordersTable">
                                <thead>
                                    <tr>
                                        <th class="sortable-header" data-sort="company">Company <i class="fas fa-sort"></i></th>
                                        <th class="sortable-header" data-sort="product">Product <i class="fas fa-sort"></i></th>
                                        <th class="sortable-header" data-sort="receivedDate">Received Date <i class="fas fa-sort"></i></th>
                                        <th class="sortable-header" data-sort="totalPrice">Total Price <i class="fas fa-sort"></i></th>
                                        <th class="sortable-header" data-sort="balance">Running Balance <i class="fas fa-sort"></i></th>
                                        <th class="sortable-header" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated dynamically -->
                                    <tr id="noOrdersRow">
                                        <td colspan="7" class="text-center py-4">No orders found. <a href="#" data-bs-toggle="modal" data-bs-target="#addOrderModal">Add your first order</a> or <a href="#" id="addSampleDataLink">add sample data</a></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Orders pagination" class="mt-3">
                        <ul class="pagination" id="ordersPagination">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="prevPage">Previous</a>
                            </li>
                            <li class="page-item active">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#" id="nextPage">Next</a>
                            </li>
                        </ul>
                    </nav>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted" id="paginationInfo">Showing 0 of 0 records</span>
                        </div>
                        <div class="form-inline">
                            <label class="mr-2" for="itemsPerPage">Items per page:</label>
                            <select class="form-select form-select-sm" id="itemsPerPage" style="width: 80px;">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Company Reports</h5>
                    <p>Analyze spending and orders by company</p>
                    
                    <ul class="nav nav-tabs" id="reportTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Summary</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">Charts</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="reportTabsContent">
                        <div class="tab-pane fade show active" id="summary" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="reportCompanyFilter">
                                        <option value="">All Companies</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-primary" id="generateReport">
                                        <i class="fas fa-chart-pie"></i> Generate Report
                                    </button>
                                </div>
                            </div>
                            
                            <div id="companyReports">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="charts" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Spending by Company</h5>
                                            <canvas id="companySpendingChart" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Orders by Status</h5>
                                            <canvas id="statusChart" height="300"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="companyName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="amount" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Unit Price</label>
                                <input type="number" step="0.01" class="form-control" id="unitPrice" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Total Price</label>
                                <input type="number" step="0.01" class="form-control" id="totalPrice" readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ordered By</label>
                                <input type="text" class="form-control" id="orderedBy" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Received By</label>
                                <input type="text" class="form-control" id="receivedBy">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Received Date</label>
                                <input type="date" class="form-control" id="receivedDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Paperwork Date</label>
                                <input type="date" class="form-control" id="paperworkDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Process Status</label>
                                <select class="form-select" id="processStatus">
                                    <option value="ordered">Ordered</option>
                                    <option value="received">Received</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Paid By Grant</label>
                                <input type="text" class="form-control" id="paidByGrant">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveOrder">Save Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="editCompanyName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="editProductName" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="editAmount" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Unit Price</label>
                                <input type="number" step="0.01" class="form-control" id="editUnitPrice" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Total Price</label>
                                <input type="number" step="0.01" class="form-control" id="editTotalPrice" readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ordered By</label>
                                <input type="text" class="form-control" id="editOrderedBy" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Received By</label>
                                <input type="text" class="form-control" id="editReceivedBy">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Received Date</label>
                                <input type="date" class="form-control" id="editReceivedDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Paperwork Date</label>
                                <input type="date" class="form-control" id="editPaperworkDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Process Status</label>
                                <select class="form-select" id="editProcessStatus">
                                    <option value="ordered">Ordered</option>
                                    <option value="received">Received</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Paid By Grant</label>
                                <input type="text" class="form-control" id="editPaidByGrant">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="editNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateOrder">Update Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal fade" id="importExportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import/Export Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="importExportTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab">Export</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab">Full Import</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="selective-import-tab" data-bs-toggle="tab" data-bs-target="#selective-import" type="button" role="tab">Selective Import</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab">Sync</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="importExportTabsContent">
                        <!-- Export Tab -->
                        <div class="tab-pane fade show active" id="export" role="tabpanel">
                            <div class="mb-4">
                                <h6>Export Data</h6>
                                <p>Download your data as a JSON file for backup or transfer.</p>
                                <button class="btn btn-success" id="exportData">
                                    <i class="fas fa-download"></i> Export to File
                                </button>
                            </div>
                            
                            <div>
                                <h6>Export Table to CSV</h6>
                                <p>Export the currently filtered table data to CSV format.</p>
                                <button class="btn btn-info" id="exportTableModalBtn">
                                    <i class="fas fa-file-csv"></i> Export Table to CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Full Import Tab -->
                        <div class="tab-pane fade" id="import" role="tabpanel">
                            <div>
                                <h6>Import Data</h6>
                                <p>Import data from a previously exported JSON file. This will replace all current data.</p>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Warning: This will replace all your current data.
                                </div>
                                <div class="mb-3">
                                    <label for="importFile" class="form-label">Select JSON File</label>
                                    <input class="form-control" type="file" id="importFile" accept=".json">
                                </div>
                                <button class="btn btn-primary" id="importData">
                                    <i class="fas fa-upload"></i> Import from File
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selective Import Tab -->
                        <div class="tab-pane fade" id="selective-import" role="tabpanel">
                            <h6>Selective Import</h6>
                            <p>Select specific items from another user's file to import into your system.</p>
                            
                            <div class="mb-3">
                                <label for="selectiveImportFile" class="form-label">Select User's JSON File</label>
                                <input class="form-control" type="file" id="selectiveImportFile" accept=".json">
                            </div>
                            
                            <div id="selectiveImportPreview" style="display: none;">
                                <h6 class="mt-4">Preview Items</h6>
                                <p>Select the items you want to import:</p>
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllItems">
                                    <label class="form-check-label" for="selectAllItems">
                                        Select All Items
                                    </label>
                                </div>
                                
                                <div class="import-preview-table">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th width="50px"></th>
                                                <th>Company</th>
                                                <th>Product</th>
                                                <th>Received Date</th>
                                                <th>Total Price</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="importPreviewTableBody">
                                            <!-- Will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="import-summary">
                                    <h6>Import Summary</h6>
                                    <p id="selectedItemsCount">0 items selected for import</p>
                                    <div id="duplicateWarning" class="alert alert-warning" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i> Some items appear to be duplicates of existing records.
                                    </div>
                                    
                                    <div class="form-check mb-2">
                                        <input class="form-select-input" type="checkbox" id="skipDuplicates" checked>
                                        <label class="form-check-label" for="skipDuplicates">
                                            Skip duplicate items (based on company, product, and amount)
                                        </label>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success mt-3" id="confirmSelectiveImport">
                                    <i class="fas fa-file-import"></i> Import Selected Items
                                </button>
                            </div>
                        </div>
                        
                        <!-- Sync Tab -->
                        <div class="tab-pane fade" id="sync" role="tabpanel">
                            <h6>Cloud Sync</h6>
                            <p>Sync your data across devices using your browser's storage.</p>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="cloudSyncToggle" checked>
                                <label class="form-check-label" for="cloudSyncToggle">Enable Cloud Sync</label>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted" id="syncInfo">Data is being synced across your devices</small>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-outline-secondary" id="manualSyncBtn">
                                    <i class="fas fa-sync-alt"></i> Sync Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Order Modal -->
    <div class="modal fade" id="viewOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetails">
                    <!-- Will be populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deleteOrder">Delete Order</button>
                    <button type="button" class="btn btn-primary" id="editOrderBtn">Edit Order</button>
                </div>
            </div>
        </div>
    </div>

<!-- Clean View Modal -->
<div class="modal fade" id="cleanViewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clean Order View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="text-muted" id="cleanViewStats">Showing 0 of 0 records</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="printCleanView">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm" id="cleanViewTable">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Product</th>
                                <th>Received Date</th>
                                <th>Total Price</th>
                                <th>Running Balance</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Status Dropdown (for inline editing) -->
    <div class="status-dropdown" id="statusDropdown">
        <div class="status-option" data-status="ordered">Ordered</div>
        <div class="status-option" data-status="received">Received</div>
        <div class="status-option" data-status="pending">Pending</div>
        <div class="status-option" data-status="paid">Paid</div>
    </div>


    <footer class="bg-dark text-white text-center py-3 mt-5">
        <p class="mb-0">Dr. Wen-Ming Yang Lab Budget Management System &copy; 2025 (v20: Logout)</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Password System Implementation
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is already logged in
    if (!isLoggedIn()) {
        // Show login modal if not logged in
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
        
        // Hide application content until logged in
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('reportsSection').style.display = 'none';
        document.querySelector('.navbar').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
    } else {
        // Initialize the app if already logged in
        initializeApp();
    }
    
    // Setup login form handler
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const password = document.getElementById('passwordInput').value;
        if (validatePassword(password)) {
            setLoggedIn(true);
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            initializeApp(); // Use initializeApp instead of init
        } else {
            alert('Incorrect password. Please try again.');
        }
    });
    
    // Setup logout button
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        setLoggedIn(false);
        
        // Hide all application content
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('reportsSection').style.display = 'none';
        document.querySelector('.navbar').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
        
        // Show login modal
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        loginModal.show();
        
        // Clear password field
        document.getElementById('passwordInput').value = '';
    });
    
    // Setup change password form
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!validatePassword(currentPassword)) {
            alert('Current password is incorrect.');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match.');
            return;
        }
        
        setPassword(newPassword);
        alert('Password changed successfully.');
        bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
        
        // Clear the form
        document.getElementById('changePasswordForm').reset();
    });
    
    // Password toggle visibility
    document.getElementById('passwordToggle').addEventListener('click', function() {
        const passwordInput = document.getElementById('passwordInput');
        const icon = this.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });
});

        // Password utility functions
        function getStoredPassword() {
            return localStorage.getItem('labBudgetPassword') || 'lab2025'; // Default password
        }
        
        function setPassword(newPassword) {
            localStorage.setItem('labBudgetPassword', newPassword);
        }
        
        function validatePassword(password) {
            return password === getStoredPassword();
        }
        
        function isLoggedIn() {
            return sessionStorage.getItem('labBudgetLoggedIn') === 'true';
        }
        
        function setLoggedIn(status) {
            if (status) {
                sessionStorage.setItem('labBudgetLoggedIn', 'true');
            } else {
                sessionStorage.removeItem('labBudgetLoggedIn');
            }
        }
        
        // Add this new function
		function initializeApp() {
		    // Show application content
		    document.getElementById('dashboardSection').style.display = 'block';
		    document.querySelector('.navbar').style.display = 'flex';
		    document.querySelector('footer').style.display = 'block';
    
		    // Initialize the application
		    init();
		}

        // Initialize the rest of the application
        // Data storage and management
        let orders = JSON.parse(localStorage.getItem('labOrders')) || [];
        let currentViewId = null;
        let cloudSyncEnabled = true;
        let companySpendingChart = null;
        let statusChart = null;
        let importPreviewData = [];
        let currentEditingStatusId = null;
        
        // Budget variables
        const initialBudget = 0; // Starting budget
        let currentBudget = initialBudget;
        
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        let filteredOrders = [];
        let sortField = 'dateAdded';
        let sortDirection = 'desc';

        // DOM elements
        const ordersTable = document.getElementById('ordersTable');
        const ordersTableBody = ordersTable.querySelector('tbody');
        const orderForm = document.getElementById('orderForm');
        const totalOrdersElem = document.getElementById('totalOrders');
        const pendingOrdersElem = document.getElementById('pendingOrders');
        const totalSpentElem = document.getElementById('totalSpent');
        const budgetBalanceElem = document.getElementById('budgetBalance');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const grantFilter = document.getElementById('grantFilter');
        const companyFilter = document.getElementById('companyFilter');
        const dateFilter = document.getElementById('dateFilter');
        const excludeFilter = document.getElementById('excludeFilter'); // NEW: Exclude filter
        const syncStatus = document.getElementById('syncStatus');
        const syncStatusText = document.getElementById('syncStatusText');
        const syncBtn = document.getElementById('syncBtn');
        const cloudSyncToggle = document.getElementById('cloudSyncToggle');
        const syncInfo = document.getElementById('syncInfo');
        const exportDataBtn = document.getElementById('exportData');
        const importDataBtn = document.getElementById('importData');
        const importFile = document.getElementById('importFile');
        const dashboardSection = document.getElementById('dashboardSection');
        const reportsSection = document.getElementById('reportsSection');
        const reportCompanyFilter = document.getElementById('reportCompanyFilter');
        const generateReportBtn = document.getElementById('generateReport');
        const companyReports = document.getElementById('companyReports');
        const advancedFilterToggle = document.getElementById('advancedFilterToggle');
        const advancedFilters = document.getElementById('advancedFilters');
        const clearFilters = document.getElementById('clearFilters');
        const compactViewToggle = document.getElementById('compactViewToggle');
        const filterStats = document.getElementById('filterStats');
        const paginationInfo = document.getElementById('paginationInfo');
        const itemsPerPageSelect = document.getElementById('itemsPerPage');
        const ordersPagination = document.getElementById('ordersPagination');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const exportTableBtn = document.getElementById('exportTableBtn');
        const addSampleDataBtn = document.getElementById('addSampleData');
        const addSampleDataLink = document.getElementById('addSampleDataLink');
        const noOrdersRow = document.getElementById('noOrdersRow');
        const debugPanel = document.getElementById('debugPanel');
        const debugInfo = document.getElementById('debugInfo');
        const debugToggle = document.getElementById('debugToggle');
        const exportTableModalBtn = document.getElementById('exportTableModalBtn');
        const manualSyncBtn = document.getElementById('manualSyncBtn');
        const selectiveImportFile = document.getElementById('selectiveImportFile');
        const selectiveImportPreview = document.getElementById('selectiveImportPreview');
        const importPreviewTableBody = document.getElementById('importPreviewTableBody');
        const selectAllItems = document.getElementById('selectAllItems');
        const selectedItemsCount = document.getElementById('selectedItemsCount');
        const duplicateWarning = document.getElementById('duplicateWarning');
        const confirmSelectiveImport = document.getElementById('confirmSelectiveImport');
        const skipDuplicates = document.getElementById('skipDuplicates');
        const statusDropdown = document.getElementById('statusDropdown');

        // Initialize the app
        function init() {
            
           if (!isLoggedIn()) {
		        return; // Don't initialize if not logged in
		    }
            
            updateUI();
            setupEventListeners();
            checkOnlineStatus();
            setupSync();
            setupNavigation();
            applyFilters();
            
            // Add debug info
            updateDebugInfo();
        }

        // Setup navigation
        function setupNavigation() {
            document.querySelectorAll('[data-section]').forEach(link => {
                link.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    if (section === 'dashboard') {
                        dashboardSection.style.display = 'block';
                        reportsSection.style.display = 'none';
                        this.classList.add('active');
                        document.querySelector('[data-section="reports"]').classList.remove('active');
                    } else if (section === 'reports') {
                        dashboardSection.style.display = 'none';
                        reportsSection.style.display = 'block';
                        this.classList.add('active');
                        document.querySelector('[data-section="dashboard"]').classList.remove('active');
                        generateCompanyReports();
                    }
                });
            });
        }

        // Calculate total price
        function calculateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            document.getElementById('totalPrice').value = (amount * unitPrice).toFixed(2);
        }

        // Calculate total price for edit form
        function calculateEditTotal() {
            const amount = parseFloat(document.getElementById('editAmount').value) || 0;
            const unitPrice = parseFloat(document.getElementById('editUnitPrice').value) || 0;
            document.getElementById('editTotalPrice').value = (amount * unitPrice).toFixed(2);
        }

        // Calculate budget balance
        function calculateBudgetBalance() {
            const spent = orders.reduce((sum, order) => {
                // Only count orders that are received or paid
                if (order.status === 'received' || order.status === 'paid') {
                    return sum + parseFloat(order.totalPrice || 0);
                }
                return sum;
            }, 0);
            
            const balance = initialBudget - spent;
            currentBudget = balance;
            
            // Update UI
            budgetBalanceElem.textContent = `$${balance.toFixed(2)}`;
            
            // Add color coding
            if (balance < 0) {
                budgetBalanceElem.classList.remove('balance-positive');
                budgetBalanceElem.classList.add('balance-negative');
            } else {
                budgetBalanceElem.classList.remove('balance-negative');
                budgetBalanceElem.classList.add('balance-positive');
            }
            
            return balance;
        }

        // Calculate balance for a specific order
        function calculateOrderBalance(order) {
            // For display purposes, we'll show the impact on budget
            // Orders that are received or paid reduce the budget
            if (order.status === 'received' || order.status === 'paid') {
                return -parseFloat(order.totalPrice || 0);
            }
            return 0;
        }

        // Save order
        function saveOrder() {
            const order = {
                id: Date.now().toString(),
                company: document.getElementById('companyName').value,
                product: document.getElementById('productName').value,
                amount: document.getElementById('amount').value,
                unitPrice: document.getElementById('unitPrice').value,
                totalPrice: document.getElementById('totalPrice').value,
                orderedBy: document.getElementById('orderedBy').value,
                receivedBy: document.getElementById('receivedBy').value,
                receivedDate: document.getElementById('receivedDate').value,
                paperworkDate: document.getElementById('paperworkDate').value,
                status: document.getElementById('processStatus').value,
                paidByGrant: document.getElementById('paidByGrant').value,
                notes: document.getElementById('notes').value,
                dateAdded: new Date().toISOString()
            };

            orders.push(order);
            saveToStorage();
            
            // Reset form and close modal
            orderForm.reset();
            document.getElementById('totalPrice').value = '';
            bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
            
            updateUI();
            showNotification('Order added successfully!', 'success');
        }

        // Save to storage
        function saveToStorage() {
            localStorage.setItem('labOrders', JSON.stringify(orders));
            if (cloudSyncEnabled) {
                syncToCloud();
            }
        }

        // Sync to cloud (using localStorage as a simple cloud substitute)
        function syncToCloud() {
            // In a real app, this would sync with a cloud service
            // For this demo, we'll simulate it by storing in localStorage
            // and using storage events to sync across tabs/devices
            localStorage.setItem('labOrders', JSON.stringify(orders));
            localStorage.setItem('lastSync', new Date().toISOString());
            
            // Show sync status
            syncStatus.classList.add('sync-online');
            syncStatusText.textContent = 'Synced';
            
            // Simulate network delay
            setTimeout(() => {
                syncStatus.classList.remove('sync-online');
                syncStatusText.textContent = 'Online';
            }, 2000);
        }

        // Update UI with orders
        function updateUI() {
            // Update stats
            totalOrdersElem.textContent = orders.length;
            pendingOrdersElem.textContent = orders.filter(o => o.status === 'pending').length;
            
            const totalSpent = orders.reduce((sum, order) => sum + parseFloat(order.totalPrice || 0), 0);
            totalSpentElem.textContent = '$' + totalSpent.toFixed(2);
            
            // Update budget balance
            calculateBudgetBalance();
            
            // Update recent orders (last 7 days)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Update filters
            updateFilters();
            
            // Apply filters and display orders
            applyFilters();
            
            // Update debug info
            updateDebugInfo();
        }

        function updateFilters() {
            // Update grants filter
            const grants = [...new Set(orders.map(o => o.paidByGrant).filter(Boolean))];
            grantFilter.innerHTML = '<option value="">All Grants</option>';
            grants.forEach(grant => {
                grantFilter.innerHTML += `<option value="${grant}">${grant}</option>`;
            });
            
            // Update companies filter
            const companies = [...new Set(orders.map(o => o.company).filter(Boolean))];
            companyFilter.innerHTML = '<option value="">All Companies</option>';
            companies.forEach(company => {
                companyFilter.innerHTML += `<option value="${company}">${company}</option>`;
            });
            
            // Update report company filter
            reportCompanyFilter.innerHTML = '<option value="">All Companies</option>';
            companies.forEach(company => {
                reportCompanyFilter.innerHTML += `<option value="${company}">${company}</option>`;
            });
        }

        // Apply filters and sort
// Apply filters and sort
// Apply filters and sort
function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const grantValue = grantFilter.value;
    const companyValue = companyFilter.value;
    const dateValue = dateFilter.value;
    const excludeValue = excludeFilter.value.toLowerCase();
    
    // Split exclude terms by commas and trim whitespace
    const excludeTerms = excludeValue 
        ? excludeValue.split(',').map(term => term.trim()).filter(term => term.length > 0)
        : [];
    
    filteredOrders = orders.filter(order => {
        const matchesSearch = 
            order.company.toLowerCase().includes(searchTerm) ||
            order.product.toLowerCase().includes(searchTerm) ||
            order.orderedBy.toLowerCase().includes(searchTerm) ||
            (order.notes && order.notes.toLowerCase().includes(searchTerm));
        
        const matchesStatus = statusValue ? order.status === statusValue : true;
        const matchesGrant = grantValue ? order.paidByGrant === grantValue : true;
        const matchesCompany = companyValue ? order.company === companyValue : true;
        
        // Date filtering
        let matchesDate = true;
        if (dateValue) {
            const days = parseInt(dateValue);
            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - days);
            matchesDate = new Date(order.dateAdded) >= dateLimit;
        }
        
        // Exclude filtering - check if order contains any excluded terms
        let matchesExclude = true;
        if (excludeTerms.length > 0) {
            const orderText = `${order.company} ${order.product} ${order.orderedBy} ${order.notes || ''} ${order.paidByGrant || ''}`.toLowerCase();
            
            // If the order contains any excluded term, exclude it
            matchesExclude = !excludeTerms.some(term => orderText.includes(term));
        }
        
        return matchesSearch && matchesStatus && matchesGrant && matchesCompany && matchesDate && matchesExclude;
    });
    
    // Sort the filtered orders
    filteredOrders.sort((a, b) => {
        let valueA = a[sortField];
        let valueB = b[sortField];
        
        // Handle running balance separately
        if (sortField === 'balance') {
            // For running balance, we need to calculate the actual running balance values
            const ordersWithRunningBalance = calculateRunningBalance();
            const orderAIndex = filteredOrders.findIndex(o => o.id === a.id);
            const orderBIndex = filteredOrders.findIndex(o => o.id === b.id);
            
            // Use balanceAfter for sorting
            valueA = ordersWithRunningBalance[orderAIndex].balanceAfter;
            valueB = ordersWithRunningBalance[orderBIndex].balanceAfter;
        }
        
        // Handle numeric values
        if (sortField === 'amount' || sortField === 'unitPrice' || sortField === 'totalPrice') {
            valueA = parseFloat(valueA);
            valueB = parseFloat(valueB);
        }
        
        // Handle date values
        if (sortField === 'dateAdded' || sortField === 'receivedDate') {
            valueA = new Date(valueA);
            valueB = new Date(valueB);
        }
        
        if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Update filter stats
    updateFilterStats();
    
    // Calculate filtered spending
    calculateFilteredSpending();
    
    // Update pagination
    updatePagination();
    
    // Display orders for current page
    displayOrdersForCurrentPage();
}

function updateFilterStats() {
    const total = orders.length;
    const filtered = filteredOrders.length;
    
    // Calculate filtered spending
    const { filteredSpent, filteredBalance } = calculateFilteredSpending();
    
    if (filtered === total) {
        filterStats.textContent = `Showing all ${total} records`;
    } else {
        filterStats.textContent = `Showing ${filtered} of ${total} records (filtered) | Spending: $${filteredSpent.toFixed(2)} | Balance: $${filteredBalance.toFixed(2)}`;
    }
}

        function updatePagination() {
            totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            
            // Ensure current page is within valid range
            if (currentPage > totalPages) {
                currentPage = totalPages > 0 ? totalPages : 1;
            }
            
            // Update pagination controls
            updatePaginationControls();
            
            // Update pagination info
            const start = ((currentPage - 1) * itemsPerPage) + 1;
            const end = Math.min(currentPage * itemsPerPage, filteredOrders.length);
            paginationInfo.textContent = `Showing ${start} to ${end} of ${filteredOrders.length} records`;
        }

        function updatePaginationControls() {
            // Clear existing page numbers
            const pageItems = ordersPagination.querySelectorAll('.page-item:not(:first-child):not(:last-child)');
            pageItems.forEach(item => item.remove());
            
            // Add page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                
                pageItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    applyFilters();
                });
                
                ordersPagination.insertBefore(pageItem, nextPage.parentNode);
            }
            
            // Update previous/next buttons
            prevPage.parentNode.classList.toggle('disabled', currentPage === 1);
            nextPage.parentNode.classList.toggle('disabled', currentPage === totalPages);
        }

function displayOrdersForCurrentPage() {
    ordersTableBody.innerHTML = '';
    
    if (filteredOrders.length === 0) {
        noOrdersRow.style.display = 'table-row';
        return;
    }
    
    noOrdersRow.style.display = 'none';
    
    // Calculate running balance for all filtered orders
    const ordersWithRunningBalance = calculateRunningBalance();
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredOrders.length);
    
    for (let i = startIndex; i < endIndex; i++) {
        const order = ordersWithRunningBalance[i];
        const statusClass = `status-${order.status}`;
        
        // Format the running balance (show balance after this order)
        const balanceClass = order.balanceAfter < 0 ? 'balance-negative' : 'balance-positive';
        const balanceSign = order.balanceAfter < 0 ? '-$' : '$';
        
        const row = document.createElement('tr');
        
        if (compactViewToggle.checked) {
            row.innerHTML = `
                <td>${order.company}</td>
                <td>${order.product}</td>
                <td>${order.receivedDate || 'N/A'}</td>
                <td>$${order.totalPrice}</td>
                <td class="${balanceClass}">${balanceSign}${Math.abs(order.balanceAfter).toFixed(2)}</td>
                <td>
                    <span class="status-badge ${statusClass}" data-id="${order.id}">
                        ${order.status}
                    </span>
                </td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-info view-btn" data-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
        } else {
            row.innerHTML = `
                <td>${order.company}</td>
                <td>${order.product}</td>
                <td>${order.receivedDate || 'N/A'}</td>
                <td>$${order.totalPrice}</td>
                <td class="${balanceClass}">${balanceSign}${Math.abs(order.balanceAfter).toFixed(2)}</td>
                <td>
                    <span class="status-badge ${statusClass}" data-id="${order.id}">
                        ${order.status}
                    </span>
                </td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-info view-btn" data-id="${order.id}">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
        }
        
        ordersTableBody.appendChild(row);
    }
    
    // Add event listeners to view buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            viewOrder(orderId);
        });
    });
    
    // Add event listeners to status badges for inline editing
    const statusBadges = document.querySelectorAll('.status-badge');
    statusBadges.forEach(badge => {
        // Remove any existing listeners first
        badge.replaceWith(badge.cloneNode(true));
    });

    // Now add listeners to the new elements
    document.querySelectorAll('.status-badge').forEach(badge => {
        badge.addEventListener('click', function(e) {
            e.stopPropagation();
            const orderId = this.getAttribute('data-id');
            showStatusDropdown(this, orderId);
        });
    });
}

        // Show status dropdown for inline editing
// Show status dropdown for inline editing
function showStatusDropdown(element, orderId) {
    // Close any open dropdowns first
    hideStatusDropdown();
    
    // Set current editing ID
    currentEditingStatusId = orderId;
    
    // Position the dropdown
    const rect = element.getBoundingClientRect();
    statusDropdown.style.display = 'block';
    statusDropdown.style.position = 'absolute';
    statusDropdown.style.top = `${rect.bottom + window.scrollY}px`;
    statusDropdown.style.left = `${rect.left + window.scrollX}px`;
    
    // Remove any existing event listeners first
    document.querySelectorAll('.status-option').forEach(option => {
        option.replaceWith(option.cloneNode(true));
    });
    
    // Add event listeners to options
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function() {
            const newStatus = this.getAttribute('data-status');
            updateOrderStatus(orderId, newStatus);
            hideStatusDropdown();
        });
    });
}

        // Hide status dropdown
// Hide status dropdown
function hideStatusDropdown() {
    statusDropdown.style.display = 'none';
    currentEditingStatusId = null;
    
    // Remove all event listeners from options
    document.querySelectorAll('.status-option').forEach(option => {
        option.replaceWith(option.cloneNode(true));
    });
}

        // Update order status
// Update order status
function updateOrderStatus(orderId, newStatus) {
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if (orderIndex !== -1) {
        orders[orderIndex].status = newStatus;
        saveToStorage();
        updateUI();
        showNotification('Status updated successfully!', 'success');
    }
}

function viewOrder(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    
    currentViewId = orderId;
    
    // Calculate running balance for the filtered list
    const ordersWithRunningBalance = calculateRunningBalance();
    const currentOrder = ordersWithRunningBalance.find(o => o.id === orderId);
    
    if (!currentOrder) return;
    
    const statusClass = `status-${order.status}`;
    const balanceClass = currentOrder.balanceAfter < 0 ? 'balance-negative' : 'balance-positive';
    const balanceSign = currentOrder.balanceAfter < 0 ? '-$' : '$';
    
    document.getElementById('orderDetails').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Company Information</h6>
                <p><strong>Company:</strong> ${order.company}</p>
                <p><strong>Product:</strong> ${order.product}</p>
                <p><strong>Amount:</strong> ${order.amount}</p>
                <p><strong>Unit Price:</strong> $${order.unitPrice}</p>
                <p><strong>Total Price:</strong> $${order.totalPrice}</p>
            </div>
            <div class="col-md-6">
                <h6>Order Details</h6>
                <p><strong>Ordered By:</strong> ${order.orderedBy}</p>
                <p><strong>Received By:</strong> ${order.receivedBy || 'N/A'}</p>
                <p><strong>Received Date:</strong> ${order.receivedDate || 'N/A'}</p>
                <p><strong>Paperwork Date:</strong> ${order.paperworkDate || 'N/A'}</p>
                <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${order.status}</span></p>
                <p><strong>Balance Before:</strong> $${currentOrder.runningBalance.toFixed(2)}</p>
                <p><strong>This Order:</strong> $${order.totalPrice}</p>
                <p><strong>Balance After:</strong> <span class="${balanceClass}">${balanceSign}${Math.abs(currentOrder.balanceAfter).toFixed(2)}</span></p>
                <p><strong>Paid By Grant:</strong> ${order.paidByGrant || 'N/A'}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Notes</h6>
                <p>${order.notes || 'No notes available.'}</p>
            </div>
        </div>
    `;
    
    const viewModal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
    viewModal.show();
}

        // Edit order
        function editOrder() {
            const order = orders.find(o => o.id === currentViewId);
            if (!order) return;
            
            // Populate the edit form
            document.getElementById('editId').value = order.id;
            document.getElementById('editCompanyName').value = order.company;
            document.getElementById('editProductName').value = order.product;
            document.getElementById('editAmount').value = order.amount;
            document.getElementById('editUnitPrice').value = order.unitPrice;
            document.getElementById('editTotalPrice').value = order.totalPrice;
            document.getElementById('editOrderedBy').value = order.orderedBy;
            document.getElementById('editReceivedBy').value = order.receivedBy || '';
            document.getElementById('editReceivedDate').value = order.receivedDate || '';
            document.getElementById('editPaperworkDate').value = order.paperworkDate || '';
            document.getElementById('editProcessStatus').value = order.status;
            document.getElementById('editPaidByGrant').value = order.paidByGrant || '';
            document.getElementById('editNotes').value = order.notes || '';
            
            // Close the view modal and open the edit modal
            bootstrap.Modal.getInstance(document.getElementById('viewOrderModal')).hide();
            const editModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
            editModal.show();
        }

        // Update order
        function updateOrder() {
            const orderId = document.getElementById('editId').value;
            const orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex === -1) return;
            
            orders[orderIndex] = {
                id: orderId,
                company: document.getElementById('editCompanyName').value,
                product: document.getElementById('editProductName').value,
                amount: document.getElementById('editAmount').value,
                unitPrice: document.getElementById('editUnitPrice').value,
                totalPrice: document.getElementById('editTotalPrice').value,
                orderedBy: document.getElementById('editOrderedBy').value,
                receivedBy: document.getElementById('editReceivedBy').value,
                receivedDate: document.getElementById('editReceivedDate').value,
                paperworkDate: document.getElementById('editPaperworkDate').value,
                status: document.getElementById('editProcessStatus').value,
                paidByGrant: document.getElementById('editPaidByGrant').value,
                notes: document.getElementById('editNotes').value,
                dateAdded: orders[orderIndex].dateAdded
            };
            
            saveToStorage();
            bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
            updateUI();
            showNotification('Order updated successfully!', 'success');
        }

        // Delete order
        function deleteOrder() {
            if (!currentViewId) return;
            
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                orders = orders.filter(o => o.id !== currentViewId);
                saveToStorage();
                
                bootstrap.Modal.getInstance(document.getElementById('viewOrderModal')).hide();
                updateUI();
                showNotification('Order deleted successfully!', 'info');
            }
        }

        // Export data to file
        function exportToFile() {
            const dataStr = JSON.stringify(orders, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'lab-orders.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Data exported successfully!', 'success');
        }

        // Export table to CSV
// Export table to CSV
function exportTableToCSV() {
    if (filteredOrders.length === 0) {
        showNotification('No data to export', 'warning');
        return;
    }
    
    // Calculate running balance for all filtered orders
    const ordersWithRunningBalance = calculateRunningBalance();
    
    let csv = 'Company,Product,Received Date,Total Price,Balance Before,This Order,Balance After,Status,Paid By Grant,Date Added\n';
    
    ordersWithRunningBalance.forEach(order => {
        const balanceAfterSign = order.balanceAfter < 0 ? '-' : '';
        
        csv += `"${order.company}","${order.product}",${order.receivedDate || 'N/A'},${order.totalPrice},${order.runningBalance.toFixed(2)},${order.totalPrice},${balanceAfterSign}${Math.abs(order.balanceAfter).toFixed(2)},${order.status},"${order.paidByGrant || ''}","${new Date(order.dateAdded).toLocaleDateString()}"\n`;
    });
    
    const csvBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const csvUrl = URL.createObjectURL(csvBlob);
    const link = document.createElement('a');
    link.setAttribute('href', csvUrl);
    link.setAttribute('download', 'lab-orders-export.csv');
    link.click();
    
    showNotification('Table exported to CSV successfully!', 'success');
}

        // Import data from file
        function importFromFile() {
            const file = importFile.files[0];
            if (!file) {
                showNotification('Please select a file first.', 'danger');
                return;
            }
            
            const reader =                 reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            if (confirm('This will replace your current data. Continue?')) {
                                orders = importedData;
                                saveToStorage();
                                updateUI();
                                showNotification('Data imported successfully!', 'success');
                                bootstrap.Modal.getInstance(document.getElementById('importExportModal')).hide();
                            }
                        } else {
                            showNotification('Invalid file format.', 'danger');
                        }
                    } catch (error) {
                        showNotification('Error parsing file: ' + error.message, 'danger');
                    }
                };
                reader.readAsText(file);
        }

        // Handle selective import file selection
        function handleSelectiveImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        importPreviewData = importedData;
                        showImportPreview();
                    } else {
                        alert('Invalid file format. Please select a valid JSON file exported from this system.');
                    }
                } catch (error) {
                    alert('Error parsing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Show import preview
        function showImportPreview() {
            // Clear previous preview
            importPreviewTableBody.innerHTML = '';
            
            // Add items to preview table
            importPreviewData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'import-item-row';
                
                // Check if this item is a duplicate
                const isDuplicate = isImportItemDuplicate(item);
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input import-checkbox" data-index="${index}" ${isDuplicate ? 'disabled' : 'checked'}>
                    </td>
                    <td>${item.company}</td>
                    <td>${item.product}</td>
                    <td>${item.receivedDate || 'N/A'}</td>
                    <td>$${parseFloat(item.totalPrice || 0).toFixed(2)}</td>
                    <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                `;
                
                importPreviewTableBody.appendChild(row);
            });
            
            // Show the preview section
            selectiveImportPreview.style.display = 'block';
            
            // Update selection count
            updateImportSelectionCount();
            
            // Show duplicate warning if needed
            const hasDuplicates = importPreviewData.some(item => isImportItemDuplicate(item));
            duplicateWarning.style.display = hasDuplicates ? 'block' : 'none';
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.import-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateImportSelectionCount);
            });
        }

        // Check if an import item is a duplicate
        function isImportItemDuplicate(item) {
            return orders.some(order => 
                order.company === item.company && 
                order.product === item.product && 
                order.amount === item.amount
            );
        }

        // Toggle select all items for import
        function toggleSelectAllImportItems() {
            const checkAll = selectAllItems.checked;
            document.querySelectorAll('.import-checkbox:not(:disabled)').forEach(checkbox => {
                checkbox.checked = checkAll;
            });
            updateImportSelectionCount();
        }

        // Update import selection count
        function updateImportSelectionCount() {
            const selectedCount = document.querySelectorAll('.import-checkbox:checked').length;
            selectedItemsCount.textContent = `${selectedCount} items selected for import`;
        }

        // Perform selective import
        function performSelectiveImport() {
            const skipDupes = document.getElementById('skipDuplicates').checked;
            const selectedIndexes = [];
            
            document.querySelectorAll('.import-checkbox:checked').forEach(checkbox => {
                selectedIndexes.push(parseInt(checkbox.getAttribute('data-index')));
            });
            
            if (selectedIndexes.length === 0) {
                alert('Please select at least one item to import');
                return;
            }
            
            let importedCount = 0;
            let skippedCount = 0;
            
            selectedIndexes.forEach(index => {
                const item = importPreviewData[index];
                
                // Check for duplicates if skipping is enabled
                if (skipDupes && isImportItemDuplicate(item)) {
                    skippedCount++;
                    return;
                }
                
                // Add to orders with a new ID
                orders.push({
                    ...item,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5), // New unique ID
                    dateAdded: new Date().toISOString()
                });
                
                importedCount++;
            });
            
            // Save and update UI
            saveToStorage();
            updateUI();
            
            // Show result
            alert(`Import completed:\n${importedCount} items imported\n${skippedCount} duplicates skipped`);
            
            // Reset import form
            selectiveImportPreview.style.display = 'none';
            selectiveImportFile.value = '';
            importPreviewData = [];
        }

        // Generate company reports
        function generateCompanyReports() {
            const selectedCompany = reportCompanyFilter.value;
            
            // Filter orders by company if a specific company is selected
            let filteredOrders = orders;
            if (selectedCompany) {
                filteredOrders = orders.filter(order => order.company === selectedCompany);
            }
            
            // Group orders by company
            const companyData = {};
            filteredOrders.forEach(order => {
                if (!companyData[order.company]) {
                    companyData[order.company] = {
                        totalSpent: 0,
                        orderCount: 0,
                        orders: []
                    };
                }
                
                companyData[order.company].totalSpent += parseFloat(order.totalPrice || 0);
                companyData[order.company].orderCount++;
                companyData[order.company].orders.push(order);
            });
            
            // Generate HTML for company reports
            let reportsHTML = '';
            
            for (const company in companyData) {
                reportsHTML += `
                    <div class="card company-report mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${company}</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Total Orders:</strong> ${companyData[company].orderCount}</p>
                                    <p><strong>Total Spent:</strong> $${companyData[company].totalSpent.toFixed(2)}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Average Order Value:</strong> $${(companyData[company].totalSpent / companyData[company].orderCount).toFixed(2)}</p>
                                </div>
                            </div>
                            
                            <h6 class="mt-3">Recent Orders</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Received Date</th>
                                            <th>Total Price</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                // Display up to 5 most recent orders
                const recentOrders = companyData[company].orders
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
                    .slice(0, 5);
                
                recentOrders.forEach(order => {
                    const statusClass = `status-${order.status}`;
                    
                    reportsHTML += `
                        <tr>
                            <td>${order.product}</td>
                            <td>${order.receivedDate || 'N/A'}</td>
                            <td>$${order.totalPrice}</td>
                            <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        </tr>
                    `;
                });
                
                reportsHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            companyReports.innerHTML = reportsHTML;
            
            // Generate charts
            generateCharts();
        }

        // Generate charts for reports
        function generateCharts() {
            // Company spending chart
            const companySpending = {};
            orders.forEach(order => {
                if (!companySpending[order.company]) {
                    companySpending[order.company] = 0;
                }
                companySpending[order.company] += parseFloat(order.totalPrice || 0);
            });
            
            const companyCtx = document.getElementById('companySpendingChart').getContext('2d');
            if (companySpendingChart) {
                companySpendingChart.destroy();
            }
            
            companySpendingChart = new Chart(companyCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(companySpending),
                    datasets: [{
                        label: 'Total Spending ($)',
                        data: Object.values(companySpending),
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(230, 126, 34, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(241, 196, 15, 1)',
                            'rgba(230, 126, 34, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Spending by Company'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // Status chart
            const statusCounts = {
                ordered: 0,
                received: 0,
                pending: 0,
                paid: 0
            };
            
            orders.forEach(order => {
                if (statusCounts.hasOwnProperty(order.status)) {
                    statusCounts[order.status]++;
                }
            });
            
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) {
                statusChart.destroy();
            }
            
            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(241, 196, 15, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(241, 196, 15, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Orders by Status'
                        }
                    }
                }
            });
        }

        // Check online status
        function checkOnlineStatus() {
            if (navigator.onLine) {
                syncStatus.classList.add('sync-online');
                syncStatusText.textContent = 'Online';
            } else {
                syncStatus.classList.remove('sync-online');
                syncStatusText.textContent = 'Offline';
            }
        }

        // Setup sync functionality
        function setupSync() {
            // Listen for storage events (simulates cross-device sync)
            window.addEventListener('storage', function(e) {
                if (e.key === 'labOrders' && e.newValue) {
                    try {
                        const newOrders = JSON.parse(e.newValue);
                        if (Array.isArray(newOrders)) {
                            orders = newOrders;
                            updateUI();
                            showNotification('Data synced from another device/tab.', 'info');
                        }
                    } catch (error) {
                        console.error('Error parsing synced data:', error);
                    }
                }
            });
            
            // Periodically check for updates (simulates cloud sync)
            setInterval(() => {
                if (cloudSyncEnabled && navigator.onLine) {
                    const lastSync = localStorage.getItem('lastSync');
                    if (lastSync) {
                        // In a real app, you would check with a cloud service here
                        syncStatus.classList.add('sync-online');
                        syncStatusText.textContent = 'Syncing...';
                        
                        setTimeout(() => {
                            syncStatus.classList.remove('sync-online');
                            syncStatusText.textContent = 'Online';
                        }, 1000);
                    }
                }
            }, 30000);
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Add sample data for testing
        function addSampleData() {
            const sampleData = [
                {
                    id: '1',
                    company: 'BioLab Supplies',
                    product: 'PCR Tubes',
                    amount: '100',
                    unitPrice: '1.50',
                    totalPrice: '150.00',
                    orderedBy: 'Dr. Smith',
                    receivedBy: 'Lab Assistant',
                    receivedDate: '2023-10-15',
                    paperworkDate: '2023-10-16',
                    status: 'received',
                    paidByGrant: 'NIH-2023-BIO',
                    notes: 'Urgent order for ongoing research',
                    dateAdded: '2023-10-10T08:30:00Z'
                },
                {
                    id: '2',
                    company: 'ChemTech Inc.',
                    product: 'Ethanol 99%',
                    amount: '5',
                    unitPrice: '45.00',
                    totalPrice: '225.00',
                    orderedBy: 'Dr. Johnson',
                    receivedBy: '',
                    receivedDate: '',
                    paperworkDate: '',
                    status: 'ordered',
                    paidByGrant: 'NSF-CHEM-2023',
                    notes: 'For lab cleaning and sterilization',
                    dateAdded: '2023-10-12T14:22:00Z'
                },
                {
                    id: '3',
                    company: 'Genomics R Us',
                    product: 'DNA Extraction Kit',
                    amount: '10',
                    unitPrice: '120.00',
                    totalPrice: '1200.00',
                    orderedBy: 'Dr. Williams',
                    receivedBy: 'Lab Manager',
                    receivedDate: '2023-10-05',
                    paperworkDate: '2023-10-06',
                    status: 'paid',
                    paidByGrant: 'HHMI-GEN-2023',
                    notes: 'For new genomics project',
                    dateAdded: '2023-10-01T09:45:00Z'
                }
            ];
            
            // Add sample data to orders
            orders = [...orders, ...sampleData];
            saveToStorage();
            updateUI();
            showNotification('Sample data added successfully!', 'success');
        }

        // Update debug information
        function updateDebugInfo() {
            debugInfo.innerHTML = `
                <p><strong>Orders in memory:</strong> ${orders.length}</p>
                <p><strong>Filtered orders:</strong> ${filteredOrders.length}</p>
                <p><strong>Current page:</strong> ${currentPage} of ${totalPages}</p>
                <p><strong>Items per page:</strong> ${itemsPerPage}</p>
                <p><strong>Sort field:</strong> ${sortField}</p>
                <p><strong>Sort direction:</strong> ${sortDirection}</p>
                <p><strong>LocalStorage data:</strong> ${localStorage.getItem('labOrders') ? 'Present' : 'None'}</p>
                <p><strong>Current Budget:</strong> $${currentBudget.toFixed(2)}</p>
            `;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Calculate total price
            document.getElementById('amount').addEventListener('input', calculateTotal);
            document.getElementById('unitPrice').addEventListener('input', calculateTotal);
            
            // Calculate total price for edit form
            document.getElementById('editAmount').addEventListener('input', calculateEditTotal);
            document.getElementById('editUnitPrice').addEventListener('input', calculateEditTotal);
            
            // Save order
            document.getElementById('saveOrder').addEventListener('click', saveOrder);
            
            // Update order
            document.getElementById('updateOrder').addEventListener('click', updateOrder);
            
            // Delete order
            document.getElementById('deleteOrder').addEventListener('click', deleteOrder);
            
            // Edit order button
            document.getElementById('editOrderBtn').addEventListener('click', editOrder);
            
            // Clean view button
cleanViewBtn.addEventListener('click', openCleanView);

// Print clean view
printCleanView.addEventListener('click', printCleanViewTable);
            
            // Filter events
            searchInput.addEventListener('input', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            grantFilter.addEventListener('change', applyFilters);
            companyFilter.addEventListener('change', applyFilters);
            dateFilter.addEventListener('change', applyFilters);
            excludeFilter.addEventListener('input', applyFilters); // NEW: Exclude filter event
            
            // Advanced filters toggle
            advancedFilterToggle.addEventListener('click', function() {
                if (advancedFilters.style.display === 'none') {
                    advancedFilters.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-filter"></i> Hide Filters';
                } else {
                    advancedFilters.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-filter"></i> Advanced Filters';
                }
            });
            
            // Clear filters
// Clear filters
clearFilters.addEventListener('click', function() {
    searchInput.value = '';
    statusFilter.value = '';
    grantFilter.value = '';
    companyFilter.value = '';
    dateFilter.value = '';
    excludeFilter.value = ''; // NEW: Clear the exclude filter
    applyFilters(); // This will recalculate the filtered spending
});
            
            // Compact view toggle
            compactViewToggle.addEventListener('change', function() {
                applyFilters();
            });
            
            // Items per page change
            itemsPerPageSelect.addEventListener('change', function() {
                itemsPerPage = parseInt(this.value);
                currentPage = 1;
                applyFilters();
            });
            
            // Pagination controls
            prevPage.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    applyFilters();
                }
            });
            
            nextPage.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    applyFilters();
                }
            });
            
            // Sortable headers
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', function() {
                    const field = this.getAttribute('data-sort');
                    
                    if (sortField === field) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortField = field;
                        sortDirection = 'asc';
                    }
                    
                    // Update sort indicators
                    document.querySelectorAll('.sortable-header i').forEach(icon => {
                        icon.className = 'fas fa-sort';
                    });
                    
                    this.querySelector('i').className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}`;
                    
                    applyFilters();
                });
            });
            
            // Sync button
            syncBtn.addEventListener('click', function() {
                syncToCloud();
                showNotification('Syncing data...', 'info');
            });
            
            // Manual sync button
            manualSyncBtn.addEventListener('click', function() {
                syncToCloud();
                showNotification('Syncing data...', 'info');
            });
            
            // Cloud sync toggle
            cloudSyncToggle.addEventListener('change', function() {
                cloudSyncEnabled = this.checked;
                if (cloudSyncEnabled) {
                    syncInfo.textContent = 'Data is being synced across your devices';
                    syncToCloud();
                } else {
                    syncInfo.textContent = 'Cloud sync is disabled';
                }
            });
            
            // Export data
            exportDataBtn.addEventListener('click', exportToFile);
            
            // Export table
            exportTableBtn.addEventListener('click', exportTableToCSV);
            exportTableModalBtn.addEventListener('click', exportTableToCSV);
            
            // Import data
            importDataBtn.addEventListener('click', importFromFile);
            
            // Generate report
            generateReportBtn.addEventListener('click', generateCompanyReports);
            
            // Online/offline status
            window.addEventListener('online', checkOnlineStatus);
            window.addEventListener('offline', checkOnlineStatus);
            
            // Add sample data
            addSampleDataBtn.addEventListener('click', addSampleData);
            addSampleDataLink.addEventListener('click', function(e) {
                e.preventDefault();
                addSampleData();
            });
            
            // Debug toggle
            debugToggle.addEventListener('click', function() {
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            });
            
            // Selective import
            selectiveImportFile.addEventListener('change', handleSelectiveImportFile);
            selectAllItems.addEventListener('change', toggleSelectAllImportItems);
            confirmSelectiveImport.addEventListener('click', performSelectiveImport);
            
            // Close status dropdown when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (currentEditingStatusId && !e.target.closest('.status-badge') && !e.target.closest('.status-dropdown')) {
                    hideStatusDropdown();
                }
            });
        }

// Calculate spending for filtered orders
function calculateFilteredSpending() {
    const filteredSpent = filteredOrders.reduce((sum, order) => {
        // Only count orders that are received or paid
        if (order.status === 'received' || order.status === 'paid') {
            return sum + parseFloat(order.totalPrice || 0);
        }
        return sum;
    }, 0);
    
    const filteredBalance = initialBudget - filteredSpent;
    
    // Update UI
    document.getElementById('filteredSpending').textContent = `$${filteredSpent.toFixed(2)}`;
    
    const balanceElement = document.getElementById('filteredBalance');
    balanceElement.textContent = `$${filteredBalance.toFixed(2)}`;
    
    // Add color coding
    if (filteredBalance < 0) {
        balanceElement.classList.remove('balance-positive');
        balanceElement.classList.add('balance-negative');
    } else {
        balanceElement.classList.remove('balance-negative');
        balanceElement.classList.add('balance-positive');
    }
    
    return { filteredSpent, filteredBalance };
}

// Calculate spending for all orders (existing function, just ensuring it's there)
function calculateBudgetBalance() {
    const spent = orders.reduce((sum, order) => {
        // Only count orders that are received or paid
        if (order.status === 'received' || order.status === 'paid') {
            return sum + parseFloat(order.totalPrice || 0);
        }
        return sum;
    }, 0);
    
    const balance = initialBudget - spent;
    currentBudget = balance;
    
    // Update UI
    budgetBalanceElem.textContent = `$${balance.toFixed(2)}`;
    
    // Add color coding
    if (balance < 0) {
        budgetBalanceElem.classList.remove('balance-positive');
        budgetBalanceElem.classList.add('balance-negative');
    } else {
        budgetBalanceElem.classList.remove('balance-negative');
        budgetBalanceElem.classList.add('balance-positive');
    }
    
    return balance;
}

// Calculate running balance for filtered orders
// Calculate running balance for filtered orders
function calculateRunningBalance() {
    let runningBalance = initialBudget;
    
    // Create a new array with running balance for each order
    const ordersWithRunningBalance = filteredOrders.map(order => {
        // Calculate the balance before this order
        const balanceBefore = runningBalance;
        
        // Only adjust balance for received or paid orders
        if (order.status === 'received' || order.status === 'paid') {
            const orderValue = parseFloat(order.totalPrice || 0);
            runningBalance -= orderValue;
        }
        
        // Return the order with its running balance
        return {
            ...order,
            runningBalance: balanceBefore, // Show balance before this order
            balanceAfter: runningBalance   // Show balance after this order
        };
    });
    
    return ordersWithRunningBalance;
}

// DOM element for clean view button
const cleanViewBtn = document.getElementById('cleanViewBtn');
const cleanViewModal = document.getElementById('cleanViewModal');
const cleanViewTable = document.getElementById('cleanViewTable');
const cleanViewTableBody = cleanViewTable.querySelector('tbody');
const cleanViewStats = document.getElementById('cleanViewStats');
const printCleanView = document.getElementById('printCleanView');

// Open clean view
function openCleanView() {
    // Calculate running balance for all filtered orders
    const ordersWithRunningBalance = calculateRunningBalance();
    
    // Update stats
    cleanViewStats.textContent = `Showing ${ordersWithRunningBalance.length} orders`;
    
    // Clear table
    cleanViewTableBody.innerHTML = '';
    
    // Add rows
    if (ordersWithRunningBalance.length === 0) {
        cleanViewTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">No orders found</td>
            </tr>
        `;
    } else {
        ordersWithRunningBalance.forEach(order => {
            const statusClass = `status-${order.status}`;
            const balanceClass = order.balanceAfter < 0 ? 'balance-negative' : 'balance-positive';
            const balanceSign = order.balanceAfter < 0 ? '-$' : '$';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.company}</td>
                <td>${order.product}</td>
                <td>${order.receivedDate || 'N/A'}</td>
                <td>$${order.totalPrice}</td>
                <td class="${balanceClass}">${balanceSign}${Math.abs(order.balanceAfter).toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
            `;
            cleanViewTableBody.appendChild(row);
        });
    }
    
    // Show modal
    const modal = new bootstrap.Modal(cleanViewModal);
    modal.show();
}

// Print clean view
function printCleanViewTable() {
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Order List - ${new Date().toLocaleDateString()}</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 12px; }
                table { width: 100%; border-collapse: collapse; }
                th { background-color: #f8f9fa; color: #495057; font-weight: 600; padding: 6px; text-align: left; }
                td { padding: 6px; border-bottom: 1px solid #dee2e6; }
                .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
                .status-ordered { background-color: #ffeaa7; color: #d35400; }
                .status-received { background-color: #d1f7c4; color: #27ae60; }
                .status-pending { background-color: #ffcfd2; color: #c0392b; }
                .status-paid { background-color: #c7ecee; color: #16a085; }
                .balance-positive { color: #28a745; font-weight: bold; }
                .balance-negative { color: #dc3545; font-weight: bold; }
                .header { text-align: center; margin-bottom: 20px; }
                .footer { margin-top: 30px; font-size: 10px; color: #6c757d; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>Order List</h2>
                <p>Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                <p>Total orders: ${ordersWithRunningBalance.length}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Product</th>
                        <th>Received Date</th>
                        <th>Total Price</th>
                        <th>Running Balance</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${ordersWithRunningBalance.map(order => {
                        const statusClass = `status-${order.status}`;
                        const balanceClass = order.balanceAfter < 0 ? 'balance-negative' : 'balance-positive';
                        const balanceSign = order.balanceAfter < 0 ? '-$' : '$';
                        
                        return `
                            <tr>
                                <td>${order.company}</td>
                                <td>${order.product}</td>
                                <td>${order.receivedDate || 'N/A'}</td>
                                <td>$${order.totalPrice}</td>
                                <td class="${balanceClass}">${balanceSign}${Math.abs(order.balanceAfter).toFixed(2)}</td>
                                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>Lab Budget Management System - ${new Date().getFullYear()}</p>
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for content to load before printing
    printWindow.onload = function() {
        printWindow.print();
        // printWindow.close(); // Uncomment to automatically close after printing
    };
}

        // Initialize the app
        init();
    </script>
</body>
</html>