<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowFocus Work Mode | Instance: Default</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3a7c, #3a4a8c);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo i {
            color: var(--primary-light);
            font-size: 32px;
        }

        h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .tagline {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .work-mode-active {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .work-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .work-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .work-timer-display {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            min-width: 100px;
        }

        .work-mode-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
        }

        .work-dropdown {
            position: relative;
            margin-left: 10px;
        }

        .work-dropdown-select {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            min-width: 150px;
            max-width: 200px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }

        .work-dropdown-select:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .work-timer-controls {
            display: flex;
            gap: 8px;
        }

        .work-timer-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .work-timer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .work-controls {
            display: flex;
            gap: 10px;
        }

        .expand-time-dropdown {
            position: relative;
            display: inline-block;
        }

        .expand-time-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .expand-time-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .expand-time-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            right: 0;
            top: 100%;
            margin-top: 5px;
        }

        .expand-time-dropdown-content a {
            color: var(--dark);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: var(--transition);
        }

        .expand-time-dropdown-content a:hover {
            background-color: var(--gray-light);
        }

        .expand-time-dropdown:hover .expand-time-dropdown-content {
            display: block;
        }

        .work-main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 70vh;
        }

        .work-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .work-tabs {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid var(--gray-light);
        }

        .work-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .work-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .work-tab:hover {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .work-tab-content {
            flex: 1;
            padding: 0;
            display: none;
            overflow-y: auto;
            background: white;
        }

        .work-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .work-task-area {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            color: var(--dark);
        }

        .work-history-area {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            color: var(--dark);
        }

        .work-notes-area {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            color: var(--dark);
        }

        .work-current-task {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }

        .work-current-task h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .work-task-stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .work-task-stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            flex: 1;
            box-shadow: var(--shadow);
        }

        .work-task-stat-value {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .work-task-stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .task-item:hover {
            background-color: var(--gray-light);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .task-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            margin-top: 2px;
        }

        .task-details {
            flex: 1;
        }

        .task-name {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .task-notes {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
        }

        .task-note-line {
            display: block;
            margin-bottom: 4px;
            padding-left: 10px;
            position: relative;
        }

        .task-note-line:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        .task-completed .task-name {
            text-decoration: line-through;
            color: var(--gray);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .focus-on-btn {
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .focus-on-btn:hover {
            background: #e6890e;
            transform: translateY(-1px);
        }

        .quick-note-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 1rem;
            transition: var(--transition);
            padding: 6px;
            border-radius: 4px;
            background-color: rgba(67, 97, 238, 0.1);
        }

        .quick-note-btn:hover {
            color: white;
            background-color: var(--primary);
            transform: scale(1.1);
        }

        .records-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            table-layout: fixed;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            vertical-align: top;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
        }

        .col-date { width: 120px; }
        .col-project { width: 140px; }
        .col-session-details { width: 200px; }
        .col-task-notes { width: 200px; }
        .col-work-notes { width: 200px; }
        .col-ideas { width: 200px; }
        .col-actions { width: 60px; }

        tr {
            transition: var(--transition);
        }

        tr:not(:first-child):hover {
            background-color: rgba(67, 97, 238, 0.03);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--gray-light);
        }

        .notes-ideas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }

        @media (max-width: 768px) {
            .notes-ideas-grid {
                grid-template-columns: 1fr;
            }
        }

        .notes-column, .ideas-column {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .notes-column-header, .ideas-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        .notes-column-header h3, .ideas-column-header h3 {
            color: var(--primary);
            margin: 0;
            font-size: 1.2rem;
        }

        .notes-column-content, .ideas-column-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .notes-textarea-large {
            flex: 1;
            min-height: 300px;
            width: 100%;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 0.95rem;
            resize: vertical;
            transition: var(--transition);
            box-sizing: border-box;
        }

        .notes-textarea-large:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .idea-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .idea-textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 0.95rem;
            min-height: 100px;
            resize: vertical;
        }

        .idea-textarea:focus {
            border-color: var(--success);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }

        .ideas-list-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .idea-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid var(--success);
        }

        .idea-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .idea-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .idea-actions {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 1rem;
            transition: var(--transition);
            padding: 6px;
            border-radius: 4px;
        }

        .icon-btn:hover {
            color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aa8d1;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e6890e;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #e11574;
        }

        .clear-all-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: center;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: translateY(-20px);
            transition: var(--transition);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray);
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .project-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .project-name {
            font-weight: 500;
            color: var(--dark);
        }

        .project-actions {
            display: flex;
            gap: 5px;
        }

        .add-project-form {
            display: flex;
            gap: 10px;
        }

        .add-project-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
        }

        .task-management-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .task-management-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-backlog {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--gray);
        }

        .status-working {
            background-color: rgba(67, 97, 238, 0.2);
            color: var(--primary);
        }

        .status-toggle-buttons {
            display: flex;
            gap: 5px;
            margin-right: 10px;
        }

        .status-toggle-btn {
            background: var(--gray-light);
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
        }

        .status-toggle-btn:hover {
            background: var(--gray);
            color: white;
        }

        .status-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        .status-toggle-btn[data-status="backlog"].active {
            background: var(--gray);
        }

        .status-toggle-btn[data-status="working"].active {
            background: var(--primary);
        }

        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        .save-indicator.saving {
            color: var(--warning);
        }

        .save-indicator.saved {
            color: var(--success);
        }

        .save-indicator.error {
            color: var(--danger);
        }

        .time-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--danger);
            color: white;
            padding: 30px 50px;
            border-radius: var(--border-radius);
            font-size: 2rem;
            font-weight: 700;
            z-index: 1003;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: pulse 0.5s infinite alternate;
            text-align: center;
        }

        @keyframes pulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.1); }
        }

        .time-up-notification.hidden {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .app-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .app-action-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .settings-group {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .settings-group h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
            color: var(--dark);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

/* Floating App Buttons - SMALLER VERSION */
.floating-app-buttons {
    position: fixed;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1002;
    display: flex;
    flex-direction: column;
    gap: 10px; /* Reduced gap */
}

.floating-app-btn {
    width: 48px; /* Reduced from 60px */
    height: 48px; /* Reduced from 60px */
    border-radius: 50%;
    border: none;
    background: var(--primary);
    color: white;
    cursor: pointer;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem; /* Reduced from 1.3rem */
    transition: var(--transition);
    position: relative;
}

.floating-app-btn:hover {
    transform: scale(1.08); /* Slightly reduced hover scale */
    box-shadow: 0 5px 14px rgba(0, 0, 0, 0.2); /* Reduced shadow */
}

/* Different colors for each app button */
.floating-app-btn.chat {
    background: var(--success);
}

.floating-app-btn.todo-list {
    background: var(--danger);
}

.floating-app-btn.daily-todo {
    background: var(--warning);
}

.floating-app-btn.flock {
    background: #4A34A6;
}

.floating-app-btn.timestripe {
    background: #8B5CF6;
}

.floating-app-btn.pdca {
    background: #10B981;
}

/* NEW: Color for Q-Todo button */
.floating-app-btn.q-todo {
    background: #EC4899; /* Pink color */
}

/* NEW: Color for Dynalist button */
.floating-app-btn.dynalist {
    background: #059669; /* Emerald color */
}

/* NEW: Color for remnote button */
.floating-app-btn.remnote {
    background: lightblue; /* Pink color */
}

/* Tooltip styles */
.floating-app-btn::after {
    content: attr(title);
    position: absolute;
    right: 55px; /* Adjusted for smaller button */
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 6px 10px; /* Slightly smaller */
    border-radius: 5px;
    font-size: 0.75rem; /* Smaller font */
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    pointer-events: none;
    z-index: 1003;
}

.floating-app-btn:hover::after {
    opacity: 1;
    visibility: visible;
}

/* Project Review button */
.floating-app-btn.project-review {
    background: #6D28D9;
}

        /* Editable fields in history table */
        .editable-field {
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px 6px;
            transition: var(--transition);
            min-height: 24px;
            width: 100%;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            resize: none;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            vertical-align: top;
        }

        .editable-field:hover {
            border-color: var(--gray-light);
            background-color: rgba(67, 97, 238, 0.03);
        }

        .editable-field:focus {
            border-color: var(--primary);
            background-color: white;
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .editable-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .history-save-indicator {
            font-size: 0.7rem;
            color: var(--success);
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            height: 14px;
            font-style: italic;
        }

        .history-save-indicator.visible {
            opacity: 1;
        }

        /* Quick Note Modal Styles */
        .modal-notes-input {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.5;
            resize: vertical;
            transition: var(--transition);
            min-height: 200px;
            white-space: pre-wrap;
        }

        .modal-notes-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .modal-notes-input::placeholder {
            color: var(--gray);
            opacity: 0.7;
        }

        /* Make the quick note modal more spacious */
        #quick-note-modal .modal {
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        #quick-note-modal .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Kanban Board Styles */
        .work-kanban-area {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--dark);
        }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }

        .kanban-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .kanban-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .kanban-filter {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            flex: 1;
            overflow: hidden;
            min-height: 500px;
        }

        .kanban-column {
            background: var(--light);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .kanban-column-header {
            padding: 15px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-column-header .task-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .kanban-column-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            min-height: 400px;
            max-height: 600px;
        }

        .kanban-task {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            cursor: grab;
            transition: var(--transition);
            position: relative;
        }

        .kanban-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .kanban-task:active {
            cursor: grabbing;
        }

        .kanban-task.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
        }

        .kanban-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .kanban-task-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            flex: 1;
        }

        .kanban-task-project {
            font-size: 0.8rem;
            color: var(--gray);
            background: var(--light);
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .kanban-task-notes {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 8px;
            padding: 8px;
            background: var(--light);
            border-radius: 4px;
            max-height: 80px;
            overflow: hidden;
        }

        .kanban-task-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            opacity: 0;
            transition: var(--transition);
        }

        .kanban-task:hover .kanban-task-actions {
            opacity: 1;
        }

        .kanban-task-action {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 0.8rem;
            padding: 4px;
            border-radius: 3px;
            transition: var(--transition);
        }

        .kanban-task-action:hover {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        .kanban-column.over {
            background: rgba(67, 97, 238, 0.05);
            border: 2px dashed var(--primary);
        }

        /* Column-specific colors */
        .kanban-column[data-status="backlog"] .kanban-column-header {
            background: var(--gray);
        }

        .kanban-column[data-status="working"] .kanban-column-header {
            background: var(--warning);
        }

        .kanban-column[data-status="review"] .kanban-column-header {
            background: var(--success);
        }

        .kanban-column[data-status="completed"] .kanban-column-header {
            background: var(--success);
        }

        .kanban-task[data-status="backlog"] {
            border-left-color: var(--gray);
        }

        .kanban-task[data-status="working"] {
            border-left-color: var(--warning);
        }

        .kanban-task[data-status="review"] {
            border-left-color: var(--success);
        }

        .kanban-task[data-status="completed"] {
            border-left-color: var(--success);
            opacity: 0.8;
        }

        .kanban-task.completed .kanban-task-name {
            text-decoration: line-through;
            color: var(--gray);
        }

        /* Empty state for columns */
        .kanban-column-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
            font-style: italic;
        }

        .kanban-column-empty i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .kanban-board {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .kanban-board {
                grid-template-columns: 1fr;
            }
            
            .kanban-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .kanban-controls {
                justify-content: space-between;
            }
        }

        /* History Filter Styles */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
            flex-wrap: wrap;
            gap: 15px;
        }

        .history-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .history-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 0;
        }

        .history-filter {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            min-width: 120px;
        }

        .history-filter:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .history-stats {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive design for history filters */
        @media (max-width: 768px) {
            .history-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .history-filters {
                justify-content: space-between;
            }
            
            .filter-group {
                flex: 1;
                min-width: 120px;
            }
            
            .history-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .history-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: auto;
            }
            
            .history-stats {
                grid-template-columns: 1fr;
            }
        }

        /* FIXED: History table cell alignment and spacing */
        .work-history-area table td {
            vertical-align: top !important;
            padding-top: 8px !important;
            padding-bottom: 8px !important;
        }

        /* Specifically ensure task notes, work notes, and ideas align to top with no extra space */
        .task-notes-cell,
        .work-notes-cell,
        .ideas-cell {
            vertical-align: top !important;
        }

        /* Ensure editable fields within table cells align to top with no extra space */
        .task-notes-cell .editable-field,
        .work-notes-cell .editable-field,
        .ideas-cell .editable-field {
            vertical-align: top !important;
            padding-top: 0 !important;
            margin-top: 0 !important;
            min-height: 60px;
            white-space: pre-wrap !important;
            line-height: 1.4;
        }

        /* Remove extra spacing from task notes in history */
        .task-notes-cell .editable-field {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }

        .task-note-bullet {
            margin-bottom: 4px;
            padding-left: 10px;
            position: relative;
            display: block;
        }

        .task-note-bullet:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        /* Fix session details cell alignment */
        .session-details-cell .editable-field {
            margin-bottom: 4px;
            padding-top: 0;
            min-height: auto;
        }

        /* Ensure proper line breaks in all text areas */
        .notes-textarea-large,
        .modal-notes-input,
        .editable-field[data-field="workNotes"],
        .editable-field[data-field="taskNotes"],
        .editable-field[data-field="ideas"] {
            white-space: pre-wrap !important;
            word-wrap: break-word;
            line-height: 1.5;
        }

        /* NEW: Task name header in task notes */
        .task-notes-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.9rem;
        }

        /* NEW: Compact ideas display */
        .ideas-cell .editable-field {
            padding: 0 !important;
            margin: 0 !important;
        }

        .idea-content-compact {
            white-space: pre-wrap;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        .idea-item-compact {
            margin-bottom: 8px;
            padding: 0;
            background: none;
            border: none;
        }

        /* NEW: Working task display in session details */
        .working-task-display {
            background: rgba(67, 97, 238, 0.05);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 3px solid var(--primary);
        }

        .working-task-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        /* NEW: Compact ideas display - FIXED spacing */
        .ideas-cell .editable-field {
            padding: 0 !important;
            margin: 0 !important;
            min-height: 60px;
        }

        .idea-content-compact {
            white-space: pre-wrap;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        .idea-item-compact {
            margin-bottom: 12px;
            padding: 0;
            background: none;
            border: none;
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 8px;
        }

        .idea-item-compact:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Remove any extra spacing from the ideas cell */
        .ideas-cell {
            padding-top: 8px !important;
            padding-bottom: 8px !important;
        }

        /* Checkbox and Bullet Formatting Styles */
        .notes-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            padding: 2px 4px;
            border-radius: 4px;
            transition: var(--transition);
            cursor: pointer;
        }

        .notes-checkbox:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        .notes-checkbox-input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            margin: 0;
            cursor: pointer;
        }

        .notes-bullet {
            display: block;
            margin: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .notes-bullet:before {
            content: "•";
            position: absolute;
            left: 8px;
            color: var(--primary);
            font-weight: bold;
        }

        /* Formatting toolbar styles */
        .formatting-toolbar {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: var(--light);
            border-radius: 6px;
            border: 1px solid var(--gray-light);
        }

        .formatting-toolbar .icon-btn {
            background: white;
            border: 1px solid var(--gray-light);
            padding: 6px 8px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .formatting-toolbar .icon-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        /* Custom checkbox styling for better appearance */
        .custom-checkbox-container {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--gray-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .custom-checkbox-container:hover {
            background: rgba(67, 97, 238, 0.05);
            border-color: var(--primary-light);
        }

        .custom-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .custom-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .custom-checkbox.checked:after {
            content: "✓";
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .custom-checkbox-text {
            flex: 1;
            font-size: 0.9rem;
        }

        /* Notes Preview Tabs */
        .notes-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .notes-tab {
            padding: 8px 16px;
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .notes-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .notes-tab:hover:not(.active) {
            background: var(--gray-light);
        }

        .notes-preview-content .completed {
            text-decoration: line-through;
            color: var(--gray);
        }

        /* Idea Tabs */
        .idea-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .idea-tab {
            padding: 6px 12px;
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .idea-tab.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .idea-tab:hover:not(.active) {
            background: var(--gray-light);
        }

        /* Idea actions header */
        .ideas-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Make idea textarea full width */
        .idea-textarea {
            flex: 1;
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 0.95rem;
            min-height: 100px;
            resize: vertical;
            box-sizing: border-box;
        }

        .idea-textarea:focus {
            border-color: var(--success);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
        }

        /* NEW: Color for Project Review button */
        .floating-app-btn.project-review {
            background: #6D28D9;
        }

        /* Project Review Modal Styles */
        .review-stats {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .review-stat-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .review-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .review-stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .review-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }

        .review-tab {
            padding: 10px 16px;
            background: var(--light);
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray);
            transition: var(--transition);
        }

        .review-tab.active {
            background: var(--primary);
            color: white;
        }

        .review-tab:hover:not(.active) {
            background: var(--gray-light);
            color: var(--dark);
        }

        .review-tab-content {
            display: none;
        }

        .review-tab-content.active {
            display: block;
        }

        .review-task-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .review-task-item:hover {
            background: var(--gray-light);
            transform: translateX(5px);
        }

        .review-task-item.selected {
            background: rgba(67, 97, 238, 0.1);
            border-left-color: var(--success);
        }

        .review-task-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .review-task-details {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .review-notes-content, .review-ideas-list, .review-history-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
        }

        .review-history-item {
            padding: 10px;
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 8px;
        }

        .review-history-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Fix for Project Review modal text colors */
        #project-review-modal .review-notes-content,
        #project-review-modal .review-ideas-list,
        #project-review-modal .review-history-list,
        #project-review-modal .review-task-list {
            color: var(--dark) !important;
        }

        #project-review-modal .review-notes-content div,
        #project-review-modal .review-ideas-list div,
        #project-review-modal .review-history-list div {
            color: var(--dark) !important;
        }

        /* Ensure formatted notes have proper colors */
        #project-review-modal .notes-checkbox,
        #project-review-modal .notes-bullet,
        #project-review-modal .custom-checkbox-container,
        #project-review-modal .custom-checkbox-text {
            color: var(--dark) !important;
        }

        #project-review-modal .review-task-item {
            color: var(--dark) !important;
        }

        #project-review-modal .review-task-name {
            color: var(--primary) !important;
        }

        #project-review-modal .review-task-details {
            color: var(--gray) !important;
        }

        /* Project Review Modal Backdrop Closing */
        #project-review-modal {
            cursor: pointer;
        }

        #project-review-modal .modal {
            cursor: auto;
        }

        /* Fix Task Management Modal Project Title Colors */
        #task-management-modal .project-name {
            color: var(--dark) !important;
            font-weight: 600;
        }

        #task-management-modal .task-project {
            color: var(--primary) !important;
            font-weight: 500;
        }

        /* Ensure all text in task management modal is readable */
        #task-management-modal .task-name {
            color: var(--dark) !important;
            font-weight: 600;
        }

        #task-management-modal .task-notes {
            color: var(--gray) !important;
        }

        #task-management-modal .status-badge {
            color: white !important;
        }

        #task-management-modal .task-note-line {
            color: var(--dark) !important;
        }

        /* Fix subtasks text colors */
        #task-management-modal .subtasks-section {
            color: var(--dark) !important;
        }

        #task-management-modal .subtask-name {
            color: var(--dark) !important;
        }

        #task-management-modal .subtasks-header {
            color: var(--dark) !important;
        }

        /* Instance indicator */
        .instance-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        /* Instance switch button in header */
        .app-action-btn.instance-switch {
            background: var(--warning);
        }

        .app-action-btn.instance-switch:hover {
            background: #e6890e;
        }

        /* Instance modal specific styles */
        #instance-modal .modal {
            max-width: 500px;
        }

        .instance-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .instance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .instance-item:hover {
            background: var(--gray-light);
        }

        .instance-item.current {
            background: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary);
        }

        .instance-name {
            font-weight: 500;
            color: var(--dark);
        }

        .instance-stats {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .instance-actions {
            display: flex;
            gap: 5px;
        }

/* Subtasks Styles */
.subtasks-section {
    margin-top: 10px;
    padding: 10px;
    background: rgba(67, 97, 238, 0.03);
    border-radius: 6px;
    border-left: 3px solid var(--primary-light);
}

.subtasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.subtasks-header strong {
    font-size: 0.85rem;
    color: var(--primary);
}

.add-subtask-btn {
    font-size: 0.8rem;
    padding: 2px 6px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: var(--transition);
}

.add-subtask-btn:hover {
    background: var(--primary-light);
}

.subtask-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    padding: 6px;
    background: white;
    border-radius: 4px;
    border: 1px solid var(--gray-light);
}

.subtask-input {
    flex: 1;
    padding: 4px 8px;
    border: 1px solid var(--gray-light);
    border-radius: 4px;
    font-size: 0.85rem;
    transition: var(--transition);
}

.subtask-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
}

.delete-subtask-btn {
    color: var(--danger);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: var(--transition);
}

.delete-subtask-btn:hover {
    background: rgba(247, 37, 133, 0.1);
}

.subtask-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--primary);
    cursor: pointer;
}

.subtask-item.completed .subtask-input {
    text-decoration: line-through;
    color: var(--gray);
}

/* Current Task Subtasks Styles */
.current-task-subtasks {
    margin-top: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    border-left: 4px solid var(--warning);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.current-subtasks-list {
    max-height: 200px;
    overflow-y: auto;
    padding-right: 5px;
}

.current-subtasks-list::-webkit-scrollbar {
    width: 6px;
}

.current-subtasks-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
}

.current-subtasks-list::-webkit-scrollbar-thumb {
    background: var(--warning);
    border-radius: 3px;
}

.current-subtask-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid var(--gray-light);
    transition: var(--transition);
}

.current-subtask-item:hover {
    background: rgba(67, 97, 238, 0.05);
    border-color: var(--primary-light);
    transform: translateX(2px);
}

.current-subtask-item.completed {
    background: rgba(76, 201, 240, 0.1);
    border-color: var(--success);
}

.current-subtask-name {
    flex: 1;
    font-size: 0.9rem;
    cursor: pointer;
    padding: 2px 0;
    transition: var(--transition);
}

.current-subtask-name:hover {
    color: var(--primary);
}

.edit-subtask-input {
    flex: 1;
    padding: 6px 10px;
    border: 2px solid var(--primary) !important;
    border-radius: 4px;
    font-size: 0.9rem;
    outline: none;
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

#add-subtask-current {
    font-size: 0.8rem;
    padding: 4px 8px;
    background: var(--warning);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: var(--transition);
}

#add-subtask-current:hover {
    background: #e6890e;
    transform: translateY(-1px);
}

.delete-current-subtask {
    color: var(--danger);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: var(--transition);
    opacity: 0.7;
}

.delete-current-subtask:hover {
    background: rgba(247, 37, 133, 0.1);
    opacity: 1;
    transform: scale(1.1);
}

/* Kanban Subtasks Styles */
.kanban-subtasks {
    margin-top: 10px;
    padding: 10px;
    background: rgba(248, 150, 30, 0.05);
    border-radius: 6px;
    border-left: 3px solid var(--warning);
}

.kanban-subtask-list {
    max-height: 100px;
    overflow-y: auto;
    padding-right: 5px;
}

.kanban-subtask-list::-webkit-scrollbar {
    width: 4px;
}

.kanban-subtask-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 2px;
}

.kanban-subtask-list::-webkit-scrollbar-thumb {
    background: var(--warning);
    border-radius: 2px;
}

.kanban-subtask-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    padding: 4px;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    transition: var(--transition);
}

.kanban-subtask-item:hover {
    background: rgba(67, 97, 238, 0.05);
    transform: translateX(2px);
}

.kanban-subtask-item.completed {
    background: rgba(76, 201, 240, 0.1);
}

.kanban-subtask-action {
    padding: 6px;
    background: var(--warning);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.kanban-subtask-action:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.kanban-subtask-action[data-action="toggle"] {
    background: var(--primary-light);
}

.kanban-subtask-action[data-action="add"]:hover {
    background: #e6890e;
}

.kanban-subtask-action[data-action="toggle"]:hover {
    background: var(--primary);
}

/* Instance Quick Switch Styles */
.instance-quick-switch {
    margin-top: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.instance-quick-select {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.9rem;
    min-width: 150px;
    cursor: pointer;
}

.instance-quick-select option {
    background: var(--dark);
    color: white;
}

.quick-switch-btn {
    background: var(--warning);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    margin-left: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
}

.quick-switch-btn:hover {
    background: #e6890e;
    transform: translateY(-1px);
}

.recent-instances-bar {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    margin: 10px 0;
    border-radius: 8px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.recent-instances-bar span.label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-right: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.recent-instance-btn {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
}

.recent-instance-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
}

.recent-instance-btn.current {
    background: var(--warning);
    color: white;
    border-color: var(--warning);
}

.recent-instance-btn.favorite {
    background: rgba(255, 215, 0, 0.2);
    border-color: gold;
}

.recent-instance-btn.favorite::before {
    content: "★";
    color: gold;
    font-size: 0.7rem;
}

/* Instance Templates in Modal */
.instance-templates {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 15px 0;
}

.instance-template-btn {
    background: var(--light);
    border: 1px solid var(--gray-light);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: var(--transition);
    flex: 1;
    min-width: 120px;
}

.instance-template-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: translateY(-2px);
}

.instance-search-box {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid var(--gray-light);
    border-radius: 6px;
    font-size: 0.9rem;
}

.instance-search-box:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
}

.batch-operations {
    margin-top: 20px;
    padding: 15px;
    background: var(--light);
    border-radius: 8px;
}

.batch-operations h4 {
    margin-bottom: 10px;
    color: var(--primary);
}

.batch-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.batch-btn {
    font-size: 0.85rem;
    padding: 6px 12px;
}

.instance-usage-stats {
    font-size: 0.8rem;
    color: var(--gray);
    margin-left: 8px;
}

    </style>
</head>
<body>
    <!-- Instance Indicator -->
    <div class="instance-indicator" id="instance-indicator">
        <i class="fas fa-layer-group"></i> Instance: <span id="current-instance">Default</span>
    </div>

    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-briefcase"></i>
                <h1>FlowFocus Work Mode</h1>
            </div>
            <p class="tagline">Deep work environment with integrated task and project management</p>
            
            <!-- Instance Quick Switch -->
            <div class="instance-quick-switch">
                <select id="instance-quick-select" class="instance-quick-select">
                    <option value="default">Default Instance</option>
                </select>
                <button id="quick-switch-btn" class="quick-switch-btn">
                    <i class="fas fa-exchange-alt"></i> Quick Switch
                </button>
            </div>
            
            <!-- Recent Instances Bar -->
            <div class="recent-instances-bar" id="recent-instances-bar">
                <span class="label">
                    <i class="fas fa-clock"></i> Recent:
                </span>
                <!-- Recent instances will be populated here -->
            </div>
            
            <div class="app-actions">
                <button class="app-action-btn" id="manage-projects-btn">
                    <i class="fas fa-folder"></i> Manage Projects
                </button>
                <button class="app-action-btn" id="manage-tasks-btn">
                    <i class="fas fa-tasks"></i> Manage Tasks
                </button>
                <button class="app-action-btn" id="settings-btn">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="app-action-btn instance-switch" id="switch-instance-btn">
                    <i class="fas fa-exchange-alt"></i> Switch Instance
                </button>
            </div>
        </header>

        <!-- Work Mode Container -->
        <div class="work-mode-active" id="work-mode-overlay">
            <div class="work-header">
                <div class="work-header-left">
                    <div class="work-timer-display" id="work-header-timer">25:00</div>
                    <div class="work-mode-indicator" id="work-header-mode">Focus Time</div>
                    
                    <!-- Project Dropdown -->
                    <div class="work-dropdown">
                        <select class="work-dropdown-select" id="work-project-select">
                            <option value="General">Project: General</option>
                        </select>
                    </div>

                    <!-- Task Dropdown -->
                    <div class="work-dropdown">
                        <select class="work-dropdown-select" id="work-task-select">
                            <option value="">Task: Select a task</option>
                        </select>
                    </div>
                    
                    <div class="work-timer-controls">
                        <button class="work-timer-btn" id="work-start-btn">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="work-timer-btn" id="work-pause-btn">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="work-timer-btn" id="work-skip-btn">
                            <i class="fas fa-forward"></i> Skip
                        </button>
                        
                        <!-- Expand Time Button -->
                        <div class="expand-time-dropdown">
                            <button class="expand-time-btn">
                                <i class="fas fa-plus-circle"></i> Expand Time
                            </button>
                            <div class="expand-time-dropdown-content">
                                <a href="#" id="expand-5-min">+5 Minutes</a>
                                <a href="#" id="expand-10-min">+10 Minutes</a>
                                <a href="#" id="expand-15-min">+15 Minutes</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="work-controls">
                    <button class="work-timer-btn" id="save-session-btn">
                        <i class="fas fa-save"></i> Save Session
                    </button>
                </div>
            </div>

            <div class="work-main-content">
                <div class="work-content-area">
                    <div class="work-tabs">
                        <button class="work-tab active" data-tab="work-tasks">Current Task</button>
                        <button class="work-tab" data-tab="work-kanban">Kanban Board</button>
                        <button class="work-tab" data-tab="work-history">Session History</button>
                        <button class="work-tab" data-tab="work-notes">Work Notes & Ideas</button>
                    </div>
                    
                    <div class="work-tab-content active" id="work-tasks">
                        <div class="work-task-area">
                            <div class="work-current-task">
                                <h3>Current Focus Task</h3>
                                <div id="work-current-task-name">No task selected</div>
                                <div class="work-task-stats">
                                    <div class="work-task-stat">
                                        <div class="work-task-stat-value" id="work-task-focus-time">0 min</div>
                                        <div class="work-task-stat-label">Focus Time</div>
                                    </div>
                                    <div class="work-task-stat">
                                        <div class="work-task-stat-value" id="work-task-completed">0</div>
                                        <div class="work-task-stat-label">Completed</div>
                                    </div>
                                    <div class="work-task-stat">
                                        <div class="work-task-stat-value" id="work-task-total">0</div>
                                        <div class="work-task-stat-label">Total Tasks</div>
                                    </div>
                                </div>
                            </div>
                            <h3>Task List</h3>
                            <div class="task-list" id="work-task-list">
                                <!-- Tasks will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="work-tab-content" id="work-kanban">
                        <div class="work-kanban-area">
                            <div class="kanban-header">
                                <h3>Project Kanban Board</h3>
                                <div class="kanban-controls">
                                    <select id="kanban-project-filter" class="kanban-filter">
                                        <option value="all">All Projects</option>
                                    </select>
                                    <button class="btn btn-primary" id="refresh-kanban">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="kanban-board" id="kanban-board">
                                <!-- Kanban columns will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="work-tab-content" id="work-history">
                        <div class="work-history-area">
                            <div class="history-header">
                                <h3>Session History</h3>
                                <div class="history-filters">
                                    <div class="filter-group">
                                        <label for="history-project-filter">Project:</label>
                                        <select id="history-project-filter" class="history-filter">
                                            <option value="all">All Projects</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label for="history-task-filter">Task:</label>
                                        <select id="history-task-filter" class="history-filter">
                                            <option value="all">All Tasks</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label for="history-date-filter">Date Range:</label>
                                        <select id="history-date-filter" class="history-filter">
                                            <option value="all">All Time</option>
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-secondary" id="clear-history-filters">
                                        <i class="fas fa-times"></i> Clear Filters
                                    </button>
                                </div>
                            </div>
                            <div class="history-stats" id="history-stats">
                                <!-- Stats will be populated here -->
                            </div>
                            <div class="records-table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="col-date">Date</th>
                                            <th class="col-project">Project</th>
                                            <th class="col-session-details">Session Details</th>
                                            <th class="col-task-notes">Task Notes</th>
                                            <th class="col-work-notes">Work Notes</th>
                                            <th class="col-ideas">Ideas</th>
                                            <th class="col-actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="work-history-table">
                                        <!-- History rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="work-tab-content" id="work-notes">
                        <div class="work-notes-area">
                            <div class="notes-ideas-grid">
                                <div class="notes-column">
                                    <div class="notes-column-header">
                                        <h3>Work Notes</h3>
                                        <div class="notes-actions">
                                            <!-- Formatting Toolbar -->
                                            <div class="formatting-toolbar">
                                                <button class="icon-btn" id="insert-checkbox" title="Insert Checkbox">
                                                    <i class="far fa-square"></i>
                                                </button>
                                                <button class="icon-btn" id="insert-bullet" title="Insert Bullet Point">
                                                    <i class="fas fa-circle"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-primary" id="save-work-notes">
                                                <i class="fas fa-save"></i> Save
                                            </button>
                                            <button class="btn btn-secondary" id="clear-work-notes">
                                                <i class="fas fa-broom"></i> Clear
                                            </button>
                                            <span class="save-indicator" id="work-notes-save-indicator">
                                                <i class="fas fa-circle"></i>
                                                <span class="save-text">Saved</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="notes-column-content">
                                        <div class="notes-tabs">
                                            <button class="notes-tab active" data-notes-tab="edit">Edit</button>
                                            <button class="notes-tab" data-notes-tab="preview">Preview</button>
                                        </div>
                                        <div class="notes-edit-view active" id="notes-edit-view">
                                            <textarea class="notes-textarea-large" id="work-notes-input" placeholder="Add notes about your work session... Use [ ] for checkboxes and • for bullet points"></textarea>
                                        </div>
                                        <div class="notes-preview-view" id="notes-preview-view">
                                            <div class="notes-preview-content" id="notes-preview-content">
                                                <!-- Formatted notes will appear here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ideas-column">
                                    <div class="ideas-column-header">
                                        <h3>Ideas & Insights</h3>
                                        <div class="ideas-actions">
                                            <!-- Idea Formatting Toolbar -->
                                            <div class="formatting-toolbar">
                                                <button class="icon-btn" id="insert-idea-checkbox" title="Insert Checkbox">
                                                    <i class="far fa-square"></i>
                                                </button>
                                                <button class="icon-btn" id="insert-idea-bullet" title="Insert Bullet Point">
                                                    <i class="fas fa-circle"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-secondary" id="clear-ideas">
                                                <i class="fas fa-broom"></i> Clear All
                                            </button>
                                        </div>
                                    </div>
                                    <div class="ideas-column-content">
                                        <div class="idea-input-container">
                                            <div class="idea-tabs">
                                                <button class="idea-tab active" data-idea-tab="edit">Edit</button>
                                                <button class="idea-tab" data-idea-tab="preview">Preview</button>
                                            </div>
                                            <div class="idea-edit-view active" id="idea-edit-view">
                                                <textarea class="idea-textarea" id="idea-input" placeholder="Add a new idea or insight... Use [ ] for checkboxes and • for bullet points"></textarea>
                                                <button class="btn btn-success" id="add-idea">
                                                    <i class="fas fa-plus"></i> Add Idea
                                                </button>
                                            </div>
                                            <div class="idea-preview-view" id="idea-preview-view">
                                                <div class="idea-preview-content" id="idea-preview-content">
                                                    <!-- Formatted idea will appear here -->
                                                </div>
                                                <button class="btn btn-success" id="add-idea-from-preview">
                                                    <i class="fas fa-plus"></i> Add This Idea
                                                </button>
                                            </div>
                                        </div>
                                        <div class="ideas-list-container" id="ideas-list">
                                            <!-- Ideas will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Clear All Button -->
                            <div class="clear-all-container">
                                <button class="btn btn-danger" id="clear-all-notes-ideas">
                                    <i class="fas fa-trash-alt"></i> Clear All Notes & Ideas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>FlowFocus Work Mode &copy; 2025 Dr. Wen-Ming Yang. All rights reserved v2.1 (Remnote floating buttons) | Instance: <span id="footer-instance">Default</span></p>
        </footer>
    </div>

    <!-- Instance Switch Modal -->
    <div class="modal-overlay" id="instance-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Switch Instance</h3>
                <button class="modal-close" id="close-instance-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="instance-search-box" class="instance-search-box" placeholder="Search instances...">
                
                <div class="instance-templates">
                    <button class="instance-template-btn" data-template="work">
                        <i class="fas fa-briefcase"></i> Work
                    </button>
                    <button class="instance-template-btn" data-template="personal">
                        <i class="fas fa-home"></i> Personal
                    </button>
                    <button class="instance-template-btn" data-template="study">
                        <i class="fas fa-graduation-cap"></i> Study
                    </button>
                    <button class="instance-template-btn" data-template="project">
                        <i class="fas fa-project-diagram"></i> Project
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="instance-select">Select Instance:</label>
                    <select id="instance-select" class="task-input">
                        <option value="default">Default</option>
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="grants">Grants</option>
                        <option value="class">Class</option>
                        <option value="project-a">Project A</option>
                        <option value="project-b">Project B</option>
                        <option value="lab">Lab</option>
                        <option value="backup">Backup</option>
                    </select>
                    <p style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">
                        Each instance has completely separate data storage.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="new-instance-name">Or Create New Instance:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-instance-name" placeholder="Enter instance name" style="flex: 1;">
                        <button class="btn btn-primary" id="create-instance-btn">
                            <i class="fas fa-plus"></i> Create
                        </button>
                    </div>
                </div>
                
                <div class="settings-group" style="margin-top: 20px;">
                    <h4>Instance Management</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="export-instance-data">
                            <i class="fas fa-download"></i> Export This Instance
                        </button>
                        <button class="btn btn-info" id="import-instance-data">
                            <i class="fas fa-upload"></i> Import to This Instance
                        </button>
                        <button class="btn btn-danger" id="delete-instance-data">
                            <i class="fas fa-trash"></i> Delete This Instance
                        </button>
                    </div>
                </div>
                
                <div class="batch-operations">
                    <h4>Batch Operations</h4>
                    <div class="batch-buttons">
                        <button class="btn btn-secondary batch-btn" id="export-all-instances">
                            <i class="fas fa-download"></i> Export All
                        </button>
                        <button class="btn btn-secondary batch-btn" id="close-all-instances">
                            <i class="fas fa-window-close"></i> Close All Tabs
                        </button>
                        <button class="btn btn-secondary batch-btn" id="refresh-instance-list">
                            <i class="fas fa-sync-alt"></i> Refresh List
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-instance">Cancel</button>
                <button class="btn btn-primary" id="switch-instance">Switch</button>
            </div>
        </div>
    </div>

    <!-- Project Management Modal (copy from original) -->
    <div class="modal-overlay" id="project-management-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Project Management</h3>
                <button class="modal-close" id="close-project-management-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-project-name">Create New Project</label>
                    <div class="add-project-form">
                        <input type="text" class="add-project-input" id="new-project-name" placeholder="Enter project name">
                        <button class="btn btn-primary" id="create-project-btn">
                            <i class="fas fa-plus"></i> Create
                        </button>
                    </div>
                </div>
                <div class="project-list" id="standalone-project-list">
                    <!-- Projects will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-project-management">Close</button>
            </div>
        </div>
    </div>

    <!-- Task Management Modal (copy from original) -->
    <div class="modal-overlay" id="task-management-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Task Management</h3>
                <button class="modal-close" id="close-task-management-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-task-name">Create New Task</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="task-input" id="new-task-name" placeholder="Enter task name" style="flex: 2;">
                        <select id="new-task-project" class="task-input" style="flex: 1;">
                            <!-- Projects will be populated -->
                        </select>
                        <button class="btn btn-primary" id="create-task-btn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <textarea class="task-notes-input" id="new-task-notes" placeholder="Add notes for this task..." style="margin-top: 10px;"></textarea>
                </div>
                
                <div class="task-management-filters">
                    <select id="task-filter-project" class="task-input" style="flex: 1;">
                        <option value="all">All Projects</option>
                    </select>
                    <select id="task-filter-status" class="task-input" style="flex: 1;">
                        <option value="all">All Status</option>
                        <option value="backlog">Backlog</option>
                        <option value="working">Working</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                
                <div class="task-management-list" id="standalone-task-list">
                    <!-- Tasks will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-task-management">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (copy from original) -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" id="close-settings-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <h4>Timer Settings</h4>
                    <div class="form-group">
                        <label for="focus-time">Focus Time (minutes)</label>
                        <input type="number" id="focus-time" min="1" max="120" value="25">
                    </div>
                    <div class="form-group">
                        <label for="break-time">Break Time (minutes)</label>
                        <input type="number" id="break-time" min="1" max="60" value="5">
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Sound Settings</h4>
                    <div class="setting-item">
                        <span class="setting-label">Enable Notification Sounds</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Enable Ticking Sound</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="tick-sound-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Data Management</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="export-data-btn">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                        <button class="btn btn-info" id="import-data-btn">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        <button class="btn btn-danger" id="clear-data-btn">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-settings">Close</button>
                <button class="btn btn-primary" id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>

<!-- Quick Note Modal -->
<div class="modal-overlay" id="quick-note-modal">
    <div class="modal" style="max-width: 600px; max-height: 80vh;">
        <div class="modal-header">
            <h3 class="modal-title">Add Quick Note</h3>
            <button class="modal-close" id="close-quick-note-modal">&times;</button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <div class="modal-task-name" id="modal-task-name" style="font-weight: 600; color: var(--primary); margin-bottom: 15px; padding: 10px; background: var(--light); border-radius: 6px;">Task Name</div>
            <div style="flex: 1; display: flex; flex-direction: column; min-height: 300px;">
                <textarea class="modal-notes-input" id="modal-notes-input" placeholder="Add your notes here... (Use bullet points for better organization - start each line with - or *)" style="flex: 1; min-height: 250px; resize: vertical; white-space: pre-wrap;"></textarea>
                <p class="notes-help" style="margin-top: 10px; font-size: 0.85rem; color: var(--gray); text-align: center;">Tip: Use Shift+Enter for new lines, Enter to save</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-quick-note">Cancel</button>
            <button class="btn btn-primary" id="save-quick-note">Save Note</button>
        </div>
    </div>
</div>

    <!-- Project Review Modal (copy from original) -->
    <div class="modal-overlay" id="project-review-modal">
        <div class="modal" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">Project Review & Continuation</h3>
                <button class="modal-close" id="close-project-review-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Project Selection -->
                <div class="form-group">
                    <label for="review-project-select">Select Project to Review:</label>
                    <select id="review-project-select" class="task-input">
                        <option value="all">All Projects</option>
                    </select>
                </div>
                
                <!-- Quick Stats -->
                <div class="review-stats" id="review-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                    <!-- Stats will be populated here -->
                </div>
                
                <!-- Tabs for different content -->
                <div class="review-tabs" style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid var(--primary-light);">
                    <button class="review-tab active" data-review-tab="tasks">Current Tasks</button>
                    <button class="review-tab" data-review-tab="notes">Work Notes</button>
                    <button class="review-tab" data-review-tab="ideas">Ideas</button>
                    <button class="review-tab" data-review-tab="history">Recent History</button>
                </div>
                
                <!-- Tab Content -->
                <div class="review-content">
                    <!-- Tasks Tab -->
                    <div class="review-tab-content active" id="review-tasks" style="max-height: 400px; overflow-y: auto;">
                        <div class="review-task-list" id="review-task-list">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Notes Tab -->
                    <div class="review-tab-content" id="review-notes" style="max-height: 400px; overflow-y: auto; display: none;">
                        <div class="review-notes-content" id="review-notes-content">
                            <!-- Work notes will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Ideas Tab -->
                    <div class="review-tab-content" id="review-ideas" style="max-height: 400px; overflow-y: auto; display: none;">
                        <div class="review-ideas-list" id="review-ideas-list">
                            <!-- Ideas will be populated here -->
                        </div>
                    </div>
                    
                    <!-- History Tab -->
                    <div class="review-tab-content" id="review-history" style="max-height: 400px; overflow-y: auto; display: none;">
                        <div class="review-history-list" id="review-history-list">
                            <!-- Recent sessions will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="review-actions" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--gray-light);">
                    <h4 style="margin-bottom: 10px;">Quick Actions</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="continue-selected-task">
                            <i class="fas fa-play"></i> Continue Selected Task
                        </button>
                        <button class="btn btn-success" id="start-new-session">
                            <i class="fas fa-plus"></i> Start New Session
                        </button>
                        <button class="btn btn-secondary" id="copy-review-to-clipboard">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-project-review">Close</button>
            </div>
        </div>
    </div>

    <!-- Time Up Notification -->
    <div class="time-up-notification hidden" id="time-up-notification">
        Time's Up!
    </div>

    <!-- Floating App Buttons -->
<!-- Floating App Buttons -->
<div class="floating-app-buttons">
    <button class="floating-app-btn chat" id="open-chat-app" title="Open Self Chat">
        <i class="fas fa-comments"></i>
    </button>
    <button class="floating-app-btn todo-list" id="open-todo-list" title="Open Todo List">
        <i class="fas fa-tasks"></i>
    </button>
    <button class="floating-app-btn daily-todo" id="open-daily-todo" title="Open Daily Todo">
        <i class="fas fa-calendar-day"></i>
    </button>
    <button class="floating-app-btn q-todo" id="open-q-todo" title="Open Q-Todo">
        <i class="fas fa-check-square"></i>
    </button>
    <button class="floating-app-btn remnote" id="open-remnote" title="Open Remnote">
        <i class="fas fa-check-square"></i>
    </button>    
    <button class="floating-app-btn dynalist" id="open-dynalist" title="Open Dynalist">
        <i class="fas fa-list-alt"></i>
    </button>
    <button class="floating-app-btn flock" id="open-flock" title="Open Flock Team Chat">
        <i class="fas fa-users"></i>
    </button>
    <button class="floating-app-btn project-review" id="open-project-review" title="Project Review & Continuation">
        <i class="fas fa-clipboard-list"></i>
    </button>
    <button class="floating-app-btn timestripe" id="open-timestripe" title="Open TimeStripe Horizons">
        <i class="fas fa-stream"></i>
    </button>
    <button class="floating-app-btn pdca" id="open-pdca" title="Open PDCA Planner">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<script>
    // ========== INSTANCE CONFIGURATION ==========
    // Get instance from URL parameter or use default
    const urlParams = new URLSearchParams(window.location.search);
    let CURRENT_INSTANCE = urlParams.get('instance') || 'default';
    
    // Function to get storage key for current instance
    function getStorageKey() {
        return `flowfocus-workmode-data-${CURRENT_INSTANCE}`;
    }
    
    // Function to update instance display
    function updateInstanceDisplay() {
        document.getElementById('current-instance').textContent = CURRENT_INSTANCE;
        document.getElementById('footer-instance').textContent = CURRENT_INSTANCE;
        document.title = `FlowFocus Work Mode | Instance: ${CURRENT_INSTANCE}`;
    }
    
    // Function to switch to a new instance
    function switchInstance(newInstance) {
        // Save current state before switching
        saveData();
        
        // Update instance
        CURRENT_INSTANCE = newInstance;
        updateInstanceDisplay();
        
        // Update usage tracking
        trackInstanceUsage(newInstance);
        
        // Update recent instances
        updateRecentInstances(newInstance);
        
        // Reload data from new instance storage
        loadData();
        
        // Update UI
        updateWorkModeDisplay();
        updateProjectManagement();
        updateTaskManagement();
        updateWorkProjectDropdown();
        updateWorkTaskDropdown();
        updateKanbanBoard();
        updateHistoryFilters();
        
        // Update quick switch dropdown
        updateInstanceQuickSelect();
        
        // Update recent instances bar
        updateRecentInstancesBar();
        
        // Show confirmation
        showTemporaryMessage(`Switched to instance: ${CURRENT_INSTANCE}`, 'success');
    }
    
    // Function to export current instance data
    function exportInstanceData() {
        const data = {
            tasks,
            sessions,
            projects,
            workNotes,
            ideas,
            settings: {
                focusTime: parseInt(focusTimeInput.value),
                breakTime: parseInt(breakTimeInput.value),
                soundEnabled: soundToggle.checked,
                tickSoundEnabled: tickSoundToggle.checked
            },
            instance: CURRENT_INSTANCE
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        // Generate filename with instance name
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const filename = `Focusflow-${CURRENT_INSTANCE}-${year}${month}${day}.json`;
        
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showTemporaryMessage(`Instance "${CURRENT_INSTANCE}" exported!`, "success");
    }
    
    // Function to import data to current instance
    function importInstanceData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Load data into current instance
                    tasks = data.tasks || [];
                    sessions = data.sessions || [];
                    projects = data.projects || ['General'];
                    workNotes = data.workNotes || '';
                    ideas = data.ideas || [];
                    
                    // Ensure all existing tasks have a status
                    tasks.forEach(task => {
                        if (!task.status) {
                            task.status = 'backlog';
                        }
                    });
                    
                    if (data.settings) {
                        focusTimeInput.value = data.settings.focusTime || 25;
                        breakTimeInput.value = data.settings.breakTime || 5;
                        soundToggle.checked = data.settings.soundEnabled !== false;
                        tickSoundToggle.checked = data.settings.tickSoundEnabled !== false;
                    }
                    
                    // Update timer with loaded settings
                    timeLeft = parseInt(focusTimeInput.value) * 60;
                    totalTime = timeLeft;
                    updateTimerDisplay();
                    
                    // Update ALL UI components
                    updateWorkModeDisplay();
                    updateProjectManagement();
                    updateTaskManagement();
                    updateWorkProjectDropdown();
                    updateWorkTaskDropdown();
                    updateTaskManagementFilters();
                    
                    // Update work notes textarea
                    if (workNotesInput) {
                        workNotesInput.value = workNotes;
                    }
                    
                    // Update ideas list
                    updateIdeasList();
                    
                    // Save the loaded data
                    saveData();
                    
                    showTemporaryMessage(`Data imported to instance "${CURRENT_INSTANCE}"!`, "success");
                } catch (error) {
                    showTemporaryMessage("Error importing data file", "warning");
                    console.error("Error importing data:", error);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    // Function to delete current instance data
    function deleteInstanceData() {
        if (confirm(`Are you sure you want to DELETE ALL DATA for instance "${CURRENT_INSTANCE}"? This action cannot be undone.`)) {
            // Clear all data for current instance
            tasks = [];
            sessions = [];
            projects = ['General'];
            workNotes = '';
            ideas = [];
            
            // Reset to default settings
            focusTimeInput.value = 25;
            breakTimeInput.value = 5;
            soundToggle.checked = true;
            tickSoundToggle.checked = true;
            
            // Update timer
            timeLeft = 25 * 60;
            totalTime = timeLeft;
            updateTimerDisplay();
            
            // Update ALL UI components
            updateWorkModeDisplay();
            updateProjectManagement();
            updateTaskManagement();
            updateWorkProjectDropdown();
            updateWorkTaskDropdown();
            updateTaskManagementFilters();
            
            // Save cleared data
            saveData();
            
            showTemporaryMessage(`Instance "${CURRENT_INSTANCE}" data cleared!`, "success");
        }
    }
    
    // ========== NEW EASY INSTANCE FUNCTIONS ==========
    
    // Track favorite instances
    let favoriteInstances = JSON.parse(localStorage.getItem('flowfocus-favorite-instances')) || [];
    
    // Track recent instances
    let recentInstances = JSON.parse(localStorage.getItem('flowfocus-recent-instances')) || [];
    
    // Instance templates
    const instanceTemplates = {
        'work': { 
            projects: ['Work', 'Meetings', 'Reports'], 
            tasks: [{ name: 'Daily Standup', project: 'Meetings', status: 'working' }] 
        },
        'personal': { 
            projects: ['Personal', 'Home', 'Health'], 
            tasks: [{ name: 'Exercise', project: 'Health', status: 'backlog' }] 
        },
        'study': { 
            projects: ['Courses', 'Reading', 'Practice'], 
            tasks: [{ name: 'Review Notes', project: 'Courses', status: 'backlog' }] 
        },
        'project': { 
            projects: ['Planning', 'Development', 'Testing'], 
            tasks: [{ name: 'Project Setup', project: 'Planning', status: 'working' }] 
        }
    };
    
    // Track instance usage
    let instanceUsageStats = JSON.parse(localStorage.getItem('flowfocus-instance-usage')) || {};
    
    // Update instance quick select dropdown
    function updateInstanceQuickSelect() {
        const quickSelect = document.getElementById('instance-quick-select');
        if (!quickSelect) return;
        
        const currentValue = quickSelect.value;
        quickSelect.innerHTML = '';
        
        // Add favorites first with star
        favoriteInstances.forEach(instance => {
            const option = document.createElement('option');
            option.value = instance;
            option.textContent = `★ ${instance}`;
            option.selected = instance === CURRENT_INSTANCE;
            quickSelect.appendChild(option);
        });
        
        // Add separator if there are favorites
        if (favoriteInstances.length > 0) {
            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '──────────';
            quickSelect.appendChild(separator);
        }
        
        // Add all instances
        const allInstances = getAllInstances();
        allInstances.forEach(instance => {
            if (!favoriteInstances.includes(instance)) {
                const option = document.createElement('option');
                option.value = instance;
                option.textContent = instance;
                option.selected = instance === CURRENT_INSTANCE;
                quickSelect.appendChild(option);
            }
        });
        
        quickSelect.value = currentValue;
    }
    
    // Update recent instances bar
    function updateRecentInstancesBar() {
        const recentBar = document.getElementById('recent-instances-bar');
        if (!recentBar) return;
        
        // Clear existing buttons (keep the label)
        const label = recentBar.querySelector('.label');
        recentBar.innerHTML = '';
        if (label) recentBar.appendChild(label);
        
        // Add recent instances (max 5)
        const recentToShow = recentInstances.slice(0, 5);
        recentToShow.forEach(instance => {
            const btn = document.createElement('button');
            btn.className = 'recent-instance-btn';
            if (instance === CURRENT_INSTANCE) {
                btn.classList.add('current');
            }
            if (favoriteInstances.includes(instance)) {
                btn.classList.add('favorite');
            }
            btn.textContent = instance;
            btn.title = `Switch to ${instance} instance`;
            
            btn.addEventListener('click', () => {
                switchInstance(instance);
            });
            
            recentBar.appendChild(btn);
        });
    }
    
    // Update recent instances list
    function updateRecentInstances(instanceName) {
        // Remove if already exists
        recentInstances = recentInstances.filter(name => name !== instanceName);
        
        // Add to beginning
        recentInstances.unshift(instanceName);
        
        // Keep only last 10
        recentInstances = recentInstances.slice(0, 10);
        
        // Save to localStorage
        localStorage.setItem('flowfocus-recent-instances', JSON.stringify(recentInstances));
    }
    
    // Toggle favorite instance
    function toggleFavoriteInstance(instanceName) {
        if (favoriteInstances.includes(instanceName)) {
            favoriteInstances = favoriteInstances.filter(name => name !== instanceName);
            showTemporaryMessage(`Removed "${instanceName}" from favorites`, 'info');
        } else {
            favoriteInstances.push(instanceName);
            showTemporaryMessage(`Added "${instanceName}" to favorites`, 'success');
        }
        
        localStorage.setItem('flowfocus-favorite-instances', JSON.stringify(favoriteInstances));
        updateInstanceQuickSelect();
        updateRecentInstancesBar();
    }
    
    // Create instance from template
    function createInstanceFromTemplate(instanceName, templateName) {
        if (instanceExists(instanceName)) {
            showTemporaryMessage(`Instance "${instanceName}" already exists!`, 'warning');
            return false;
        }
        
        const template = instanceTemplates[templateName] || { projects: ['General'], tasks: [] };
        
        const instanceData = {
            tasks: template.tasks || [],
            sessions: [],
            projects: template.projects || ['General'],
            workNotes: '',
            ideas: [],
            settings: {
                focusTime: 25,
                breakTime: 5,
                soundEnabled: true,
                tickSoundEnabled: true
            },
            instance: instanceName
        };
        
        localStorage.setItem(`flowfocus-workmode-data-${instanceName}`, JSON.stringify(instanceData));
        updateInstanceList(instanceName);
        
        // Auto-switch to the new instance
        switchInstance(instanceName);
        
        return true;
    }
    
    // Get all instances
    function getAllInstances() {
        const defaultInstances = ['default', 'work', 'personal', 'grants', 'class', 'project-a', 'project-b', 'lab', 'backup'];
        const customInstances = JSON.parse(localStorage.getItem('flowfocus-instance-list')) || [];
        
        // Combine and deduplicate
        const allInstances = [...new Set([...defaultInstances, ...customInstances])];
        
        // Sort with favorites first, then alphabetically
        return allInstances.sort((a, b) => {
            const aIsFavorite = favoriteInstances.includes(a);
            const bIsFavorite = favoriteInstances.includes(b);
            
            if (aIsFavorite && !bIsFavorite) return -1;
            if (!aIsFavorite && bIsFavorite) return 1;
            
            return a.localeCompare(b);
        });
    }
    
    // Check if instance exists
    function instanceExists(instanceName) {
        const allInstances = getAllInstances();
        return allInstances.includes(instanceName);
    }
    
    // Quick save and switch
    function quickSaveAndSwitch() {
        saveData();
        const quickSelect = document.getElementById('instance-quick-select');
        if (quickSelect && quickSelect.value !== CURRENT_INSTANCE) {
            switchInstance(quickSelect.value);
        }
    }
    
    // Track instance usage
    function trackInstanceUsage(instanceName) {
        if (!instanceUsageStats[instanceName]) {
            instanceUsageStats[instanceName] = {
                firstUsed: new Date().toISOString(),
                lastUsed: new Date().toISOString(),
                useCount: 1
            };
        } else {
            instanceUsageStats[instanceName].lastUsed = new Date().toISOString();
            instanceUsageStats[instanceName].useCount++;
        }
        
        localStorage.setItem('flowfocus-instance-usage', JSON.stringify(instanceUsageStats));
    }
    
    // Generate instance URL
    function getInstanceUrl(instanceName) {
        const url = new URL(window.location);
        url.searchParams.set('instance', instanceName);
        return url.toString();
    }
    
    // Copy instance link
    function copyInstanceLink(instanceName) {
        const url = getInstanceUrl(instanceName);
        navigator.clipboard.writeText(url).then(() => {
            showTemporaryMessage(`Link to "${instanceName}" instance copied!`, 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showTemporaryMessage('Failed to copy to clipboard', 'warning');
        });
    }
    
    // Export all instances
    function exportAllInstances() {
        const allInstances = getAllInstances();
        const exportData = {};
        
        allInstances.forEach(instance => {
            const data = localStorage.getItem(`flowfocus-workmode-data-${instance}`);
            if (data) {
                exportData[instance] = JSON.parse(data);
            }
        });
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const filename = `Focusflow-All-Instances-${year}${month}${day}.json`;
        
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showTemporaryMessage(`All ${allInstances.length} instances exported!`, "success");
    }
    
    // Search instances in modal
    function searchInstances(searchTerm) {
        const instanceItems = document.querySelectorAll('.instance-item');
        const instanceSelect = document.getElementById('instance-select');
        
        if (instanceSelect) {
            Array.from(instanceSelect.options).forEach(option => {
                const matches = option.text.toLowerCase().includes(searchTerm.toLowerCase());
                option.style.display = matches ? '' : 'none';
            });
        }
        
        instanceItems.forEach(item => {
            const instanceName = item.querySelector('.instance-name').textContent.toLowerCase();
            if (instanceName.includes(searchTerm.toLowerCase())) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Initialize easy instance switching
    function initEasyInstanceSwitching() {
        // Load favorites and recent instances
        favoriteInstances = JSON.parse(localStorage.getItem('flowfocus-favorite-instances')) || [];
        recentInstances = JSON.parse(localStorage.getItem('flowfocus-recent-instances')) || [];
        instanceUsageStats = JSON.parse(localStorage.getItem('flowfocus-instance-usage')) || {};
        
        // Update UI
        updateInstanceQuickSelect();
        updateRecentInstancesBar();
        
        // Add current instance to recent if not already there
        updateRecentInstances(CURRENT_INSTANCE);
        
        // Track initial usage
        trackInstanceUsage(CURRENT_INSTANCE);
    }
    
    // ========== ORIGINAL VARIABLES ==========
    // DOM Elements
    const workHeaderTimer = document.getElementById('work-header-timer');
    const workHeaderMode = document.getElementById('work-header-mode');
    const workStartBtn = document.getElementById('work-start-btn');
    const workPauseBtn = document.getElementById('work-pause-btn');
    const workSkipBtn = document.getElementById('work-skip-btn');
    const workCurrentTaskName = document.getElementById('work-current-task-name');
    const workTaskFocusTime = document.getElementById('work-task-focus-time');
    const workTaskCompleted = document.getElementById('work-task-completed');
    const workTaskTotal = document.getElementById('work-task-total');
    const workTaskList = document.getElementById('work-task-list');
    const workHistoryTable = document.getElementById('work-history-table');
    const workNotesInput = document.getElementById('work-notes-input');
    const saveWorkNotes = document.getElementById('save-work-notes');
    const clearWorkNotes = document.getElementById('clear-work-notes');
    const ideaInput = document.getElementById('idea-input');
    const addIdea = document.getElementById('add-idea');
    const clearIdeas = document.getElementById('clear-ideas');
    const ideasList = document.getElementById('ideas-list');
    const workTabs = document.querySelectorAll('.work-tab');
    const workTabContents = document.querySelectorAll('.work-tab-content');
    const saveSessionBtn = document.getElementById('save-session-btn');
    
    // Project and Task Management Elements
    const workProjectSelect = document.getElementById('work-project-select');
    const workTaskSelect = document.getElementById('work-task-select');
    const manageProjectsBtn = document.getElementById('manage-projects-btn');
    const manageTasksBtn = document.getElementById('manage-tasks-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const switchInstanceBtn = document.getElementById('switch-instance-btn');
    
    // Instance modal elements
    const instanceModal = document.getElementById('instance-modal');
    const closeInstanceModal = document.getElementById('close-instance-modal');
    const closeInstance = document.getElementById('close-instance');
    const instanceSelect = document.getElementById('instance-select');
    const newInstanceName = document.getElementById('new-instance-name');
    const createInstanceBtn = document.getElementById('create-instance-btn');
    const switchInstanceBtnModal = document.getElementById('switch-instance');
    const exportInstanceDataBtn = document.getElementById('export-instance-data');
    const importInstanceDataBtn = document.getElementById('import-instance-data');
    const deleteInstanceDataBtn = document.getElementById('delete-instance-data');
    
    // New instance elements
    const instanceQuickSelect = document.getElementById('instance-quick-select');
    const quickSwitchBtn = document.getElementById('quick-switch-btn');
    const instanceSearchBox = document.getElementById('instance-search-box');
    const instanceTemplateBtns = document.querySelectorAll('.instance-template-btn');
    const exportAllInstancesBtn = document.getElementById('export-all-instances');
    const closeAllInstancesBtn = document.getElementById('close-all-instances');
    const refreshInstanceListBtn = document.getElementById('refresh-instance-list');
    
    // Expand time elements
    const expand5MinBtn = document.getElementById('expand-5-min');
    const expand10MinBtn = document.getElementById('expand-10-min');
    const expand15MinBtn = document.getElementById('expand-15-min');
    
    // Clear all notes & ideas
    const clearAllNotesIdeasBtn = document.getElementById('clear-all-notes-ideas');
    
    // Time Up Notification
    const timeUpNotification = document.getElementById('time-up-notification');
    
    // Auto-save elements
    const workNotesSaveIndicator = document.getElementById('work-notes-save-indicator');
    
    // Modal elements (other modals - these need to be defined in your HTML)
    const quickNoteModal = document.getElementById('quick-note-modal');
    const modalTaskName = document.getElementById('modal-task-name');
    const modalNotesInput = document.getElementById('modal-notes-input');
    const closeQuickNoteModal = document.getElementById('close-quick-note-modal');
    const cancelQuickNote = document.getElementById('cancel-quick-note');
    const saveQuickNote = document.getElementById('save-quick-note');
    
    // Settings elements
    const focusTimeInput = document.getElementById('focus-time');
    const breakTimeInput = document.getElementById('break-time');
    const soundToggle = document.getElementById('sound-toggle');
    const tickSoundToggle = document.getElementById('tick-sound-toggle');
    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const saveSettingsBtn = document.getElementById('save-settings');
    
    // Kanban elements
    const workKanbanTab = document.querySelector('[data-tab="work-kanban"]');
    const kanbanProjectFilter = document.getElementById('kanban-project-filter');
    const refreshKanbanBtn = document.getElementById('refresh-kanban');
    const kanbanBoard = document.getElementById('kanban-board');
    
    // History filter elements
    const historyProjectFilter = document.getElementById('history-project-filter');
    const historyTaskFilter = document.getElementById('history-task-filter');
    const historyDateFilter = document.getElementById('history-date-filter');
    const clearHistoryFiltersBtn = document.getElementById('clear-history-filters');
    const historyStats = document.getElementById('history-stats');
    
    // Timer state
    let timer;
    let isRunning = false;
    let isFocusMode = true;
    let timeLeft = 25 * 60;
    let totalTime = 25 * 60;
    let sessions = [];
    let tasks = [];
    let projects = ['General'];
    let currentTaskId = null;
    let currentSession = null;
    let workNotes = '';
    let ideas = [];
    let tickSound = null;
    let tickInterval = null;
    
    // Auto-save variables
    let workNotesSaveTimeout;
    let historySaveTimeouts = {};
    
    // ========== INITIALIZE APP ==========
    function init() {
        // Update instance display first
        updateInstanceDisplay();
        
        // Load all instances into dropdown
        loadAllInstances();
        
        // Initialize easy instance switching
        initEasyInstanceSwitching();
        
        // Then load data and initialize
        loadData();
        updateTimerDisplay();
        updateWorkModeDisplay();
        updateProjectManagement();
        updateTaskManagement();
        updateWorkProjectDropdown();
        updateWorkTaskDropdown();
        updateKanbanBoard();
        updateHistoryFilters();
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize auto-save functionality
        initAutoSave();
        
        // Initialize formatting
        setupCheckboxToggling();
        
        // Initialize project review
        updateProjectReviewDropdown();
        
        // Setup Project Review event listeners
        setupProjectReviewEventListeners();
        
        // Show welcome message with instance info
        setTimeout(() => {
            showTemporaryMessage(`Welcome to FlowFocus Instance: ${CURRENT_INSTANCE}`, 'success');
        }, 1000);
    }
    
    // ========== MODIFIED DATA FUNCTIONS ==========
    function saveData() {
        const data = {
            tasks,
            sessions,
            projects,
            workNotes,
            ideas,
            settings: {
                focusTime: parseInt(focusTimeInput.value),
                breakTime: parseInt(breakTimeInput.value),
                soundEnabled: soundToggle.checked,
                tickSoundEnabled: tickSoundToggle.checked
            },
            instance: CURRENT_INSTANCE
        };
        localStorage.setItem(getStorageKey(), JSON.stringify(data));
    }
    
    function loadData() {
        try {
            const data = JSON.parse(localStorage.getItem(getStorageKey()));
            
            if (data) {
                tasks = data.tasks || [];
                sessions = data.sessions || [];
                projects = data.projects || ['General'];
                workNotes = data.workNotes || '';
                ideas = data.ideas || [];
                
                // Ensure all existing tasks have a status AND subtasks
                tasks.forEach(task => {
                    if (!task.status) {
                        task.status = 'backlog';
                    }
                    if (!task.subtasks) {
                        task.subtasks = [];
                    }
                });
                
                if (data.settings) {
                    focusTimeInput.value = data.settings.focusTime || 25;
                    breakTimeInput.value = data.settings.breakTime || 5;
                    soundToggle.checked = data.settings.soundEnabled !== false;
                    tickSoundToggle.checked = data.settings.tickSoundEnabled !== false;
                }
                
                // Update timer with loaded settings
                timeLeft = parseInt(focusTimeInput.value) * 60;
                totalTime = timeLeft;
                updateTimerDisplay();
                
                // Update work notes textarea
                if (workNotesInput) {
                    workNotesInput.value = workNotes;
                }
                
                // Update ALL UI components on initial load
                updateTaskManagementFilters();
                updateIdeasList();
            }
        } catch (error) {
            console.error("Error loading data:", error);
            // Initialize with default values if loading fails
            tasks = [];
            sessions = [];
            projects = ['General'];
            workNotes = '';
            ideas = [];
        }
    }

    // Function to maintain a list of all instances
    function updateInstanceList(newInstance) {
        // Get existing instance list from localStorage
        let instanceList = JSON.parse(localStorage.getItem('flowfocus-instance-list')) || [];
        
        // Add new instance if not already in the list
        if (!instanceList.includes(newInstance)) {
            instanceList.push(newInstance);
            localStorage.setItem('flowfocus-instance-list', JSON.stringify(instanceList));
        }
    }

    // Function to load all instances into the dropdown
    function loadAllInstances() {
        // Get instance list from localStorage
        const instanceList = JSON.parse(localStorage.getItem('flowfocus-instance-list')) || [];
        
        // Add default instances first
        const defaultInstances = ['default', 'work', 'personal', 'grants', 'class', 'project-a', 'project-b', 'lab', 'backup'];
        
        // Clear current options (keep the first default ones)
        while (instanceSelect.options.length > 8) { // Keep the first 8 default options
            instanceSelect.remove(8);
        }
        
        // Add custom instances from localStorage
        instanceList.forEach(instanceName => {
            // Skip if already in default list
            if (!defaultInstances.includes(instanceName)) {
                // Check if option already exists
                if (!instanceSelect.querySelector(`option[value="${instanceName}"]`)) {
                    const option = document.createElement('option');
                    option.value = instanceName;
                    option.textContent = instanceName;
                    instanceSelect.appendChild(option);
                }
            }
        });
        
        // Update quick select too
        updateInstanceQuickSelect();
    }
    
    // ========== INSTANCE EVENT LISTENERS ==========
    function setupInstanceEventListeners() {
        // Open instance modal
        switchInstanceBtn.addEventListener('click', () => {
            instanceModal.classList.add('active');
            // Populate instance select with current instance selected
            instanceSelect.value = CURRENT_INSTANCE;
            newInstanceName.value = '';
            
            // Focus search box
            setTimeout(() => {
                if (instanceSearchBox) instanceSearchBox.focus();
            }, 100);
        });
        
        // Quick switch dropdown
        if (instanceQuickSelect) {
            instanceQuickSelect.addEventListener('change', function() {
                if (this.value !== CURRENT_INSTANCE) {
                    switchInstance(this.value);
                }
            });
        }
        
        // Quick switch button
        if (quickSwitchBtn) {
            quickSwitchBtn.addEventListener('click', () => {
                if (instanceQuickSelect && instanceQuickSelect.value !== CURRENT_INSTANCE) {
                    switchInstance(instanceQuickSelect.value);
                }
            });
        }
        
        // Instance search
        if (instanceSearchBox) {
            instanceSearchBox.addEventListener('input', function() {
                searchInstances(this.value);
            });
        }
        
        // Instance template buttons
        if (instanceTemplateBtns) {
            instanceTemplateBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const templateName = this.getAttribute('data-template');
                    const instanceName = templateName.toLowerCase();
                    
                    if (!instanceExists(instanceName)) {
                        createInstanceFromTemplate(instanceName, templateName);
                        instanceModal.classList.remove('active');
                    } else {
                        // Switch to existing instance
                        switchInstance(instanceName);
                        instanceModal.classList.remove('active');
                    }
                });
            });
        }
        
        // Export all instances
        if (exportAllInstancesBtn) {
            exportAllInstancesBtn.addEventListener('click', exportAllInstances);
        }
        
        // Refresh instance list
        if (refreshInstanceListBtn) {
            refreshInstanceListBtn.addEventListener('click', () => {
                loadAllInstances();
                showTemporaryMessage('Instance list refreshed!', 'success');
            });
        }
        
        // Close instance modal
        closeInstanceModal.addEventListener('click', () => instanceModal.classList.remove('active'));
        closeInstance.addEventListener('click', () => instanceModal.classList.remove('active'));
        
        // Create new instance
        createInstanceBtn.addEventListener('click', () => {
            const name = newInstanceName.value.trim().toLowerCase().replace(/\s+/g, '-');
            if (name) {
                // Validate instance name
                if (!isValidInstanceName(name)) {
                    showTemporaryMessage('Invalid instance name. Use 2-20 characters, letters, numbers, hyphens or underscores.', 'warning');
                    return;
                }
                
                // Check if instance already exists
                const existingInstances = ['default', 'work', 'personal', 'grants', 'class', 'project-a', 'project-b', 'lab', 'backup'];
                const existingOptions = Array.from(instanceSelect.options).map(opt => opt.value);
                
                if (!existingInstances.includes(name) && !existingOptions.includes(name)) {
                    // Create the new instance in localStorage with default data
                    const defaultInstanceData = {
                        tasks: [],
                        sessions: [],
                        projects: ['General'],
                        workNotes: '',
                        ideas: [],
                        settings: {
                            focusTime: 25,
                            breakTime: 5,
                            soundEnabled: true,
                            tickSoundEnabled: true
                        },
                        instance: name
                    };
                    
                    // Save default data to localStorage for this instance
                    localStorage.setItem(`flowfocus-workmode-data-${name}`, JSON.stringify(defaultInstanceData));
                    
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    instanceSelect.appendChild(option);
                    instanceSelect.value = name;
                    newInstanceName.value = '';
                    
                    // Update the instance list in localStorage
                    updateInstanceList(name);
                    
                    // Update quick select
                    updateInstanceQuickSelect();
                    
                    // Auto-switch to new instance
                    switchInstance(name);
                    
                    instanceModal.classList.remove('active');
                    
                    showTemporaryMessage(`New instance "${name}" created and switched!`, 'success');
                } else {
                    showTemporaryMessage(`Instance "${name}" already exists!`, 'warning');
                }
            } else {
                showTemporaryMessage('Please enter an instance name', 'warning');
            }
        });
        
        // Enter key for new instance name
        newInstanceName.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                createInstanceBtn.click();
            }
        });
        
        // Switch instance
        switchInstanceBtnModal.addEventListener('click', () => {
            const newInstance = instanceSelect.value;
            if (newInstance !== CURRENT_INSTANCE) {
                // Check if the instance exists in localStorage
                const instanceData = localStorage.getItem(`flowfocus-workmode-data-${newInstance}`);
                
                if (!instanceData && !['default', 'work', 'personal', 'grants', 'class', 'project-a', 'project-b', 'lab', 'backup'].includes(newInstance)) {
                    // Create default data for new custom instance
                    const defaultInstanceData = {
                        tasks: [],
                        sessions: [],
                        projects: ['General'],
                        workNotes: '',
                        ideas: [],
                        settings: {
                            focusTime: 25,
                            breakTime: 5,
                            soundEnabled: true,
                            tickSoundEnabled: true
                        },
                        instance: newInstance
                    };
                    
                    localStorage.setItem(`flowfocus-workmode-data-${newInstance}`, JSON.stringify(defaultInstanceData));
                    
                    // Update instance list
                    updateInstanceList(newInstance);
                    
                    showTemporaryMessage(`Created new instance: ${newInstance}`, 'success');
                }
                
                switchInstance(newInstance);
                instanceModal.classList.remove('active');
            } else {
                showTemporaryMessage(`Already on instance: ${CURRENT_INSTANCE}`, 'info');
            }
        });
        
        // Instance management buttons
        exportInstanceDataBtn.addEventListener('click', exportInstanceData);
        importInstanceDataBtn.addEventListener('click', importInstanceData);
        deleteInstanceDataBtn.addEventListener('click', () => {
            if (confirm(`Are you sure you want to DELETE ALL DATA for instance "${CURRENT_INSTANCE}"? This action cannot be undone.`)) {
                // Clear data for current instance
                localStorage.removeItem(`flowfocus-workmode-data-${CURRENT_INSTANCE}`);
                
                // Remove from instance list if it's a custom instance
                const defaultInstances = ['default', 'work', 'personal', 'grants', 'class', 'project-a', 'project-b', 'lab', 'backup'];
                if (!defaultInstances.includes(CURRENT_INSTANCE)) {
                    let instanceList = JSON.parse(localStorage.getItem('flowfocus-instance-list')) || [];
                    instanceList = instanceList.filter(inst => inst !== CURRENT_INSTANCE);
                    localStorage.setItem('flowfocus-instance-list', JSON.stringify(instanceList));
                    
                    // Remove from dropdowns
                    const option = instanceSelect.querySelector(`option[value="${CURRENT_INSTANCE}"]`);
                    if (option) {
                        option.remove();
                    }
                    
                    // Remove from favorites
                    favoriteInstances = favoriteInstances.filter(inst => inst !== CURRENT_INSTANCE);
                    localStorage.setItem('flowfocus-favorite-instances', JSON.stringify(favoriteInstances));
                    
                    // Remove from recent
                    recentInstances = recentInstances.filter(inst => inst !== CURRENT_INSTANCE);
                    localStorage.setItem('flowfocus-recent-instances', JSON.stringify(recentInstances));
                    
                    // Update UI
                    updateInstanceQuickSelect();
                    updateRecentInstancesBar();
                }
                
                // Switch to default instance
                switchInstance('default');
                
                showTemporaryMessage(`Instance "${CURRENT_INSTANCE}" deleted!`, 'success');
            }
        });
        
        // Close all instance windows (for tabs opened with instance URLs)
        if (closeAllInstancesBtn) {
            closeAllInstancesBtn.addEventListener('click', () => {
                if (confirm('This will attempt to close all FlowFocus tabs/windows except this one. Continue?')) {
                    // This is a simple implementation - in a real app you might want to use window.opener or BroadcastChannel
                    showTemporaryMessage('Use browser shortcuts to close tabs (Ctrl+W or Cmd+W)', 'info');
                }
            });
        }
    }

    // Function to validate instance name
    function isValidInstanceName(name) {
        if (!name || name.trim().length === 0) return false;
        
        // Check for valid characters (alphanumeric, hyphens, underscores)
        const validChars = /^[a-z0-9_-]+$/;
        if (!validChars.test(name)) return false;
        
        // Check length
        if (name.length < 2 || name.length > 20) return false;
        
        // Reserved names
        const reservedNames = ['new', 'all', 'null', 'undefined', 'localstorage', 'instance'];
        if (reservedNames.includes(name.toLowerCase())) return false;
        
        return true;
    }
    
    // ========== SETUP EVENT LISTENERS ==========
    function setupEventListeners() {
        // Setup instance event listeners first (includes new easy switching)
        setupInstanceEventListeners();
        
        // Add keyboard shortcuts for instance switching
        document.addEventListener('keydown', function(e) {
            // Ctrl + Shift + I to open instance modal
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                instanceModal.classList.add('active');
                setTimeout(() => {
                    if (instanceSearchBox) instanceSearchBox.focus();
                }, 100);
            }
            
            // Ctrl + Shift + S to quick save and switch
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                quickSaveAndSwitch();
            }
            
            // Ctrl + Shift + F to toggle current instance as favorite
            if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                toggleFavoriteInstance(CURRENT_INSTANCE);
            }
        });
        
        // ========== MODAL BUTTON EVENT LISTENERS ==========
        // Manage Projects button
        if (document.getElementById('manage-projects-btn')) {
            document.getElementById('manage-projects-btn').addEventListener('click', openProjectManagement);
        }
        
        // Manage Tasks button  
        if (document.getElementById('manage-tasks-btn')) {
            document.getElementById('manage-tasks-btn').addEventListener('click', openTaskManagement);
        }
        
        // Settings button
        if (document.getElementById('settings-btn')) {
            document.getElementById('settings-btn').addEventListener('click', openSettings);
        }
        
        // Quick Note Modal buttons - ADD THESE CHECKS
        const saveQuickNoteBtn = document.getElementById('save-quick-note');
        const cancelQuickNoteBtn = document.getElementById('cancel-quick-note');
        const closeQuickNoteModalBtn = document.getElementById('close-quick-note-modal');
        
        if (saveQuickNoteBtn) {
            console.log('Found save-quick-note button, adding event listener');
            saveQuickNoteBtn.addEventListener('click', saveQuickNoteFunc);
        } else {
            console.error('save-quick-note button NOT FOUND');
        }
        
        if (cancelQuickNoteBtn) {
            console.log('Found cancel-quick-note button, adding event listener');
            cancelQuickNoteBtn.addEventListener('click', closeQuickNoteModalFunc);
        } else {
            console.error('cancel-quick-note button NOT FOUND');
        }
        
        if (closeQuickNoteModalBtn) {
            console.log('Found close-quick-note-modal button, adding event listener');
            closeQuickNoteModalBtn.addEventListener('click', closeQuickNoteModalFunc);
        } else {
            console.error('close-quick-note-modal button NOT FOUND');
        }
        
        // Close Project Management Modal buttons
        document.getElementById('close-project-management-modal').addEventListener('click', closeProjectManagementFunc);
        document.getElementById('close-project-management').addEventListener('click', closeProjectManagementFunc);
        
        // Close Task Management Modal buttons
        document.getElementById('close-task-management-modal').addEventListener('click', closeTaskManagementFunc);
        document.getElementById('close-task-management').addEventListener('click', closeTaskManagementFunc);
        
        // Close Settings Modal buttons
        document.getElementById('close-settings-modal').addEventListener('click', closeSettingsFunc);
        document.getElementById('close-settings').addEventListener('click', closeSettingsFunc);
        
        // Create Project button
        document.getElementById('create-project-btn').addEventListener('click', createProject);
        
        // Create Task button
        document.getElementById('create-task-btn').addEventListener('click', createTask);
        
        // Task Management Filters
        document.getElementById('task-filter-project').addEventListener('change', updateTaskManagement);
        document.getElementById('task-filter-status').addEventListener('change', updateTaskManagement);
        
        // Project dropdown change
        workProjectSelect.addEventListener('change', handleProjectChange);
        
        // Task dropdown change
        workTaskSelect.addEventListener('change', handleTaskChange);
        
        // ========== ORIGINAL EVENT LISTENERS ==========
        // Timer controls
        workStartBtn.addEventListener('click', startTimer);
        workPauseBtn.addEventListener('click', pauseTimer);
        workSkipBtn.addEventListener('click', skipTimer);
        
        // Expand time buttons
        expand5MinBtn.addEventListener('click', expandTime5Min);
        expand10MinBtn.addEventListener('click', expandTime10Min);
        expand15MinBtn.addEventListener('click', expandTime15Min);
        
        // Work mode tabs
        workTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                switchWorkTab(tabId);
            });
        });
        
        // Work notes and ideas
        saveWorkNotes.addEventListener('click', saveWorkNotesFunc);
        clearWorkNotes.addEventListener('click', clearWorkNotesFunc);
        addIdea.addEventListener('click', addIdeaFunc);
        clearIdeas.addEventListener('click', clearIdeasFunc);
        
        // Save session
        saveSessionBtn.addEventListener('click', saveCurrentSession);
        
        // Clear all notes and ideas
        clearAllNotesIdeasBtn.addEventListener('click', clearAllNotesIdeas);
        
        // Settings
        saveSettingsBtn.addEventListener('click', saveSettings);
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', importData);
        clearDataBtn.addEventListener('click', clearData);
        
        // Timer settings changes
        focusTimeInput.addEventListener('change', updateTimerSettings);
        breakTimeInput.addEventListener('change', updateTimerSettings);

        // Floating app buttons
        document.getElementById('open-chat-app').addEventListener('click', openChatApp);
        document.getElementById('open-todo-list').addEventListener('click', openTodoList);
        document.getElementById('open-daily-todo').addEventListener('click', openDailyTodo);
        document.getElementById('open-flock').addEventListener('click', openFlock);
        
        // Project Review button
        document.getElementById('open-project-review').addEventListener('click', openProjectReview);
        
        // TimeStripe and PDCA buttons
        document.getElementById('open-timestripe').addEventListener('click', openTimeStripe);
        document.getElementById('open-pdca').addEventListener('click', openPDCA);
        
        // Add these two lines with the other event listeners:
document.getElementById('open-q-todo').addEventListener('click', openQTodo);
document.getElementById('open-remnote').addEventListener('click', openRemnote);
document.getElementById('open-dynalist').addEventListener('click', openDynalist);

        // Formatting buttons event listeners
        document.getElementById('insert-checkbox').addEventListener('click', () => insertCheckbox('work-notes-input'));
        document.getElementById('insert-bullet').addEventListener('click', () => insertBullet('work-notes-input'));
        document.getElementById('insert-idea-checkbox').addEventListener('click', () => insertCheckbox('idea-input'));
        document.getElementById('insert-idea-bullet').addEventListener('click', () => insertBullet('idea-input'));

        // Notes preview tabs
        document.querySelectorAll('.notes-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabType = e.target.getAttribute('data-notes-tab');
                
                // Update tabs
                document.querySelectorAll('.notes-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                
                // Update views
                document.getElementById('notes-edit-view').classList.toggle('active', tabType === 'edit');
                document.getElementById('notes-preview-view').classList.toggle('active', tabType === 'preview');
                document.getElementById('notes-edit-view').style.display = tabType === 'edit' ? 'block' : 'none';
                document.getElementById('notes-preview-view').style.display = tabType === 'preview' ? 'block' : 'none';
                
                // Update preview content if switching to preview
                if (tabType === 'preview') {
                    const notesText = document.getElementById('work-notes-input').value;
                    document.getElementById('notes-preview-content').innerHTML = renderFormattedNotes(notesText);
                }
            });
        });

        // Auto-update preview when typing (optional)
        document.getElementById('work-notes-input').addEventListener('input', function() {
            if (document.getElementById('notes-preview-view').style.display !== 'none') {
                document.getElementById('notes-preview-content').innerHTML = renderFormattedNotes(this.value);
            }
        });

        // Setup checkbox toggling
        setupCheckboxToggling();

        // Kanban board
        workKanbanTab.addEventListener('click', () => switchWorkTab('work-kanban'));
        refreshKanbanBtn.addEventListener('click', updateKanbanBoard);
        kanbanProjectFilter.addEventListener('change', updateKanbanBoard);

        // History filters
        historyProjectFilter.addEventListener('change', updateHistoryTable);
        historyTaskFilter.addEventListener('change', updateHistoryTable);
        historyDateFilter.addEventListener('change', updateHistoryTable);
        clearHistoryFiltersBtn.addEventListener('click', clearHistoryFilters);
        
        // Quick Note Modal keyboard shortcuts
        modalNotesInput.addEventListener('keydown', function(e) {
            // Enter key to save (but not when Shift is held)
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveQuickNoteFunc();
            }
            // Escape key to cancel
            if (e.key === 'Escape') {
                e.preventDefault();
                closeQuickNoteModalFunc();
            }
        });

        // Make the modal close when clicking outside
        quickNoteModal.addEventListener('click', function(e) {
            if (e.target === quickNoteModal) {
                closeQuickNoteModalFunc();
            }
        });
        
        // Enter key for idea input
        ideaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addIdeaFunc();
            }
        });
        
        // ========== CURRENT TASK SUBTASK EVENT LISTENERS ==========
        // We'll use event delegation since subtasks are dynamically created
        document.addEventListener('click', function(e) {
            // Add subtask to current task
            if (e.target.closest('#add-subtask-current')) {
                const btn = e.target.closest('#add-subtask-current');
                const taskId = parseInt(btn.getAttribute('data-task-id'));
                addSubtask(taskId);
                updateWorkModeDisplay(); // Refresh display
            }
            
            // Toggle current task subtask completion
            if (e.target.closest('.current-subtask-checkbox')) {
                const checkbox = e.target.closest('.current-subtask-checkbox');
                const taskId = parseInt(checkbox.getAttribute('data-task-id'));
                const subtaskIndex = parseInt(checkbox.getAttribute('data-subtask-index'));
                toggleSubtaskCompletion(taskId, subtaskIndex);
                updateWorkModeDisplay(); // Refresh display
                updateTaskManagement(); // Also update task management modal
            }
            
            // Delete current task subtask
            if (e.target.closest('.delete-current-subtask')) {
                const btn = e.target.closest('.delete-current-subtask');
                const taskId = parseInt(btn.getAttribute('data-task-id'));
                const subtaskIndex = parseInt(btn.getAttribute('data-subtask-index'));
                if (confirm('Are you sure you want to delete this subtask?')) {
                    deleteSubtask(taskId, subtaskIndex);
                    updateWorkModeDisplay(); // Refresh display
                    updateTaskManagement(); // Also update task management modal
                }
            }
        });
        
        // Double-click to edit subtask name in current task
        document.addEventListener('dblclick', function(e) {
            if (e.target.closest('.current-subtask-name')) {
                const subtaskName = e.target.closest('.current-subtask-name');
                const subtaskItem = subtaskName.closest('.current-subtask-item');
                const taskId = parseInt(subtaskItem.getAttribute('data-task-id'));
                const subtaskIndex = parseInt(subtaskItem.getAttribute('data-subtask-index'));
                
                const task = tasks.find(t => t.id === taskId);
                if (task && task.subtasks && task.subtasks[subtaskIndex]) {
                    const currentName = task.subtasks[subtaskIndex].name;
                    
                    // Replace text with input field
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentName;
                    input.className = 'edit-subtask-input';
                    input.style.cssText = `
                        flex: 1;
                        padding: 6px 10px;
                        border: 1px solid var(--primary);
                        border-radius: 4px;
                        font-size: 0.9rem;
                        outline: none;
                    `;
                    
                    subtaskName.replaceWith(input);
                    input.focus();
                    input.select();
                    
                    // Save on blur
                    input.addEventListener('blur', function() {
                        const newName = input.value.trim();
                        if (newName && newName !== currentName) {
                            updateSubtask(taskId, subtaskIndex, newName);
                            updateWorkModeDisplay(); // Refresh display
                        } else {
                            updateWorkModeDisplay(); // Refresh without changes
                        }
                    });
                    
                    // Save on Enter key
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            input.blur();
                        }
                    });
                    
                    // Cancel on Escape key
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            updateWorkModeDisplay(); // Refresh without changes
                        }
                    });
                }
            }
        });
    }
    
    // ========== TIMER FUNCTIONS ==========
    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            timer = setInterval(updateTimer, 1000);
            
            // Start ticking sound if enabled
            if (tickSoundToggle.checked) {
                startTickingSound();
            }
            
            // Start a new session if not already running
            if (!currentSession) {
                const currentProject = workProjectSelect.value.replace('Project: ', '') || 'General';
                const projectTasks = tasks.filter(t => t.project === currentProject && !t.completed && t.status === 'working');
                
                currentSession = {
                    id: Date.now(),
                    startTime: new Date(),
                    type: isFocusMode ? 'focus' : 'break',
                    duration: 0,
                    tasks: [...projectTasks],
                    project: currentProject,
                    workNotes: workNotes,
                    ideas: [...ideas]
                };
            }
            
            updateButtons();
        }
    }
    
    function pauseTimer() {
        if (isRunning) {
            clearInterval(timer);
            isRunning = false;
            
            // Stop ticking sound
            stopTickingSound();
            
            updateButtons();
        }
    }
    
    function skipTimer() {
        // Save current session if it exists
        if (currentSession) {
            currentSession.duration = isFocusMode ? 
                (parseInt(focusTimeInput.value) * 60) - timeLeft : 
                (parseInt(breakTimeInput.value) * 60) - timeLeft;
            
            currentSession.workNotes = workNotes;
            currentSession.ideas = [...ideas];
            
            // Only save focus sessions to history
            if (isFocusMode) {
                sessions.push(currentSession);
                saveData();
                updateHistoryTable();
            }
            
            currentSession = null;
        }
        
        // Switch mode and reset timer
        isFocusMode = !isFocusMode;
        resetTimer();
        updateButtons();
        
        // Show notification when switching to break
        if (!isFocusMode) {
            showTimeUpNotification("Time for a break!");
        }
    }
    
    function resetTimer() {
        clearInterval(timer);
        isRunning = false;
        
        // Stop ticking sound
        stopTickingSound();
        
        isFocusMode = true;
        timeLeft = parseInt(focusTimeInput.value) * 60;
        totalTime = timeLeft;
        updateTimerDisplay();
        updateButtons();
        
        // Reset current session
        currentSession = null;
    }
    
    function updateTimer() {
        timeLeft--;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            isRunning = false;
            
            // Stop ticking sound
            stopTickingSound();
            
            // Save session
            if (currentSession) {
                currentSession.duration = isFocusMode ? 
                    parseInt(focusTimeInput.value) * 60 : 
                    parseInt(breakTimeInput.value) * 60;
                
                currentSession.workNotes = workNotes;
                currentSession.ideas = [...ideas];
                
                // Only save focus sessions to history
                if (isFocusMode) {
                    sessions.push(currentSession);
                    saveData();
                    updateHistoryTable();
                }
                
                currentSession = null;
            }
            
            // Show notification and switch mode
            if (isFocusMode) {
                showTimeUpNotification("Focus session completed!");
                isFocusMode = false;
                timeLeft = parseInt(breakTimeInput.value) * 60;
            } else {
                showTimeUpNotification("Break time is over!");
                isFocusMode = true;
                timeLeft = parseInt(focusTimeInput.value) * 60;
            }
            
            totalTime = timeLeft;
            updateTimerDisplay();
            updateButtons();
            
            // Play sound if enabled
            if (soundToggle.checked) {
                playNotificationSound();
            }
        } else {
            updateTimerDisplay();
        }
    }
    
    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        workHeaderTimer.textContent = display;
    }
    
    function updateButtons() {
        workStartBtn.disabled = isRunning;
        workPauseBtn.disabled = !isRunning;
        
        // Update mode indicator
        if (isFocusMode) {
            workHeaderMode.textContent = 'Focus Time';
        } else {
            workHeaderMode.textContent = 'Break Time';
        }
    }
    
    // Ticking sound functions
    function startTickingSound() {
        // Don't start if ticking sound is disabled
        if (!tickSoundToggle.checked) return;
        
        // Create audio context
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        // Create oscillator for ticking sound
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configure oscillator for clock-like ticking
        oscillator.type = 'sine';
        oscillator.frequency.value = 1000;
        
        // Configure gain for short, sharp ticks
        gainNode.gain.value = 0;
        
        // Start oscillator
        oscillator.start();
        
        // Store for later cleanup
        tickSound = {
            oscillator: oscillator,
            gainNode: gainNode,
            audioContext: audioContext
        };
        
        // Create ticking pattern
        tickInterval = setInterval(() => {
            if (!isRunning || !tickSoundToggle.checked) {
                stopTickingSound();
                return;
            }
            
            // Create a sharp tick sound
            const now = audioContext.currentTime;
            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
        }, 1000);
    }
    
    function stopTickingSound() {
        if (tickInterval) {
            clearInterval(tickInterval);
            tickInterval = null;
        }
        
        if (tickSound) {
            tickSound.oscillator.stop();
            tickSound.audioContext.close();
            tickSound = null;
        }
    }
    
    function playNotificationSound() {
        // Create audio context for sound notification
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
        } catch (e) {
            console.log("Audio context not supported");
        }
    }
    
    // Expand time functions
    function expandTime5Min(e) {
        e.preventDefault();
        expandTime(5);
    }
    
    function expandTime10Min(e) {
        e.preventDefault();
        expandTime(10);
    }
    
    function expandTime15Min(e) {
        e.preventDefault();
        expandTime(15);
    }
    
    function expandTime(minutes) {
        if (isRunning && isFocusMode) {
            timeLeft += minutes * 60;
            totalTime += minutes * 60;
            updateTimerDisplay();
            
            // Show a brief confirmation
            const originalText = document.querySelector('.expand-time-btn').innerHTML;
            document.querySelector('.expand-time-btn').innerHTML = `<i class="fas fa-check"></i> +${minutes}min`;
            
            setTimeout(() => {
                document.querySelector('.expand-time-btn').innerHTML = originalText;
            }, 1500);
        }
    }
    
    // ========== WORK MODE FUNCTIONS ==========
    function updateWorkModeDisplay() {
        // Update current task
        if (currentTaskId) {
            const task = tasks.find(t => t.id === currentTaskId);
            if (task) {
                workCurrentTaskName.textContent = task.name;
                
                // ========== ADD SUBTASKS TO CURRENT TASK DISPLAY ==========
                // Check if task has subtasks
                let subtasksHtml = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                    const totalSubtasks = task.subtasks.length;
                    
                    subtasksHtml = `
                        <div class="current-task-subtasks" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.9); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="font-size: 0.9rem; color: var(--warning);">
                                    <i class="fas fa-list-check"></i> Subtasks (${completedSubtasks}/${totalSubtasks})
                                </strong>
                                <button class="icon-btn" id="add-subtask-current" data-task-id="${task.id}" title="Add Subtask" style="font-size: 0.8rem; padding: 4px 8px; background: var(--warning); color: white;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="current-subtasks-list" id="current-subtasks-list-${task.id}" style="max-height: 200px; overflow-y: auto;">
                                ${task.subtasks.map((subtask, index) => `
                                    <div class="current-subtask-item" data-task-id="${task.id}" data-subtask-index="${index}" 
                                         style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 10px; background: ${subtask.completed ? 'rgba(76, 201, 240, 0.1)' : 'white'}; border-radius: 6px; border: 1px solid var(--gray-light);">
                                        <input type="checkbox" class="current-subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                               data-task-id="${task.id}" data-subtask-index="${index}"
                                               style="width: 18px; height: 18px; accent-color: var(--success); cursor: pointer;">
                                        <span class="current-subtask-name" style="flex: 1; font-size: 0.9rem; ${subtask.completed ? 'text-decoration: line-through; color: var(--gray);' : ''}">
                                            ${subtask.name}
                                        </span>
                                        <button class="icon-btn delete-current-subtask" data-task-id="${task.id}" data-subtask-index="${index}" title="Delete Subtask" 
                                                style="color: var(--danger); font-size: 0.8rem; padding: 4px;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Update the current task display with subtasks
                workCurrentTaskName.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${task.name}</span>
                        <span class="status-badge ${task.status === 'working' ? 'status-working' : 'status-backlog'}" style="font-size: 0.8rem;">
                            ${task.status === 'working' ? 'Working' : 'Backlog'}
                        </span>
                    </div>
                    ${subtasksHtml}
                `;
            } else {
                workCurrentTaskName.textContent = 'No task selected';
            }
        } else {
            workCurrentTaskName.textContent = 'No task selected';
        }
        
        // Update task stats
        const completedTasks = tasks.filter(t => t.completed).length;
        workTaskCompleted.textContent = completedTasks;
        workTaskTotal.textContent = tasks.length;
        
        // Calculate focus time for current task
        if (currentTaskId) {
            const task = tasks.find(t => t.id === currentTaskId);
            if (task) {
                workTaskFocusTime.textContent = `${task.focusTime} min`;
            } else {
                workTaskFocusTime.textContent = '0 min';
            }
        } else {
            workTaskFocusTime.textContent = '0 min';
        }
        
        // Update task list
        updateWorkTaskList();
        
        // Update history table
        updateHistoryTable();
        
        // Update work notes and ideas
        workNotesInput.value = workNotes;
        updateIdeasList();
    }
    
    function updateWorkTaskList() {
        workTaskList.innerHTML = '';
        
        // Get the current project
        const currentProject = workProjectSelect.value.replace('Project: ', '') || 'General';
        
        // Show only incomplete working tasks from current project in work mode
        const incompleteTasks = tasks.filter(t => !t.completed && t.project === currentProject && t.status === 'working');
        
        if (incompleteTasks.length === 0) {
            workTaskList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>All working tasks completed for ${currentProject} project! Great job!</p>
                </div>
            `;
            return;
        }
        
        incompleteTasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = `task-item ${task.id === currentTaskId ? 'active-task' : ''}`;
            
            // Format notes with bullet points
            let notesHtml = '';
            if (task.notes && task.notes.trim()) {
                const notesLines = task.notes.split('\n');
                notesHtml = '<div class="task-full-notes" style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px; border-left: 2px solid var(--primary-light);">';
                notesHtml += notesLines.map(line => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) {
                        return '<div style="height: 4px;"></div>';
                    }
                    // Convert bullet points and checkboxes
                    if (trimmedLine.startsWith('-') || trimmedLine.startsWith('*') || trimmedLine.startsWith('•')) {
                        return `<div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 4px;">
                            <span style="color: var(--primary); flex-shrink: 0;">•</span>
                            <span style="flex: 1;">${trimmedLine.substring(1).trim()}</span>
                        </div>`;
                    } else if (trimmedLine.startsWith('[ ]') || trimmedLine.startsWith('[x]')) {
                        const isChecked = trimmedLine.startsWith('[x]');
                        const textAfter = trimmedLine.substring(3).trim();
                        return `<div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 4px;">
                            <span style="color: ${isChecked ? 'var(--success)' : 'var(--primary)'}; flex-shrink: 0;">
                                ${isChecked ? '✓' : '☐'}
                            </span>
                            <span style="flex: 1; ${isChecked ? 'text-decoration: line-through; color: var(--gray);' : ''}">
                                ${textAfter}
                            </span>
                        </div>`;
                    } else {
                        return `<div style="margin-bottom: 4px; padding-left: 12px;">${line}</div>`;
                    }
                }).join('');
                notesHtml += '</div>';
            }
            
            // ========== ADD SUBTASK PREVIEW HERE ==========
            // Add subtasks preview
            let subtasksPreview = '';
            if (task.subtasks && task.subtasks.length > 0) {
                const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                const progressPercentage = Math.round((completedSubtasks / task.subtasks.length) * 100);
                
                subtasksPreview = `
                    <div class="task-subtasks-preview" style="margin-top: 8px; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <i class="fas fa-list-check" style="color: var(--warning);"></i>
                            <span style="color: var(--dark); font-weight: 500;">
                                Subtasks: ${completedSubtasks}/${task.subtasks.length} completed
                            </span>
                        </div>
                        <div style="width: 100%; height: 4px; background: var(--gray-light); border-radius: 2px; overflow: hidden;">
                            <div style="width: ${progressPercentage}%; height: 100%; background: var(--success); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            }
            // ========== END OF SUBTASK PREVIEW ADDITION ==========
            
            taskItem.innerHTML = `
                <div class="task-header">
                    <div class="task-content">
                        <input type="checkbox" class="task-checkbox">
                        <div class="task-details">
                            <div class="task-name">${task.name}</div>
                            <div class="task-project">Project: ${task.project}</div>
                            ${subtasksPreview}
                            ${notesHtml ? `<div class="task-notes">${notesHtml}</div>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="focus-on-btn" data-task-id="${task.id}">
                            <i class="fas fa-bullseye"></i> Focus
                        </button>
                        <button class="quick-note-btn" data-task-id="${task.id}">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                    </div>
                </div>
            `;
            
            workTaskList.appendChild(taskItem);
        });
        
        // Add event listeners to task buttons
        document.querySelectorAll('#work-task-list .task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const taskId = parseInt(e.target.closest('.task-item').querySelector('.focus-on-btn').getAttribute('data-task-id'));
                toggleTaskCompletion(taskId);
                updateWorkModeDisplay();
                updateTaskManagement();
            });
        });
        
        document.querySelectorAll('#work-task-list .quick-note-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.quick-note-btn').getAttribute('data-task-id'));
                addQuickNote(taskId);
            });
        });
        
        document.querySelectorAll('#work-task-list .focus-on-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.focus-on-btn').getAttribute('data-task-id'));
                setFocusTask(taskId);
                updateWorkModeDisplay();
            });
        });
    }
    
    function switchWorkTab(tabId) {
        // Update tabs
        workTabs.forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-tab') === tabId) {
                tab.classList.add('active');
            }
        });
        
        // Update tab content
        workTabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === tabId) {
                content.classList.add('active');
            }
        });
    }
    
    function saveWorkNotesFunc() {
        workNotes = workNotesInput.value;
        saveData();
        showTemporaryMessage('Work notes saved!', 'success');
    }
    
    function clearWorkNotesFunc() {
        if (confirm("Are you sure you want to clear all work notes?")) {
            workNotes = '';
            workNotesInput.value = '';
            saveData();
            showTemporaryMessage("Work notes cleared!", "success");
        }
    }
    
    function addIdeaFunc() {
        const idea = ideaInput.value.trim();
        if (idea) {
            ideas.push({
                id: Date.now(),
                content: idea,
                createdAt: new Date()
            });
            ideaInput.value = '';
            updateIdeasList();
            saveData();
            showTemporaryMessage('Idea added!', 'success');
        }
    }
    
    function clearIdeasFunc() {
        if (confirm("Are you sure you want to clear all ideas?")) {
            ideas = [];
            updateIdeasList();
            saveData();
            showTemporaryMessage("All ideas cleared!", "success");
        }
    }
    
    function updateIdeasList() {
        ideasList.innerHTML = '';
        
        if (ideas.length === 0) {
            ideasList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-lightbulb"></i>
                    <p>No ideas yet. Add your first idea!</p>
                </div>
            `;
            return;
        }
        
        // Sort ideas by date (newest first)
        const sortedIdeas = [...ideas].sort((a, b) => 
            new Date(b.createdAt) - new Date(a.createdAt)
        );
        
        sortedIdeas.forEach(idea => {
            const ideaEl = document.createElement('div');
            ideaEl.className = 'idea-item-compact';
            
            ideaEl.innerHTML = `
                <div class="idea-header" style="margin-bottom: 8px;">
                    <div class="idea-content-compact">${idea.content}</div>
                    <div class="idea-actions">
                        <button class="icon-btn delete-idea" data-idea-id="${idea.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            ideasList.appendChild(ideaEl);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-idea').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ideaId = parseInt(e.target.closest('.delete-idea').getAttribute('data-idea-id'));
                deleteIdea(ideaId);
            });
        });
    }
    
    function deleteIdea(ideaId) {
        ideas = ideas.filter(i => i.id !== ideaId);
        updateIdeasList();
        saveData();
    }
    
    // Clear all notes and ideas
    function clearAllNotesIdeas() {
        if (confirm("Are you sure you want to clear ALL Work Notes and Ideas? This action cannot be undone.")) {
            workNotes = '';
            ideas = [];
            workNotesInput.value = '';
            updateIdeasList();
            saveData();
            showTemporaryMessage("All notes and ideas cleared!", "success");
        }
    }
    
    // Save and load functions
    function saveCurrentSession() {
        if (currentSession) {
            // Update session data
            currentSession.duration = isFocusMode ? 
                (parseInt(focusTimeInput.value) * 60) - timeLeft : 
                (parseInt(breakTimeInput.value) * 60) - timeLeft;
            
            currentSession.tasks = [...tasks];
            currentSession.workNotes = workNotes;
            currentSession.ideas = [...ideas];
            
            // Add to sessions
            sessions.push(currentSession);
            saveData();
            updateHistoryTable();
            updateHistoryFilters();
            
            // Show confirmation
            showTemporaryMessage("Session saved to history!", "success");
            
            // Reset current session
            currentSession = null;
        } else {
            showTemporaryMessage("No active session to save", "warning");
        }
    }
    
    // ========== TASK MANAGEMENT FUNCTIONS ==========
    function toggleTaskCompletion(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            
            // If marking task as completed, also mark all subtasks as completed
            if (task.completed && task.subtasks) {
                task.subtasks.forEach(subtask => {
                    subtask.completed = true;
                });
            }
            // If unmarking task as incomplete, also unmark all subtasks
            else if (!task.completed && task.subtasks) {
                task.subtasks.forEach(subtask => {
                    subtask.completed = false;
                });
            }
            
            saveData();
            updateTaskManagement();
        }
    }
    
    function toggleTaskStatus(taskId, newStatus) {
        const task = tasks.find(t => t.id === taskId);
        if (task && !task.completed) {
            task.status = newStatus;
            saveData();
            updateTaskManagement();
            updateWorkTaskList();
            updateWorkTaskDropdown();
            updateKanbanBoard();
            
            // Show status change message
            const statusText = {
                'backlog': 'Backlog',
                'working': 'Working', 
                'review': 'Review',
                'completed': 'Completed'
            }[newStatus] || newStatus;
            
            showTemporaryMessage(`Moved "${task.name}" to ${statusText}`, 'success');
        }
    }
    
    function deleteTask(taskId) {
        tasks = tasks.filter(t => t.id !== taskId);
        saveData();
        updateTaskManagement();
        updateWorkTaskList();
        updateWorkTaskDropdown();
    }
    
    function setFocusTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            currentTaskId = taskId;
            
            // Update work mode display
            updateWorkModeDisplay();
            
            // Sync the task dropdown
            if (workTaskSelect) {
                workTaskSelect.value = taskId;
            }
            
            showTemporaryMessage(`Now focusing on: ${task.name}`, 'success');
        }
    }
    
    // ========== TEXT FORMATTING FUNCTIONS ==========
    function insertCheckbox(textareaId) {
        const textarea = document.getElementById(textareaId);
        const checkboxText = '[ ] ';
        insertAtCursor(textarea, checkboxText);
        textarea.focus();
    }
    
    function insertBullet(textareaId) {
        const textarea = document.getElementById(textareaId);
        const bulletText = '• ';
        insertAtCursor(textarea, bulletText);
        textarea.focus();
    }
    
    function insertAtCursor(textarea, text) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        
        // If there's selection, replace it with formatted text
        if (start !== end) {
            const selectedText = value.substring(start, end);
            text = text.replace('Checkbox item', selectedText).replace('Bullet item', selectedText);
        }
        
        textarea.value = value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    function renderFormattedNotes(text) {
        if (!text) return 'No notes';
        
        const lines = text.split('\n');
        const formattedLines = lines.map((line, index) => {
            const trimmedLine = line.trim();
            
            // Handle checkboxes [ ] and [x]
            if (trimmedLine.match(/^\[(\s|x)\]/)) {
                const isChecked = trimmedLine.startsWith('[x]');
                const textAfterCheckbox = trimmedLine.replace(/^\[(\s|x)\]\s*/, '');
                return `
                    <div class="custom-checkbox-container" data-line-index="${index}">
                        <div class="custom-checkbox ${isChecked ? 'checked' : ''}" 
                             data-line-index="${index}">
                        </div>
                        <span class="custom-checkbox-text ${isChecked ? 'completed' : ''}" 
                              style="${isChecked ? 'text-decoration: line-through; color: var(--gray);' : ''}">
                            ${textAfterCheckbox}
                        </span>
                    </div>
                `;
            } 
            // Handle bullet points
            else if (trimmedLine.match(/^[•\-\*]\s/)) {
                const textAfterBullet = trimmedLine.replace(/^[•\-\*]\s*/, '');
                return `<div class="notes-bullet">${textAfterBullet}</div>`;
            } 
            // Handle regular text
            else if (trimmedLine) {
                return `<div style="margin: 4px 0; padding: 2px 0;">${line}</div>`;
            }
            // Handle empty lines
            else {
                return `<div style="height: 8px;"></div>`;
            }
        }).join('');
        
        return formattedLines;
    }
    
    function setupCheckboxToggling() {
        document.addEventListener('click', function(e) {
            // Handle custom checkbox clicks
            const checkboxContainer = e.target.closest('.custom-checkbox-container');
            const customCheckbox = e.target.closest('.custom-checkbox');
            
            if (checkboxContainer || customCheckbox) {
                const container = checkboxContainer || customCheckbox.closest('.custom-checkbox-container');
                const lineIndex = parseInt(container.getAttribute('data-line-index'));
                const notesTextarea = document.getElementById('work-notes-input');
                
                if (notesTextarea) {
                    toggleCheckboxInText(notesTextarea, lineIndex);
                }
            }
        });
    }
    
    function toggleCheckboxInText(textarea, lineIndex) {
        const lines = textarea.value.split('\n');
        
        if (lines[lineIndex]) {
            const line = lines[lineIndex];
            
            // Toggle between [ ] and [x]
            if (line.includes('[ ]')) {
                lines[lineIndex] = line.replace('[ ]', '[x]');
            } else if (line.includes('[x]')) {
                lines[lineIndex] = line.replace('[x]', '[ ]');
            }
            
            textarea.value = lines.join('\n');
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Update the display immediately
            updateNotesDisplay();
        }
    }
    
    function updateNotesDisplay() {
        // This would be used if you want a live preview
        // For now, we'll rely on the textarea and format on demand
    }
    
    // ========== QUICK NOTE MODAL FUNCTIONS ==========
    function addQuickNote(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            modalTaskName.textContent = task.name;
            modalNotesInput.value = task.notes || '';
            currentTaskId = taskId;
            
            // Focus and select all text in the textarea
            setTimeout(() => {
                modalNotesInput.focus();
                modalNotesInput.select();
            }, 100);
            
            quickNoteModal.classList.add('active');
        }
    }
    
    function closeQuickNoteModalFunc() {
        quickNoteModal.classList.remove('active');
        currentTaskId = null;
        modalNotesInput.value = '';
    }
    
    function saveQuickNoteFunc() {
        if (currentTaskId) {
            const task = tasks.find(t => t.id === currentTaskId);
            if (task) {
                const newNotes = modalNotesInput.value.trim();
                
                // Only save if there are actual changes
                if (newNotes !== (task.notes || '')) {
                    task.notes = newNotes;
                    saveData();
                    
                    // Update all UI components that show task notes
                    updateWorkTaskList();
                    updateTaskManagement();
                    updateWorkTaskDropdown();
                    
                    showTemporaryMessage('Task notes updated successfully!', 'success');
                } else {
                    showTemporaryMessage('No changes made', 'info');
                }
                
                closeQuickNoteModalFunc();
            }
        }
    }
    
    // ========== PROJECT MANAGEMENT FUNCTIONS ==========
    function openProjectManagement() {
        updateProjectManagement();
        document.getElementById('project-management-modal').classList.add('active');
    }
    
    function closeProjectManagementFunc() {
        document.getElementById('project-management-modal').classList.remove('active');
    }
    
    function createProject() {
        const name = document.getElementById('new-project-name').value.trim();
        if (name && !projects.includes(name)) {
            projects.push(name);
            saveData();
            updateProjectManagement();
            updateWorkProjectDropdown();
            updateTaskManagementFilters();
            document.getElementById('new-project-name').value = '';
            showTemporaryMessage(`Project "${name}" created!`, 'success');
        } else if (projects.includes(name)) {
            showTemporaryMessage('Project already exists!', 'warning');
        }
    }
    
    function deleteProject(projectName) {
        if (confirm(`Are you sure you want to delete project "${projectName}"? This will also remove all tasks in this project.`)) {
            // Remove project from projects array
            projects = projects.filter(p => p !== projectName);
            
            // Remove tasks associated with this project
            tasks = tasks.filter(t => t.project !== projectName);
            
            // Update sessions to change project to "General"
            sessions.forEach(session => {
                if (session.project === projectName) {
                    session.project = 'General';
                }
            });
            
            saveData();
            updateProjectManagement();
            updateWorkProjectDropdown();
            updateTaskManagementFilters();
            updateTaskManagement();
            updateWorkTaskList();
            updateHistoryTable();
            showTemporaryMessage(`Project "${projectName}" deleted!`, 'success');
        }
    }
    
    function updateProjectManagement() {
        const standaloneProjectList = document.getElementById('standalone-project-list');
        
        // Clear the project list
        standaloneProjectList.innerHTML = '';
        
        if (projects.length === 0) {
            standaloneProjectList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder"></i>
                    <p>No projects yet. Add your first project!</p>
                </div>
            `;
            return;
        }
        
        // Create project items for each project
        projects.forEach(project => {
            const projectItem = document.createElement('div');
            projectItem.className = 'project-item';
            
            projectItem.innerHTML = `
                <div class="project-name">${project}</div>
                <div class="project-actions">
                    <button class="icon-btn delete-project" data-project="${project}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            standaloneProjectList.appendChild(projectItem);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-project').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const projectName = e.target.closest('.delete-project').getAttribute('data-project');
                deleteProject(projectName);
            });
        });
    }
    
    function updateWorkProjectDropdown() {
        if (!workProjectSelect) return;
        
        const currentProject = workProjectSelect.value.replace('Project: ', '') || 'General';
        
        // Clear and repopulate
        workProjectSelect.innerHTML = '';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = `Project: ${project}`;
            option.selected = project === currentProject;
            workProjectSelect.appendChild(option);
        });
        
        // Also update task creation dropdown
        const newTaskProject = document.getElementById('new-task-project');
        if (newTaskProject) {
            newTaskProject.innerHTML = '';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                newTaskProject.appendChild(option);
            });
        }
    }
    
    function handleProjectChange() {
        const selectedProject = this.value.replace('Project: ', '');
        
        // Update task list and continue tasks
        updateWorkTaskList();
        updateWorkTaskDropdown();
        
        // Save the change
        saveData();
        
        showTemporaryMessage(`Switched to project: ${selectedProject}`, 'success');
    }
    
    // ========== TASK MANAGEMENT FUNCTIONS ==========
    function openTaskManagement() {
        updateTaskManagement();
        document.getElementById('task-management-modal').classList.add('active');
    }
    
    function closeTaskManagementFunc() {
        document.getElementById('task-management-modal').classList.remove('active');
    }
    
    function createTask() {
        const name = document.getElementById('new-task-name').value.trim();
        const project = document.getElementById('new-task-project').value;
        const notes = document.getElementById('new-task-notes').value.trim();
        
        if (name) {
            const task = {
                id: Date.now(),
                name,
                notes,
                project,
                completed: false,
                status: 'backlog',
                focusTime: 0,
                createdAt: new Date(),
                subtasks: []
            };
            
            tasks.push(task);
            saveData();
            updateTaskManagement();
            updateWorkTaskList();
            updateWorkTaskDropdown();
            updateKanbanBoard();
            
            document.getElementById('new-task-name').value = '';
            document.getElementById('new-task-notes').value = '';
            
            showTemporaryMessage(`Task "${name}" created!`, 'success');
        }
    }

    // ========== SUBTASK FUNCTIONS ==========
    function addSubtask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            // Initialize subtasks array if it doesn't exist
            if (!task.subtasks) {
                task.subtasks = [];
            }
            
            // Add new subtask
            task.subtasks.push({
                name: 'New Subtask',
                completed: false
            });
            
            saveData();
            
            // Refresh all views
            updateTaskManagement();
            updateKanbanBoard(); // <-- ADD THIS
            if (currentTaskId === taskId) {
                updateWorkModeDisplay();
            }
            
            showTemporaryMessage('Subtask added!', 'success');
        }
    }
    
    function updateSubtask(taskId, subtaskIndex, newName) {
        const task = tasks.find(t => t.id === taskId);
        if (task && task.subtasks && task.subtasks[subtaskIndex]) {
            task.subtasks[subtaskIndex].name = newName;
            saveData();
        }
    }
    
    function toggleSubtaskCompletion(taskId, subtaskIndex) {
        const task = tasks.find(t => t.id === taskId);
        if (task && task.subtasks && task.subtasks[subtaskIndex]) {
            task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
            
            // Check if all subtasks are completed, then mark parent task as completed
            if (task.subtasks.every(st => st.completed)) {
                task.completed = true;
            } else {
                task.completed = false;
            }
            
            saveData();
            
            // Refresh all views
            updateTaskManagement();
            updateKanbanBoard(); // <-- ADD THIS
            if (currentTaskId === taskId) {
                updateWorkModeDisplay();
            }
        }
    }
    
    function deleteSubtask(taskId, subtaskIndex) {
        const task = tasks.find(t => t.id === taskId);
        if (task && task.subtasks && task.subtasks[subtaskIndex]) {
            task.subtasks.splice(subtaskIndex, 1);
            saveData();
            
            // Refresh all views
            updateTaskManagement();
            updateKanbanBoard(); // <-- ADD THIS
            if (currentTaskId === taskId) {
                updateWorkModeDisplay();
            }
            
            showTemporaryMessage('Subtask deleted!', 'success');
        }
    }
    
    function updateTaskManagement() {
        const standaloneTaskList = document.getElementById('standalone-task-list');
        
        standaloneTaskList.innerHTML = '';
        
        const projectFilter = document.getElementById('task-filter-project').value;
        const statusFilter = document.getElementById('task-filter-status').value;
        
        // Filter tasks
        let filteredTasks = tasks;
        
        if (projectFilter !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.project === projectFilter);
        }
        
        if (statusFilter === 'active') {
            filteredTasks = filteredTasks.filter(task => !task.completed);
        } else if (statusFilter === 'completed') {
            filteredTasks = filteredTasks.filter(task => task.completed);
        } else if (statusFilter === 'backlog') {
            filteredTasks = filteredTasks.filter(task => task.status === 'backlog' && !task.completed);
        } else if (statusFilter === 'working') {
            filteredTasks = filteredTasks.filter(task => task.status === 'working' && !task.completed);
        }
        
        if (filteredTasks.length === 0) {
            standaloneTaskList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <p>No tasks found</p>
                </div>
            `;
            return;
        }
        
        // Sort tasks: incomplete first, then by creation date
        const sortedTasks = [...filteredTasks].sort((a, b) => {
            if (a.completed !== b.completed) {
                return a.completed ? 1 : -1;
            }
            return b.createdAt - a.createdAt;
        });
        
        sortedTasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = `task-item ${task.completed ? 'task-completed' : ''}`;
            
            // Format notes with bullet points
            let notesHtml = '';
            if (task.notes) {
                const notesLines = task.notes.split('\n').filter(line => line.trim());
                notesHtml = notesLines.map(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('-') || trimmedLine.startsWith('*')) {
                        return `<div class="task-note-line">${trimmedLine.substring(1).trim()}</div>`;
                    }
                    return `<div class="task-note-line">${trimmedLine}</div>`;
                }).join('');
            }
            
            // Format subtasks
            let subtasksHtml = '';
            if (task.subtasks && task.subtasks.length > 0) {
                const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                const totalSubtasks = task.subtasks.length;
                
                subtasksHtml = `
                    <div class="subtasks-section" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 6px; border-left: 3px solid var(--primary-light);">
                        <div class="subtasks-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 0.85rem; color: var(--primary);">Subtasks (${completedSubtasks}/${totalSubtasks})</strong>
                            <button class="icon-btn add-subtask-btn" data-task-id="${task.id}" title="Add Subtask" style="font-size: 0.8rem; padding: 2px 6px;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div class="subtasks-list" id="subtasks-list-${task.id}">
                            ${task.subtasks.map((subtask, index) => `
                                <div class="subtask-item" data-task-id="${task.id}" data-subtask-index="${index}" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 6px; background: white; border-radius: 4px;">
                                    <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} 
                                           data-task-id="${task.id}" data-subtask-index="${index}">
                                    <input type="text" class="subtask-input" value="${subtask.name}" 
                                           data-task-id="${task.id}" data-subtask-index="${index}" 
                                           style="flex: 1; padding: 4px 8px; border: 1px solid var(--gray-light); border-radius: 4px; font-size: 0.85rem;">
                                    <button class="icon-btn delete-subtask-btn" data-task-id="${task.id}" data-subtask-index="${index}" title="Delete Subtask" style="color: var(--danger);">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                subtasksHtml = `
                    <div class="subtasks-section" style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 6px; border-left: 3px solid var(--primary-light);">
                        <div class="subtasks-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 0.85rem; color: var(--primary);">No subtasks yet</strong>
                            <button class="icon-btn add-subtask-btn" data-task-id="${task.id}" title="Add Subtask" style="font-size: 0.8rem; padding: 2px 6px;">
                                <i class="fas fa-plus"></i> Add Subtask
                            </button>
                        </div>
                    </div>
                `;
            }
            
            taskItem.innerHTML = `
                <div class="task-header">
                    <div class="task-content">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <div class="task-details">
                            <div class="task-name">${task.name}</div>
                            <div class="task-project">Project: ${task.project}</div>
                            <div class="task-status" style="font-size: 0.8rem; color: var(--gray); margin-top: 2px;">
                                Status: 
                                <span class="status-badge ${task.status === 'working' ? 'status-working' : 'status-backlog'}">
                                    ${task.status === 'working' ? 'Working' : 'Backlog'}
                                </span>
                            </div>
                            ${notesHtml ? `<div class="task-notes">${notesHtml}</div>` : ''}
                            ${subtasksHtml}
                        </div>
                    </div>
                    <div class="task-actions">
                        <div class="status-toggle-buttons" style="display: flex; gap: 5px; margin-right: 10px;">
                            <button class="status-toggle-btn ${task.status === 'backlog' ? 'active' : ''}" data-task-id="${task.id}" data-status="backlog" title="Move to Backlog">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button class="status-toggle-btn ${task.status === 'working' ? 'active' : ''}" data-task-id="${task.id}" data-status="working" title="Move to Working">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                        <button class="focus-on-btn" data-task-id="${task.id}" title="Focus on this task">
                            <i class="fas fa-bullseye"></i> @Focus
                        </button>
                        <button class="quick-note-btn" data-task-id="${task.id}" title="Edit Notes">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete-task" data-task-id="${task.id}" title="Delete Task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            standaloneTaskList.appendChild(taskItem);
        });
        
        // Add event listeners
        document.querySelectorAll('#standalone-task-list .task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const taskId = parseInt(e.target.closest('.task-item').querySelector('.focus-on-btn').getAttribute('data-task-id'));
                toggleTaskCompletion(taskId);
                updateTaskManagement();
                updateWorkTaskList();
            });
        });
        
        // Add status toggle event listeners
        document.querySelectorAll('#standalone-task-list .status-toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.status-toggle-btn').getAttribute('data-task-id'));
                const newStatus = e.target.closest('.status-toggle-btn').getAttribute('data-status');
                toggleTaskStatus(taskId, newStatus);
            });
        });
        
        document.querySelectorAll('#standalone-task-list .focus-on-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.focus-on-btn').getAttribute('data-task-id'));
                setFocusTask(taskId);
                
                // Optional: Auto-switch to the task's project
                const task = tasks.find(t => t.id === taskId);
                if (task && workProjectSelect.value.replace('Project: ', '') !== task.project) {
                    workProjectSelect.value = `Project: ${task.project}`;
                    updateWorkTaskList();
                    updateWorkTaskDropdown();
                }
                
                showTemporaryMessage(`Now focusing on: ${task.name}`, 'success');
            });
        });
        
        // FIXED: Add event listener to quick note buttons in task management
        document.querySelectorAll('#standalone-task-list .quick-note-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.quick-note-btn').getAttribute('data-task-id'));
                addQuickNote(taskId);
            });
        });
        
        document.querySelectorAll('#standalone-task-list .delete-task').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.delete-task').getAttribute('data-task-id'));
                if (confirm('Are you sure you want to delete this task?')) {
                    deleteTask(taskId);
                    updateTaskManagement();
                }
            });
        });
        
        // ========== SUBTASK EVENT LISTENERS ==========
        // Add subtask event listeners
        document.querySelectorAll('#standalone-task-list .add-subtask-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.add-subtask-btn').getAttribute('data-task-id'));
                addSubtask(taskId);
            });
        });
        
        document.querySelectorAll('#standalone-task-list .subtask-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const taskId = parseInt(e.target.getAttribute('data-task-id'));
                const subtaskIndex = parseInt(e.target.getAttribute('data-subtask-index'));
                toggleSubtaskCompletion(taskId, subtaskIndex);
            });
        });
        
        document.querySelectorAll('#standalone-task-list .subtask-input').forEach(input => {
            // Save on blur (when user clicks away)
            input.addEventListener('blur', (e) => {
                const taskId = parseInt(e.target.getAttribute('data-task-id'));
                const subtaskIndex = parseInt(e.target.getAttribute('data-subtask-index'));
                const newName = e.target.value.trim();
                if (newName) {
                    updateSubtask(taskId, subtaskIndex, newName);
                }
            });
            
            // Save on Enter key press
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur(); // This triggers the blur event above
                }
            });
            
            // Also save on input change (real-time)
            input.addEventListener('input', (e) => {
                const taskId = parseInt(e.target.getAttribute('data-task-id'));
                const subtaskIndex = parseInt(e.target.getAttribute('data-subtask-index'));
                const newName = e.target.value.trim();
                if (newName) {
                    // Use a timeout to avoid saving on every keystroke
                    clearTimeout(input.saveTimeout);
                    input.saveTimeout = setTimeout(() => {
                        updateSubtask(taskId, subtaskIndex, newName);
                    }, 500); // Save 0.5 seconds after user stops typing
                }
            });
        });
        
        document.querySelectorAll('#standalone-task-list .delete-subtask-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const taskId = parseInt(e.target.closest('.delete-subtask-btn').getAttribute('data-task-id'));
                const subtaskIndex = parseInt(e.target.closest('.delete-subtask-btn').getAttribute('data-subtask-index'));
                if (confirm('Are you sure you want to delete this subtask?')) {
                    deleteSubtask(taskId, subtaskIndex);
                }
            });
        });
    }
    
    function updateTaskManagementFilters() {
        // Populate project filter for task management
        const taskFilterProject = document.getElementById('task-filter-project');
        taskFilterProject.innerHTML = '<option value="all">All Projects</option>';
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            taskFilterProject.appendChild(option);
        });
        
        // Also update the task creation dropdown
        const newTaskProject = document.getElementById('new-task-project');
        if (newTaskProject) {
            newTaskProject.innerHTML = '';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                newTaskProject.appendChild(option);
            });
        }
    }
    
    function updateWorkTaskDropdown() {
        if (!workTaskSelect) return;
        
        const currentProject = workProjectSelect.value.replace('Project: ', '') || 'General';
        const projectTasks = tasks.filter(t => t.project === currentProject && !t.completed && t.status === 'working');
        
        // Save current selection
        const currentValue = workTaskSelect.value;
        
        // Clear and repopulate
        workTaskSelect.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Task: Select a task';
        defaultOption.selected = !currentTaskId;
        workTaskSelect.appendChild(defaultOption);
        
        // Add tasks
        projectTasks.forEach(task => {
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = `Task: ${task.name}`;
            option.selected = task.id === currentTaskId;
            workTaskSelect.appendChild(option);
        });
    }
    
    function handleTaskChange() {
        const selectedTaskId = this.value ? parseInt(this.value) : null;
        
        if (selectedTaskId) {
            setFocusTask(selectedTaskId);
        } else {
            currentTaskId = null;
            updateWorkModeDisplay();
            showTemporaryMessage('No task selected', 'info');
        }
    }
    
    // ========== HISTORY FUNCTIONS ==========
    function updateHistoryTable() {
        workHistoryTable.innerHTML = '';
        
        // Get filter values
        const projectFilter = historyProjectFilter.value;
        const taskFilter = historyTaskFilter.value;
        const dateFilter = historyDateFilter.value;
        
        // Filter sessions
        let filteredSessions = sessions.filter(session => {
            // Project filter
            if (projectFilter !== 'all' && session.project !== projectFilter) {
                return false;
            }
            
            // Task filter
            if (taskFilter !== 'all') {
                const hasMatchingTask = session.tasks && session.tasks.some(task => 
                    task.name.toLowerCase().includes(taskFilter.toLowerCase())
                );
                if (!hasMatchingTask) return false;
            }
            
            // Date filter
            if (dateFilter !== 'all') {
                const sessionDate = new Date(session.startTime);
                const today = new Date();
                
                switch(dateFilter) {
                    case 'today':
                        if (sessionDate.toDateString() !== today.toDateString()) return false;
                        break;
                    case 'week':
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(today.getDate() - today.getDay());
                        startOfWeek.setHours(0, 0, 0, 0);
                        if (sessionDate < startOfWeek) return false;
                        break;
                    case 'month':
                        if (sessionDate.getMonth() !== today.getMonth() || 
                            sessionDate.getFullYear() !== today.getFullYear()) return false;
                        break;
                }
            }
            
            return true;
        });
        
        // Update stats
        updateHistoryStats(filteredSessions);
        
        if (filteredSessions.length === 0) {
            workHistoryTable.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>No sessions found matching your filters</p>
                        <button class="btn btn-primary" id="reset-filters-btn" style="margin-top: 10px;">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </td>
                </tr>
            `;
            
            // Add event listener to reset button
            document.getElementById('reset-filters-btn')?.addEventListener('click', clearHistoryFilters);
            return;
        }
        
        // Sort sessions by date (newest first)
        const sortedSessions = [...filteredSessions].sort((a, b) => 
            new Date(b.startTime) - new Date(a.startTime)
        );
        
        sortedSessions.forEach(session => {
            const date = new Date(session.startTime);
            const dateStr = date.toLocaleDateString();
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Format session details
            const focusTime = Math.floor(session.duration / 60);
            const completedTasks = session.tasks ? session.tasks.filter(t => t.completed).length : 0;
            const totalTasks = session.tasks ? session.tasks.length : 0;
            
            // Get the working task (only one)
            let workingTask = null;
            if (session.tasks && session.tasks.length > 0) {
                workingTask = session.tasks.find(t => t.status === 'working' && !t.completed);
                if (!workingTask) {
                    // If no working task, get the first task
                    workingTask = session.tasks[0];
                }
            }
            
            // Format task notes - use stored taskNotes if available, otherwise generate from tasks
            let taskNotesHtml = session.taskNotes || '';
            if (!taskNotesHtml && workingTask && workingTask.notes && workingTask.notes.trim() !== '') {
                taskNotesHtml = workingTask.notes.split('\n').map(note => 
                    note.trim() !== '' ? `<div class="task-note-bullet">${note}</div>` : ''
                ).join('');
            }
            
            // Format work notes with line breaks
            const workNotes = session.workNotes || '';
            const workNotesHtml = workNotes ? workNotes.split('\n').map(line => 
                line.trim() !== '' ? `<div style="margin-bottom: 4px;">${line}</div>` : '<div style="margin-bottom: 4px;">&nbsp;</div>'
            ).join('') : 'No work notes';
            
            // Format ideas with line breaks - FIXED compact display
            const ideas = session.ideas || [];
            let ideasHtml = '';
            if (ideas.length > 0) {
                ideasHtml = ideas.map(idea => {
                    let ideaContent;
                    if (typeof idea === 'string') {
                        ideaContent = idea;
                    } else if (idea && typeof idea === 'object' && idea.content) {
                        ideaContent = idea.content;
                    } else {
                        ideaContent = 'No content';
                    }
                    
                    // Remove any extra whitespace and ensure clean content
                    ideaContent = ideaContent.trim();
                    
                    // Compact display with proper separation
                    return `<div class="idea-item-compact">${ideaContent}</div>`;
                }).join('');
            } else {
                ideasHtml = 'No ideas recorded';
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="editable-field" contenteditable="true" data-session-id="${session.id}" data-field="date">${dateStr}</div>
                    <div class="editable-field" contenteditable="true" data-session-id="${session.id}" data-field="time" style="font-size: 0.8rem; color: var(--gray);">${timeStr}</div>
                    <div class="history-save-indicator" data-session-id="${session.id}">Saved</div>
                </td>
                <td>
                    <div class="editable-field" contenteditable="true" data-session-id="${session.id}" data-field="project">${session.project}</div>
                </td>
                <td class="session-details-cell">
                    <div class="editable-field" contenteditable="true" data-session-id="${session.id}" data-field="focusTime"><strong>Focus:</strong> ${focusTime} min</div>
                    <div class="editable-field" contenteditable="true" data-session-id="${session.id}" data-field="tasks"><strong>Tasks:</strong> ${completedTasks}/${totalTasks} completed</div>
                    ${workingTask ? `
                        <div class="working-task-display">
                            <div class="working-task-name">Working Task: ${workingTask.name}</div>
                        </div>
                    ` : ''}
                </td>
                <td class="task-notes-cell">
                    ${workingTask ? `<div class="task-notes-header">${workingTask.name}</div>` : ''}
                    <div class="editable-field editable-textarea" contenteditable="true" data-session-id="${session.id}" data-field="taskNotes" style="white-space: pre-wrap; vertical-align: top;">${taskNotesHtml || 'No task notes'}</div>
                </td>
                <td class="work-notes-cell">
                    <div class="editable-field editable-textarea" contenteditable="true" data-session-id="${session.id}" data-field="workNotes" style="white-space: pre-wrap;">${workNotes || 'No work notes'}</div>
                </td>
                <td class="ideas-cell">
                    <div class="editable-field editable-textarea" contenteditable="true" data-session-id="${session.id}" data-field="ideas" style="white-space: pre-wrap; padding: 0; margin: 0;">${ideasHtml}</div>
                </td>
                <td>
                    <button class="icon-btn delete-session" data-session-id="${session.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            workHistoryTable.appendChild(row);
        });
        
        // Add event listeners to editable fields
        document.querySelectorAll('.editable-field').forEach(field => {
            field.addEventListener('input', handleHistoryFieldEdit);
            field.addEventListener('blur', handleHistoryFieldBlur);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-session').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const sessionId = parseInt(e.target.closest('.delete-session').getAttribute('data-session-id'));
                deleteSession(sessionId);
            });
        });
        
        // Update filter dropdowns
        updateHistoryFilters();
    }
    
    function updateHistoryStats(filteredSessions) {
        if (!historyStats) return;
        
        const totalSessions = filteredSessions.length;
        const totalFocusTime = filteredSessions.reduce((sum, session) => sum + Math.floor(session.duration / 60), 0);
        const totalTasks = filteredSessions.reduce((sum, session) => sum + (session.tasks ? session.tasks.length : 0), 0);
        const completedTasks = filteredSessions.reduce((sum, session) => sum + (session.tasks ? session.tasks.filter(t => t.completed).length : 0), 0);
        
        historyStats.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${totalSessions}</div>
                <div class="stat-label">Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${totalFocusTime}</div>
                <div class="stat-label">Focus Minutes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${totalTasks}</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${completedTasks}</div>
                <div class="stat-label">Completed Tasks</div>
            </div>
        `;
    }
    
    function updateHistoryFilters() {
        if (!historyProjectFilter || !historyTaskFilter) return;
        
        // Update project filter
        const currentProject = historyProjectFilter.value;
        historyProjectFilter.innerHTML = '<option value="all">All Projects</option>';
        
        // Get unique projects from sessions
        const sessionProjects = [...new Set(sessions.map(session => session.project))];
        sessionProjects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            option.selected = project === currentProject;
            historyProjectFilter.appendChild(option);
        });
        
        // Update task filter
        const currentTask = historyTaskFilter.value;
        historyTaskFilter.innerHTML = '<option value="all">All Tasks</option>';
        
        // Get unique task names from sessions
        const taskNames = new Set();
        sessions.forEach(session => {
            if (session.tasks) {
                session.tasks.forEach(task => {
                    if (task.name) {
                        taskNames.add(task.name);
                    }
                });
            }
        });
        
        // Convert Set to Array and sort alphabetically
        const sortedTaskNames = [...taskNames].sort();
        sortedTaskNames.forEach(taskName => {
            const option = document.createElement('option');
            option.value = taskName;
            option.textContent = taskName;
            option.selected = taskName === currentTask;
            historyTaskFilter.appendChild(option);
        });
    }
    
    function clearHistoryFilters() {
        historyProjectFilter.value = 'all';
        historyTaskFilter.value = 'all';
        historyDateFilter.value = 'all';
        updateHistoryTable();
        showTemporaryMessage('Filters cleared', 'success');
    }
    
    // Handle editing of history fields
    function handleHistoryFieldEdit(e) {
        const field = e.target;
        const sessionId = parseInt(field.getAttribute('data-session-id'));
        const fieldType = field.getAttribute('data-field');
        
        // Clear any existing timeout for this session
        if (historySaveTimeouts[sessionId]) {
            clearTimeout(historySaveTimeouts[sessionId]);
        }
        
        // Show saving indicator
        const saveIndicator = document.querySelector(`.history-save-indicator[data-session-id="${sessionId}"]`);
        if (saveIndicator) {
            saveIndicator.textContent = 'Saving...';
            saveIndicator.style.color = 'var(--warning)';
            saveIndicator.classList.add('visible');
        }
        
        // Set a timeout to save the changes
        historySaveTimeouts[sessionId] = setTimeout(() => {
            saveHistoryField(sessionId, fieldType, field.textContent || field.innerText);
        }, 1000);
    }
    
    // Handle blur event for history fields (save immediately)
    function handleHistoryFieldBlur(e) {
        const field = e.target;
        const sessionId = parseInt(field.getAttribute('data-session-id'));
        const fieldType = field.getAttribute('data-field');
        
        // Clear any existing timeout for this session
        if (historySaveTimeouts[sessionId]) {
            clearTimeout(historySaveTimeouts[sessionId]);
        }
        
        // Save immediately
        saveHistoryField(sessionId, fieldType, field.textContent || field.innerText);
    }
    
    // Save a specific history field
    function saveHistoryField(sessionId, fieldType, value) {
        const session = sessions.find(s => s.id === sessionId);
        if (!session) return;
        
        switch(fieldType) {
            case 'date':
                // Parse date string and update session startTime
                try {
                    // Try different date formats
                    const dateFormats = [
                        value,
                        value.replace(/(\d+)\/(\d+)\/(\d+)/, '$1/$2/$3')
                    ];
                    
                    let newDate = null;
                    for (const format of dateFormats) {
                        newDate = new Date(format);
                        if (!isNaN(newDate.getTime())) break;
                    }
                    
                    if (newDate && !isNaN(newDate.getTime())) {
                        // Keep the original time, just update the date
                        const originalTime = new Date(session.startTime);
                        newDate.setHours(originalTime.getHours());
                        newDate.setMinutes(originalTime.getMinutes());
                        newDate.setSeconds(originalTime.getSeconds());
                        
                        session.startTime = newDate;
                    }
                } catch (e) {
                    console.error('Error parsing date:', e);
                }
                break;
                
            case 'time':
                // Parse time string and update session startTime
                try {
                    const timeMatch = value.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                    if (timeMatch) {
                        let hours = parseInt(timeMatch[1]);
                        const minutes = parseInt(timeMatch[2]);
                        const modifier = timeMatch[3] ? timeMatch[3].toUpperCase() : '';
                        
                        // Convert to 24-hour format if needed
                        if (modifier === 'PM' && hours < 12) hours += 12;
                        if (modifier === 'AM' && hours === 12) hours = 0;
                        
                        const newDate = new Date(session.startTime);
                        newDate.setHours(hours);
                        newDate.setMinutes(minutes);
                        session.startTime = newDate;
                    }
                } catch (e) {
                    console.error('Error parsing time:', e);
                }
                break;
                
            case 'project':
                session.project = value;
                break;
                
            case 'focusTime':
                // Extract minutes from text like "Focus: 25 min"
                const focusMatch = value.match(/(\d+)\s*min/);
                if (focusMatch) {
                    session.duration = parseInt(focusMatch[1]) * 60;
                }
                break;
                
            case 'tasks':
                // Store the task summary text as-is
                session.taskSummary = value;
                break;
                
            case 'taskNotes':
                session.taskNotes = value;
                break;
                
            case 'workNotes':
                session.workNotes = value;
                break;
                
            case 'ideas':
                // Parse ideas from the text content
                if (value && value !== 'No ideas recorded') {
                    const ideaLines = value.split('\n').filter(line => line.trim());
                    session.ideas = ideaLines.map(line => ({
                        id: Date.now() + Math.random(),
                        content: line.trim(),
                        createdAt: new Date()
                    }));
                } else {
                    session.ideas = [];
                }
                break;
        }
        
        // Save to localStorage
        saveData();
        
        // Update save indicator
        const saveIndicator = document.querySelector(`.history-save-indicator[data-session-id="${sessionId}"]`);
        if (saveIndicator) {
            saveIndicator.textContent = 'Saved';
            saveIndicator.style.color = 'var(--success)';
            saveIndicator.classList.add('visible');
            
            // Hide after 2 seconds
            setTimeout(() => {
                saveIndicator.classList.remove('visible');
            }, 2000);
        }
        
        // Show temporary message
        showTemporaryMessage('Session updated!', 'success');
    }
    
    function deleteSession(sessionId) {
        sessions = sessions.filter(s => s.id !== sessionId);
        saveData();
        updateHistoryTable();
    }
    
    // ========== SETTINGS FUNCTIONS ==========
    function openSettings() {
        document.getElementById('settings-modal').classList.add('active');
    }
    
    function closeSettingsFunc() {
        document.getElementById('settings-modal').classList.remove('active');
    }
    
    function saveSettings() {
        // Update timer with new settings
        if (isFocusMode) {
            timeLeft = parseInt(focusTimeInput.value) * 60;
        } else {
            timeLeft = parseInt(breakTimeInput.value) * 60;
        }
        totalTime = timeLeft;
        updateTimerDisplay();
        
        saveData();
        showTemporaryMessage('Settings saved!', 'success');
        closeSettingsFunc();
    }
    
    function updateTimerSettings() {
        if (!isRunning) {
            if (isFocusMode) {
                timeLeft = parseInt(focusTimeInput.value) * 60;
            } else {
                timeLeft = parseInt(breakTimeInput.value) * 60;
            }
            totalTime = timeLeft;
            updateTimerDisplay();
        }
    }
    
    function exportData() {
        const data = {
            tasks,
            sessions,
            projects,
            workNotes,
            ideas,
            settings: {
                focusTime: parseInt(focusTimeInput.value),
                breakTime: parseInt(breakTimeInput.value),
                soundEnabled: soundToggle.checked,
                tickSoundEnabled: tickSoundToggle.checked
            },
            instance: CURRENT_INSTANCE
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        // Generate filename with current date in YYYYMMDD format
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const filename = `Focusflow-${CURRENT_INSTANCE}-${year}${month}${day}.json`;
        
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showTemporaryMessage(`Data exported as ${filename}!`, "success");
    }
    
    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Load data
                    tasks = data.tasks || [];
                    sessions = data.sessions || [];
                    projects = data.projects || ['General'];
                    workNotes = data.workNotes || '';
                    ideas = data.ideas || [];
                    
                    // Ensure all existing tasks have a status and subtasks
                    tasks.forEach(task => {
                        if (!task.status) {
                            task.status = 'backlog';
                        }
                        if (!task.subtasks) {
                            task.subtasks = [];
                        }
                    });
                    
                    if (data.settings) {
                        focusTimeInput.value = data.settings.focusTime || 25;
                        breakTimeInput.value = data.settings.breakTime || 5;
                        soundToggle.checked = data.settings.soundEnabled !== false;
                        tickSoundToggle.checked = data.settings.tickSoundEnabled !== false;
                    }
                    
                    // Update timer with loaded settings
                    timeLeft = parseInt(focusTimeInput.value) * 60;
                    totalTime = timeLeft;
                    updateTimerDisplay();
                    
                    // Update ALL UI components
                    updateWorkModeDisplay();
                    updateProjectManagement();
                    updateTaskManagement();
                    updateWorkProjectDropdown();
                    updateWorkTaskDropdown();
                    updateTaskManagementFilters();
                    
                    // Update work notes textarea
                    if (workNotesInput) {
                        workNotesInput.value = workNotes;
                    }
                    
                    // Update ideas list
                    updateIdeasList();
                    
                    // Save the loaded data
                    saveData();
                    
                    showTemporaryMessage("Data imported successfully!", "success");
                } catch (error) {
                    showTemporaryMessage("Error importing data file", "warning");
                    console.error("Error importing data:", error);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    function clearData() {
        if (confirm('Are you sure you want to clear ALL data? This action cannot be undone.')) {
            tasks = [];
            sessions = [];
            projects = ['General'];
            workNotes = '';
            ideas = [];
            
            // Reset to default settings
            focusTimeInput.value = 25;
            breakTimeInput.value = 5;
            soundToggle.checked = true;
            tickSoundToggle.checked = true;
            
            // Update timer
            timeLeft = 25 * 60;
            totalTime = timeLeft;
            updateTimerDisplay();
            
            // Update ALL UI components
            updateWorkModeDisplay();
            updateProjectManagement();
            updateTaskManagement();
            updateWorkProjectDropdown();
            updateWorkTaskDropdown();
            updateTaskManagementFilters();
            
            // Save cleared data
            saveData();
            
            showTemporaryMessage("All data cleared!", "success");
        }
    }
    
    // ========== NOTIFICATION FUNCTIONS ==========
    function showTimeUpNotification(message) {
        timeUpNotification.textContent = message;
        timeUpNotification.classList.remove('hidden');
        
        setTimeout(() => {
            timeUpNotification.classList.add('hidden');
        }, 3000);
    }
    
    function showTemporaryMessage(message, type = 'info') {
        // Create a temporary message element
        const messageEl = document.createElement('div');
        messageEl.textContent = message;
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--primary)'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1005;
            font-weight: 500;
        `;
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            document.body.removeChild(messageEl);
        }, 3000);
    }
    
    // ========== AUTO-SAVE FUNCTIONS ==========
    function initAutoSave() {
        // Set up auto-save for work notes
        if (workNotesInput) {
            workNotesInput.addEventListener('input', function() {
                clearTimeout(workNotesSaveTimeout);
                showSaveIndicator(workNotesSaveIndicator, 'saving');
                
                workNotesSaveTimeout = setTimeout(() => {
                    workNotes = workNotesInput.value;
                    saveData();
                    showSaveIndicator(workNotesSaveIndicator, 'saved');
                }, 1000);
            });
            
            // Also save on blur
            workNotesInput.addEventListener('blur', function() {
                clearTimeout(workNotesSaveTimeout);
                workNotes = workNotesInput.value;
                saveData();
                showSaveIndicator(workNotesSaveIndicator, 'saved');
            });
        }
        
        // Show initial state
        showSaveIndicator(workNotesSaveIndicator, 'saved');
    }
    
    // Show save status indicator
    function showSaveIndicator(saveIndicator, status) {
        if (!saveIndicator) return;
        
        // Remove all status classes
        saveIndicator.classList.remove('saving', 'saved', 'error', 'visible');
        
        // Add the current status class and make visible
        saveIndicator.classList.add(status, 'visible');
        
        // Update text based on status
        const saveText = saveIndicator.querySelector('.save-text');
        if (saveText) {
            switch(status) {
                case 'saving':
                    saveText.textContent = 'Saving...';
                    break;
                case 'saved':
                    saveText.textContent = 'Auto-save enabled';
                    break;
                case 'error':
                    saveText.textContent = 'Error saving';
                    break;
            }
        }
        
        // If saved, keep visible for a moment then fade out
        if (status === 'saved') {
            setTimeout(() => {
                saveIndicator.classList.remove('visible');
            }, 2000);
        }
    }
    
    // ========== KANBAN BOARD FUNCTIONS ==========
    function updateKanbanBoard() {
        const projectFilter = kanbanProjectFilter.value;
        kanbanBoard.innerHTML = '';
        
        // Define kanban columns
        const columns = [
            { id: 'backlog', title: 'Backlog', status: 'backlog' },
            { id: 'working', title: 'Working', status: 'working' },
            { id: 'review', title: 'Review', status: 'review' },
            { id: 'completed', title: 'Completed', status: 'completed' }
        ];
        
        // Filter tasks
        let filteredTasks = tasks;
        if (projectFilter !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.project === projectFilter);
        }
        
        // Create columns
        columns.forEach(column => {
            const columnTasks = filteredTasks.filter(task => task.status === column.status);
            
            const columnEl = document.createElement('div');
            columnEl.className = 'kanban-column';
            columnEl.setAttribute('data-status', column.status);
            columnEl.setAttribute('id', `kanban-column-${column.status}`);
            
            columnEl.innerHTML = `
                <div class="kanban-column-header">
                    <span>${column.title}</span>
                    <span class="task-count">${columnTasks.length}</span>
                </div>
                <div class="kanban-column-content" data-status="${column.status}">
                    ${columnTasks.length === 0 ? `
                        <div class="kanban-column-empty">
                            <i class="fas fa-inbox"></i>
                            <p>No tasks</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            kanbanBoard.appendChild(columnEl);
            
            // Add tasks to column
            const columnContent = columnEl.querySelector('.kanban-column-content');
            columnTasks.forEach(task => {
                columnContent.appendChild(createKanbanTaskHTML(task));
            });
        });
        
        // Update project filter dropdown
        updateKanbanProjectFilter();
        
        // Initialize drag and drop
        initKanbanDragAndDrop();
        
        // ========== ADD KANBAN SUBTASK EVENT LISTENERS ==========
        // Add event listeners for kanban subtask actions
        document.querySelectorAll('.kanban-subtask-action').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering drag events
                
                const taskId = parseInt(btn.getAttribute('data-task-id'));
                const action = btn.getAttribute('data-action');
                
                if (action === 'add') {
                    // Add new subtask
                    addSubtask(taskId);
                    
                    // Refresh kanban board after a short delay
                    setTimeout(() => {
                        updateKanbanBoard();
                    }, 300);
                } else if (action === 'toggle') {
                    // Toggle all subtasks completion
                    const task = tasks.find(t => t.id === taskId);
                    if (task && task.subtasks && task.subtasks.length > 0) {
                        const allCompleted = task.subtasks.every(st => st.completed);
                        
                        task.subtasks.forEach(subtask => {
                            subtask.completed = !allCompleted;
                        });
                        
                        // Update parent task completion status
                        task.completed = !allCompleted;
                        
                        saveData();
                        
                        // Refresh kanban board and other views
                        setTimeout(() => {
                            updateKanbanBoard();
                            updateTaskManagement();
                            if (currentTaskId === taskId) {
                                updateWorkModeDisplay();
                            }
                        }, 300);
                        
                        showTemporaryMessage(`All subtasks ${!allCompleted ? 'completed' : 'marked incomplete'}!`, 'success');
                    }
                }
            });
        });
        
        // Add click event to subtask items to toggle completion
        document.querySelectorAll('.kanban-subtask-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering drag events
                
                const taskId = parseInt(item.closest('.kanban-task').getAttribute('data-task-id'));
                const subtaskIndex = Array.from(item.parentElement.children).indexOf(item);
                
                // Don't count the "more subtasks" message as a subtask
                const task = tasks.find(t => t.id === taskId);
                if (task && task.subtasks && subtaskIndex < task.subtasks.length) {
                    toggleSubtaskCompletion(taskId, subtaskIndex);
                    
                    // Refresh kanban board after a short delay
                    setTimeout(() => {
                        updateKanbanBoard();
                    }, 300);
                }
            });
        });
    }
    
    function createKanbanTaskHTML(task) {
        const taskEl = document.createElement('div');
        taskEl.className = 'kanban-task';
        taskEl.setAttribute('data-task-id', task.id);
        taskEl.setAttribute('data-status', task.status);
        taskEl.setAttribute('draggable', 'true');
        
        // Format notes for display
        let notesHtml = '';
        if (task.notes) {
            const notesLines = task.notes.split('\n').filter(line => line.trim());
            if (notesLines.length > 0) {
                notesHtml = '<div class="kanban-task-notes">';
                notesHtml += notesLines.slice(0, 3).map(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('-') || trimmedLine.startsWith('*') || trimmedLine.startsWith('•')) {
                        return `<div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 4px;">
                            <span style="color: var(--primary); flex-shrink: 0;">•</span>
                            <span style="flex: 1;">${trimmedLine.substring(1).trim()}</span>
                        </div>`;
                    } else if (trimmedLine.startsWith('[ ]') || trimmedLine.startsWith('[x]')) {
                        const isChecked = trimmedLine.startsWith('[x]');
                        const textAfter = trimmedLine.substring(3).trim();
                        return `<div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 4px;">
                            <span style="color: ${isChecked ? 'var(--success)' : 'var(--primary)'}; flex-shrink: 0;">
                                ${isChecked ? '✓' : '☐'}
                            </span>
                            <span style="flex: 1; ${isChecked ? 'text-decoration: line-through; color: var(--gray);' : ''}">
                                ${textAfter}
                            </span>
                        </div>`;
                    } else {
                        return `<div style="margin-bottom: 4px;">${trimmedLine}</div>`;
                    }
                }).join('');
                if (notesLines.length > 3) {
                    notesHtml += `<div style="font-size: 0.8rem; color: var(--gray);">+${notesLines.length - 3} more lines...</div>`;
                }
                notesHtml += '</div>';
            }
        }
        
        // ========== ADD SUBTASKS TO KANBAN TASK ==========
        // Format subtasks for display
        let subtasksHtml = '';
        if (task.subtasks && task.subtasks.length > 0) {
            const completedSubtasks = task.subtasks.filter(st => st.completed).length;
            const totalSubtasks = task.subtasks.length;
            const progressPercentage = Math.round((completedSubtasks / totalSubtasks) * 100);
            
            // Show only a few subtasks (max 3) with a "more" indicator
            const visibleSubtasks = task.subtasks.slice(0, 3);
            
            subtasksHtml = `
                <div class="kanban-subtasks" style="margin-top: 10px; padding: 10px; background: rgba(248, 150, 30, 0.05); border-radius: 6px; border-left: 3px solid var(--warning);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-size: 0.8rem; font-weight: 600; color: var(--warning);">
                            <i class="fas fa-list-check"></i> Subtasks (${completedSubtasks}/${totalSubtasks})
                        </div>
                        <div style="font-size: 0.7rem; color: var(--gray);">
                            ${progressPercentage}%
                        </div>
                    </div>
                    
                    <!-- Progress bar -->
                    <div style="width: 100%; height: 4px; background: var(--gray-light); border-radius: 2px; margin-bottom: 10px; overflow: hidden;">
                        <div style="width: ${progressPercentage}%; height: 100%; background: var(--success); transition: width 0.3s ease;"></div>
                    </div>
                    
                    <!-- Subtask list -->
                    <div class="kanban-subtask-list" style="max-height: 100px; overflow-y: auto;">
                        ${visibleSubtasks.map((subtask, index) => `
                            <div class="kanban-subtask-item" style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; padding: 4px; border-radius: 4px; background: ${subtask.completed ? 'rgba(76, 201, 240, 0.1)' : 'white'};">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${subtask.completed ? 'var(--success)' : 'var(--warning)'}; flex-shrink: 0;"></div>
                                <span style="flex: 1; font-size: 0.8rem; ${subtask.completed ? 'text-decoration: line-through; color: var(--gray);' : 'color: var(--dark);'}">
                                    ${subtask.name.length > 30 ? subtask.name.substring(0, 30) + '...' : subtask.name}
                                </span>
                            </div>
                        `).join('')}
                        
                        ${task.subtasks.length > 3 ? `
                            <div style="text-align: center; font-size: 0.75rem; color: var(--gray); padding: 4px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                +${task.subtasks.length - 3} more subtasks
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Quick actions -->
                    <div style="display: flex; gap: 5px; margin-top: 8px;">
                        <button class="kanban-subtask-action" data-task-id="${task.id}" data-action="add" title="Add Subtask" style="flex: 1; padding: 4px; background: var(--warning); color: white; border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">
                            <i class="fas fa-plus"></i> Add
                        </button>
                        <button class="kanban-subtask-action" data-task-id="${task.id}" data-action="toggle" title="Toggle All" style="flex: 1; padding: 4px; background: var(--primary-light); color: white; border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">
                            <i class="fas fa-check-double"></i> Toggle
                        </button>
                    </div>
                </div>
            `;
        } else {
            // No subtasks - show add button
            subtasksHtml = `
                <div class="kanban-subtasks" style="margin-top: 10px; padding: 10px; background: rgba(248, 150, 30, 0.05); border-radius: 6px; border-left: 3px solid var(--warning); text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 8px;">
                        <i class="fas fa-list-check"></i> No subtasks
                    </div>
                    <button class="kanban-subtask-action" data-task-id="${task.id}" data-action="add" title="Add Subtask" style="width: 100%; padding: 6px; background: var(--warning); color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                        <i class="fas fa-plus"></i> Add Subtask
                    </button>
                </div>
            `;
        }
        
        taskEl.innerHTML = `
            <div class="kanban-task-header">
                <div class="kanban-task-name">${task.name}</div>
                <div class="kanban-task-actions">
                    <button class="kanban-task-action edit-task" data-task-id="${task.id}" title="Edit Task">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="kanban-task-action delete-task" data-task-id="${task.id}" title="Delete Task">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="kanban-task-project">${task.project}</div>
            ${notesHtml}
            ${subtasksHtml}
            <div class="kanban-task-status" style="font-size: 0.8rem; margin-top: 8px; color: var(--gray);">
                ${task.completed ? '<i class="fas fa-check-circle" style="color: var(--success);"></i> Completed' : 
                  '<i class="fas fa-clock" style="color: var(--warning);"></i> Active'}
            </div>
        `;
        
        return taskEl;
    }
    
    function initKanbanDragAndDrop() {
        const tasks = document.querySelectorAll('.kanban-task');
        const columns = document.querySelectorAll('.kanban-column-content');
        
        tasks.forEach(task => {
            task.addEventListener('dragstart', handleDragStart);
            task.addEventListener('dragend', handleDragEnd);
        });
        
        columns.forEach(column => {
            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('dragenter', handleDragEnter);
            column.addEventListener('dragleave', handleDragLeave);
            column.addEventListener('drop', handleDrop);
        });
    }
    
    let draggedTask = null;
    
    function handleDragStart(e) {
        draggedTask = this;
        this.classList.add('dragging');
        
        // Set data transfer
        e.dataTransfer.setData('text/plain', this.getAttribute('data-task-id'));
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd() {
        this.classList.remove('dragging');
        
        // Remove 'over' class from all columns
        document.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('over');
        });
        
        draggedTask = null;
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        this.parentElement.classList.add('over');
    }
    
    function handleDragLeave() {
        this.parentElement.classList.remove('over');
    }
    
    function handleDrop(e) {
        e.preventDefault();
        
        // Get task ID and new status
        const taskId = parseInt(e.dataTransfer.getData('text/plain'));
        const newStatus = this.getAttribute('data-status');
        
        // Update task status
        toggleTaskStatus(taskId, newStatus);
        
        // Remove 'over' class
        this.parentElement.classList.remove('over');
    }
    
    function updateKanbanProjectFilter() {
        kanbanProjectFilter.innerHTML = '<option value="all">All Projects</option>';
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            kanbanProjectFilter.appendChild(option);
        });
    }
    
    // ========== APP POPUP FUNCTIONS ==========
    function showPopupHelp() {
        if (confirm('Popups seem to be blocked. Would you like instructions on how to enable them?')) {
            const helpMessage = `
    To enable popups for this site:
    
    Chrome:
    1. Click the lock icon in the address bar
    2. Click "Site settings"
    3. Change "Popups and redirects" to "Allow"
    
    Firefox:
    1. Click the shield icon in the address bar
    2. Click "Options" or "Change Blocking Settings"
    3. Uncheck "Block pop-up windows"
    
    Edge:
    1. Click the lock icon in the address bar
    2. Click "Permissions for this site"
    3. Change "Pop-ups and redirects" to "Allow"
    
    Safari:
    1. Go to Safari > Preferences > Websites
    2. Click "Pop-up Windows"
    3. Find this site and change to "Allow"
            `;
            alert(helpMessage);
        }
    }
    
    function openAppWithPopup(url, windowName, features, appName) {
        return new Promise((resolve) => {
            try {
                const popup = window.open(url, windowName, features);
                
                // Check if popup was blocked
                if (!popup || popup.closed || typeof popup.closed === 'undefined') {
                    showTemporaryMessage(`Popup blocked! Please allow popups for ${appName}`, 'warning');
                    showPopupHelp();
                    resolve(false);
                    return;
                }
                
                // Check if popup loaded successfully
                const checkPopup = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkPopup);
                        showTemporaryMessage(`${appName} window was closed`, 'info');
                        resolve(false);
                    } else if (popup.document.readyState === 'complete') {
                        clearInterval(checkPopup);
                        showTemporaryMessage(`${appName} opened successfully!`, 'success');
                        popup.focus();
                        resolve(true);
                    }
                }, 100);
                
                // Timeout after 3 seconds
                setTimeout(() => {
                    clearInterval(checkPopup);
                    if (!popup.closed && popup.document.readyState !== 'complete') {
                        showTemporaryMessage(`${appName} is loading...`, 'info');
                    }
                }, 3000);
                
            } catch (error) {
                console.error(`Error opening ${appName}:`, error);
                showTemporaryMessage(`Error opening ${appName}`, 'warning');
                resolve(false);
            }
        });
    }
    
    function openChatApp() {
        openAppWithPopup(
            'self-chat v209T10.html', 
            'SelfChat', 
            'width=800,height=600,resizable=yes,scrollbars=yes',
            'Self Chat'
        );
    }
    
    function openTodoList() {
        openAppWithPopup(
            'Todolist-m63b12.html', 
            'TodoList', 
            'width=800,height=600,resizable=yes,scrollbars=yes',
            'Todo List'
        );
    }
    
    function openDailyTodo() {
        openAppWithPopup(
            'Dailytodo-v54.html', 
            'DailyTodo', 
            'width=800,height=600,resizable=yes,scrollbars=yes',
            'Daily Todo'
        );
    }
    
    function openFlock() {
        openAppWithPopup(
            'https://web.flock.com/', 
            'Flock', 
            'width=1200,height=800,resizable=yes,scrollbars=yes',
            'Flock'
        );
    }
    
    function openTimeStripe() {
        openAppWithPopup(
            'https://timestripe.com/horizons/', 
            'TimeStripeHorizons', 
            'width=1200,height=800,resizable=yes,scrollbars=yes',
            'TimeStripe Horizons'
        );
    }
    
    function openPDCA() {
        openAppWithPopup(
            'https://yangwm2005.github.io/p/PDCA-2f%20v1.html', 
            'PDCAPlanner', 
            'width=1000,height=700,resizable=yes,scrollbars=yes',
            'PDCA Planner'
        );
    }
    
    // Add to APP POPUP FUNCTIONS section
function openQTodo() {
    openAppWithPopup(
        'Q-todo-v17.html', 
        'QTodo', 
        'width=800,height=600,resizable=yes,scrollbars=yes',
        'Q-Todo'
    );
}

function openRemnote() {
    openAppWithPopup(
        'https://www.remnote.com/', 
        'Remnote', 
        'width=800,height=600,resizable=yes,scrollbars=yes',
        'Remnote'
    );
}

function openDynalist() {
    openAppWithPopup(
        'https://dynalist.io/d/cnyrFPbIzRCFEUEtfbxvQh1h', 
        'Dynalist', 
        'width=800,height=600,resizable=yes,scrollbars=yes',
        'Dynalist'
    );
}
    
    // ========== PROJECT REVIEW FUNCTIONS ==========
    function openProjectReview() {
        // Update the project dropdown first
        updateProjectReviewDropdown();
        
        // Then update the review content
        updateProjectReview();
        
        // Open the modal
        document.getElementById('project-review-modal').classList.add('active');
    }
    
    function closeProjectReview() {
        document.getElementById('project-review-modal').classList.remove('active');
    }
    
    function updateProjectReviewDropdown() {
        const reviewProjectSelect = document.getElementById('review-project-select');
        if (!reviewProjectSelect) return;
        
        reviewProjectSelect.innerHTML = '<option value="all">All Projects</option>';
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            reviewProjectSelect.appendChild(option);
        });
        
        // Add change event listener
        reviewProjectSelect.addEventListener('change', updateProjectReview);
    }
    
    function updateProjectReview() {
        const reviewProjectSelect = document.getElementById('review-project-select');
        if (!reviewProjectSelect) return;
        
        const project = reviewProjectSelect.value;
        
        console.log('Updating project review for project:', project, 'Available projects:', projects);
        
        // Update stats
        updateReviewStats(project);
        
        // Update tasks
        updateReviewTasks(project);
        
        // Update notes
        updateReviewNotes(project);
        
        // Update ideas
        updateReviewIdeas(project);
        
        // Update history
        updateReviewHistory(project);
    }
    
    function updateReviewStats(project) {
        const reviewStats = document.getElementById('review-stats');
        if (!reviewStats) return;
        
        // Filter tasks based on project
        let filteredTasks = tasks;
        if (project !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.project === project);
        }
        
        // Calculate stats
        const totalTasks = filteredTasks.length;
        const completedTasks = filteredTasks.filter(task => task.completed).length;
        const workingTasks = filteredTasks.filter(task => task.status === 'working' && !task.completed).length;
        const backlogTasks = filteredTasks.filter(task => task.status === 'backlog' && !task.completed).length;
        
        reviewStats.innerHTML = `
            <div class="review-stat-card">
                <div class="review-stat-value">${totalTasks}</div>
                <div class="review-stat-label">Total Tasks</div>
            </div>
            <div class="review-stat-card">
                <div class="review-stat-value">${completedTasks}</div>
                <div class="review-stat-label">Completed</div>
            </div>
            <div class="review-stat-card">
                <div class="review-stat-value">${workingTasks}</div>
                <div class="review-stat-label">Working</div>
            </div>
            <div class="review-stat-card">
                <div class="review-stat-value">${backlogTasks}</div>
                <div class="review-stat-label">Backlog</div>
            </div>
        `;
    }
    
    function updateReviewTasks(project) {
        const reviewTaskList = document.getElementById('review-task-list');
        if (!reviewTaskList) return;
        
        // Filter tasks based on project
        let filteredTasks = tasks;
        if (project !== 'all') {
            filteredTasks = filteredTasks.filter(task => task.project === project);
        }
        
        // Show only incomplete tasks
        const incompleteTasks = filteredTasks.filter(task => !task.completed);
        
        if (incompleteTasks.length === 0) {
            reviewTaskList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>All tasks completed for this project!</p>
                </div>
            `;
            return;
        }
        
        reviewTaskList.innerHTML = '';
        
        // Sort by status: working first, then backlog
        const sortedTasks = [...incompleteTasks].sort((a, b) => {
            if (a.status === 'working' && b.status !== 'working') return -1;
            if (a.status !== 'working' && b.status === 'working') return 1;
            return 0;
        });
        
        sortedTasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = 'review-task-item';
            taskItem.setAttribute('data-task-id', task.id);
            
            // Format notes preview
            let notesPreview = '';
            if (task.notes) {
                const firstLine = task.notes.split('\n')[0].trim();
                if (firstLine) {
                    notesPreview = firstLine.length > 50 ? firstLine.substring(0, 50) + '...' : firstLine;
                }
            }
            
            taskItem.innerHTML = `
                <div class="review-task-name">${task.name}</div>
                <div class="review-task-details">
                    <span class="status-badge ${task.status === 'working' ? 'status-working' : 'status-backlog'}">
                        ${task.status === 'working' ? 'Working' : 'Backlog'}
                    </span>
                    ${notesPreview ? `<span style="margin-left: 10px; font-size: 0.85rem; color: var(--gray);">${notesPreview}</span>` : ''}
                </div>
            `;
            
            reviewTaskList.appendChild(taskItem);
        });
        
        // Add click event listeners to task items
        document.querySelectorAll('.review-task-item').forEach(item => {
            item.addEventListener('click', function() {
                // Toggle selection
                document.querySelectorAll('.review-task-item').forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
    }
    
    function updateReviewNotes(project) {
        const reviewNotesContent = document.getElementById('review-notes-content');
        if (!reviewNotesContent) return;
        
        // Get recent work notes from sessions
        const recentNotes = getRecentSessionsWithNotes(project);
        
        if (recentNotes.length === 0) {
            reviewNotesContent.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-sticky-note"></i>
                    <p>No recent work notes for this project</p>
                </div>
            `;
            return;
        }
        
        let notesHtml = '';
        recentNotes.forEach(session => {
            const date = new Date(session.startTime);
            const dateStr = date.toLocaleDateString();
            
            notesHtml += `
                <div class="review-history-item">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">
                        ${dateStr} - ${Math.floor(session.duration / 60)} min
                    </div>
                    <div style="font-size: 0.9rem; color: var(--dark);">
                        ${formatNotesForDisplay(session.workNotes || 'No notes')}
                    </div>
                </div>
            `;
        });
        
        reviewNotesContent.innerHTML = notesHtml;
    }
    
    function getRecentSessionsWithNotes(project) {
        let filteredSessions = sessions;
        if (project !== 'all') {
            filteredSessions = filteredSessions.filter(session => session.project === project);
        }
        
        // Get sessions with work notes
        const sessionsWithNotes = filteredSessions.filter(session => 
            session.workNotes && session.workNotes.trim() !== ''
        );
        
        // Sort by date (newest first) and take the 5 most recent
        return [...sessionsWithNotes]
            .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
            .slice(0, 5);
    }
    
    function isWorkNotesRecent(session) {
        if (!session.workNotes) return false;
        
        const sessionDate = new Date(session.startTime);
        const now = new Date();
        const daysDiff = (now - sessionDate) / (1000 * 60 * 60 * 24);
        
        return daysDiff <= 7; // Within the last 7 days
    }
    
    function formatNotesForDisplay(notes) {
        if (!notes) return 'No notes';
        
        // Simple formatting: convert newlines to <br>
        return notes.replace(/\n/g, '<br>');
    }
    
    function updateReviewIdeas(project) {
        const reviewIdeasList = document.getElementById('review-ideas-list');
        if (!reviewIdeasList) return;
        
        // Get ideas from recent sessions
        let filteredSessions = sessions;
        if (project !== 'all') {
            filteredSessions = filteredSessions.filter(session => session.project === project);
        }
        
        // Collect all ideas from sessions
        const allIdeas = [];
        filteredSessions.forEach(session => {
            if (session.ideas && session.ideas.length > 0) {
                session.ideas.forEach(idea => {
                    allIdeas.push({
                        content: idea.content || idea,
                        date: session.startTime
                    });
                });
            }
        });
        
        // Also add current ideas
        if (ideas.length > 0) {
            ideas.forEach(idea => {
                allIdeas.push({
                    content: idea.content,
                    date: idea.createdAt
                });
            });
        }
        
        if (allIdeas.length === 0) {
            reviewIdeasList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-lightbulb"></i>
                    <p>No ideas recorded for this project</p>
                </div>
            `;
            return;
        }
        
        // Sort by date (newest first) and take the 10 most recent
        const recentIdeas = [...allIdeas]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 10);
        
        let ideasHtml = '';
        recentIdeas.forEach(idea => {
            const date = new Date(idea.date);
            const dateStr = date.toLocaleDateString();
            
            ideasHtml += `
                <div class="review-history-item">
                    <div style="font-weight: 600; color: var(--success); margin-bottom: 5px;">
                        ${dateStr}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--dark);">
                        ${idea.content}
                    </div>
                </div>
            `;
        });
        
        reviewIdeasList.innerHTML = ideasHtml;
    }
    
    function updateReviewHistory(project) {
        const reviewHistoryList = document.getElementById('review-history-list');
        if (!reviewHistoryList) return;
        
        let filteredSessions = sessions;
        if (project !== 'all') {
            filteredSessions = filteredSessions.filter(session => session.project === project);
        }
        
        // Sort by date (newest first) and take the 10 most recent
        const recentSessions = [...filteredSessions]
            .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
            .slice(0, 10);
        
        if (recentSessions.length === 0) {
            reviewHistoryList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>No session history for this project</p>
                </div>
            `;
            return;
        }
        
        let historyHtml = '';
        recentSessions.forEach(session => {
            const date = new Date(session.startTime);
            const dateStr = date.toLocaleDateString();
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const duration = Math.floor(session.duration / 60);
            
            // Count completed tasks
            const completedTasks = session.tasks ? session.tasks.filter(t => t.completed).length : 0;
            const totalTasks = session.tasks ? session.tasks.length : 0;
            
            historyHtml += `
                <div class="review-history-item">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">
                        ${dateStr} ${timeStr} - ${duration} min
                    </div>
                    <div style="font-size: 0.9rem; color: var(--dark);">
                        ${completedTasks}/${totalTasks} tasks completed
                        ${session.workNotes ? '<br><i class="fas fa-sticky-note" style="color: var(--warning);"></i> Has notes' : ''}
                        ${session.ideas && session.ideas.length > 0 ? '<br><i class="fas fa-lightbulb" style="color: var(--success);"></i> Has ideas' : ''}
                    </div>
                </div>
            `;
        });
        
        reviewHistoryList.innerHTML = historyHtml;
    }
    
    function getStatusColor(status) {
        switch(status) {
            case 'working': return 'var(--warning)';
            case 'completed': return 'var(--success)';
            case 'backlog': return 'var(--gray)';
            default: return 'var(--primary)';
        }
    }
    
    function switchReviewTab(tabId) {
        // Update tabs
        document.querySelectorAll('.review-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.getAttribute('data-review-tab') === tabId) {
                tab.classList.add('active');
            }
        });
        
        // Update tab content
        document.querySelectorAll('.review-tab-content').forEach(content => {
            content.style.display = 'none';
            if (content.id === `review-${tabId}`) {
                content.style.display = 'block';
            }
        });
    }
    
    function continueSelectedTask() {
        const selectedTask = document.querySelector('.review-task-item.selected');
        if (!selectedTask) {
            showTemporaryMessage('Please select a task first', 'warning');
            return;
        }
        
        const taskId = parseInt(selectedTask.getAttribute('data-task-id'));
        const task = tasks.find(t => t.id === taskId);
        
        if (task) {
            // Set as focus task
            setFocusTask(taskId);
            
            // Switch to the task's project if not already
            if (workProjectSelect.value.replace('Project: ', '') !== task.project) {
                workProjectSelect.value = `Project: ${task.project}`;
                updateWorkTaskList();
                updateWorkTaskDropdown();
            }
            
            // Close the modal and switch to work mode
            closeProjectReview();
            switchWorkTab('work-tasks');
            
            showTemporaryMessage(`Continuing with task: ${task.name}`, 'success');
        }
    }
    
    function startNewSession() {
        // Get selected project
        const project = document.getElementById('review-project-select').value;
        
        // Set project in work mode
        if (project !== 'all') {
            workProjectSelect.value = `Project: ${project}`;
            updateWorkTaskList();
            updateWorkTaskDropdown();
        }
        
        // Close the modal and switch to work mode
        closeProjectReview();
        switchWorkTab('work-tasks');
        
        // Start timer if not running
        if (!isRunning) {
            startTimer();
        }
        
        showTemporaryMessage(`Started new session for project: ${project}`, 'success');
    }
    
    function copyReviewToClipboard() {
        const project = document.getElementById('review-project-select').value;
        const projectName = project === 'all' ? 'All Projects' : project;
        
        // Collect review data
        let reviewText = `FlowFocus Project Review - ${projectName}\n`;
        reviewText += `Generated on: ${new Date().toLocaleString()}\n`;
        reviewText += '='.repeat(50) + '\n\n';
        
        // Add stats
        const statsDiv = document.getElementById('review-stats');
        if (statsDiv) {
            const statCards = statsDiv.querySelectorAll('.review-stat-card');
            reviewText += 'QUICK STATS:\n';
            statCards.forEach(card => {
                const value = card.querySelector('.review-stat-value').textContent;
                const label = card.querySelector('.review-stat-label').textContent;
                reviewText += `  ${label}: ${value}\n`;
            });
            reviewText += '\n';
        }
        
        // Add tasks
        reviewText += 'CURRENT TASKS:\n';
        const taskItems = document.querySelectorAll('.review-task-item');
        if (taskItems.length > 0) {
            taskItems.forEach((item, index) => {
                const name = item.querySelector('.review-task-name').textContent;
                const statusBadge = item.querySelector('.status-badge');
                const status = statusBadge ? statusBadge.textContent : 'Unknown';
                reviewText += `  ${index + 1}. ${name} [${status}]\n`;
            });
        } else {
            reviewText += '  No incomplete tasks\n';
        }
        
        reviewText += '\n' + '='.repeat(50) + '\n';
        
        // Copy to clipboard
        navigator.clipboard.writeText(reviewText).then(() => {
            showTemporaryMessage('Project review copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showTemporaryMessage('Failed to copy to clipboard', 'warning');
        });
    }
    
    function setupProjectReviewEventListeners() {
        // Review tabs
        document.querySelectorAll('.review-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabId = e.target.getAttribute('data-review-tab');
                switchReviewTab(tabId);
            });
        });
        
        // Project selection change
        const reviewProjectSelect = document.getElementById('review-project-select');
        if (reviewProjectSelect) {
            reviewProjectSelect.addEventListener('change', updateProjectReview);
        }
        
        // Quick action buttons
        const continueSelectedTaskBtn = document.getElementById('continue-selected-task');
        const startNewSessionBtn = document.getElementById('start-new-session');
        const copyReviewToClipboardBtn = document.getElementById('copy-review-to-clipboard');
        const closeProjectReviewBtn = document.getElementById('close-project-review');
        
        if (continueSelectedTaskBtn) {
            continueSelectedTaskBtn.addEventListener('click', continueSelectedTask);
        }
        
        if (startNewSessionBtn) {
            startNewSessionBtn.addEventListener('click', startNewSession);
        }
        
        if (copyReviewToClipboardBtn) {
            copyReviewToClipboardBtn.addEventListener('click', copyReviewToClipboard);
        }
        
        if (closeProjectReviewBtn) {
            closeProjectReviewBtn.addEventListener('click', closeProjectReview);
        }
        
        // Close modal when clicking outside
        const projectReviewModal = document.getElementById('project-review-modal');
        if (projectReviewModal) {
            projectReviewModal.addEventListener('click', (e) => {
                if (e.target === projectReviewModal) {
                    closeProjectReview();
                }
            });
        }
        
        // Close modal button
        const closeProjectReviewModalBtn = document.getElementById('close-project-review-modal');
        if (closeProjectReviewModalBtn) {
            closeProjectReviewModalBtn.addEventListener('click', closeProjectReview);
        }
    }
    
    // Alias functions for backward compatibility
    function continueSelectedTaskFunc() { continueSelectedTask(); }
    function startNewSessionFunc() { startNewSession(); }
    function copyReviewToClipboardFunc() { copyReviewToClipboard(); }
    
    // ========== INITIALIZE THE APP ==========
    init();
</script>
</body>
</html>